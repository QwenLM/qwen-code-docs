# チェックポイント機能

Qwen Code には、AI搭載ツールによるファイル変更が行われる前に、プロジェクトの状態を自動的にスナップショットとして保存するチェックポイント機能が含まれています。これにより、コード変更を安全に試したり適用したりでき、ツール実行前の状態に即座に戻すことができるため安心です。

## 仕組み

ファイルシステムを変更するツール（`write_file` や `edit` など）を承認すると、CLI は自動的に「チェックポイント」を作成します。このチェックポイントには以下が含まれます：

1.  **Git スナップショット：** ホームディレクトリ（`~/.qwen/history/<project_hash>`）にある特別なシャドウ Git リポジトリにコミットが作成されます。このスナップショットは、その時点でのプロジェクトファイルの完全な状態をキャプチャします。これはユーザー自身のプロジェクトの Git リポジトリとは**干渉しません**。
2.  **会話履歴：** その時点でエージェントとやり取りしたすべての会話が保存されます。
3.  **ツール呼び出し：** 実行されようとしていた特定のツール呼び出しも保存されます。

変更を元に戻したい場合や、単に以前の状態に戻りたい場合は、`/restore` コマンドを使用できます。チェックポイントを復元すると以下の処理が行われます：

- プロジェクト内のすべてのファイルが、スナップショットでキャプチャされた状態に戻ります。
- CLI 内の会話履歴が復元されます。
- 元のツール呼び出しが再提案され、再度実行したり、修正したり、無視したりできるようになります。

Git スナップショットおよび会話履歴を含むすべてのチェックポイントデータは、ローカルマシン上に保存されます。Git スナップショットはシャドウリポジトリ内に保存され、会話履歴とツール呼び出しはプロジェクトの一時ディレクトリ（通常は `~/.qwen/tmp/<project_hash>/checkpoints`）にある JSON ファイルに保存されます。

## 機能の有効化

チェックポイント機能はデフォルトで無効になっています。有効にするには、コマンドラインフラグを使用するか、`settings.json` ファイルを編集します。

### コマンドラインフラグを使用する

Qwen Code を起動する際に `--checkpointing` フラグを使用することで、現在のセッションに対してチェックポイントを有効にできます：

```bash
qwen --checkpointing
```

### `settings.json` ファイルを使用する

すべてのセッションでデフォルトでチェックポイントを有効にするには、`settings.json` ファイルを編集する必要があります。

以下のキーを `settings.json` に追加してください：

```json
{
  "general": {
    "checkpointing": {
      "enabled": true
    }
  }
}
```

## `/restore` コマンドの使用

有効にすると、チェックポイントは自動的に作成されます。これらを管理するには、`/restore` コマンドを使用します。

### 利用可能なチェックポイントの一覧表示

現在のプロジェクトで保存されたすべてのチェックポイントを確認するには、以下を実行してください：

```
/restore
```

CLI は利用可能なチェックポイントファイルの一覧を表示します。これらのファイル名は通常、タイムスタンプ、変更されたファイルの名前、実行予定だったツールの名前から構成されます（例：`2025-06-22T10-00-00_000Z-my-file.txt-write_file`）。

### 特定のチェックポイントを復元する

プロジェクトを特定のチェックポイントに戻すには、一覧から該当するチェックポイントファイルを使用します：

```
/restore <checkpoint_file>
```

例：

```
/restore 2025-06-22T10-00-00_000Z-my-file.txt-write_file
```

コマンドを実行すると、ファイルと会話内容がそのチェックポイントが作成された時点の状態に即座に復元され、元のツールプロンプトが再表示されます。