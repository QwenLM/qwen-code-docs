# Qwen Code Companion プラグイン：インターフェース仕様

> 最終更新日：2025年9月15日

このドキュメントは、Qwen Code の IDE モードを有効にするためのコンパニオンプラグインを構築するための契約を定義します。VS Code では、これらの機能（ネイティブな差分表示、コンテキスト認識）が公式拡張機能（[マーケットプレイス](https://marketplace.visualstudio.com/items?itemName=qwenlm.qwen-code-vscode-ide-companion)）によって提供されます。この仕様は、JetBrains IDE や Sublime Text などの他のエディタに同様の機能を提供したいコントリビューター向けです。

## I. 通信インターフェース

Qwen Code と IDE プラグインは、ローカル通信チャネルを通じて通信します。

### 1. トランスポート層: HTTP 上の MCP

プラグインは **Model Context Protocol (MCP)** を実装するローカル HTTP サーバーを実行**しなければなりません**。

- **プロトコル:** サーバーは有効な MCP サーバーである必要があります。可能であれば、選択した言語用の既存の MCP SDK の使用を推奨します。
- **エンドポイント:** サーバーはすべての MCP 通信のために単一のエンドポイント（例: `/mcp`）を公開する必要があります。
- **ポート:** サーバーは動的に割り当てられたポート（つまり、ポート `0`）でリッスン**しなければなりません**。

### 2. 検出メカニズム：ポートファイル

Qwen Code が接続するには、実行中の IDE インスタンスと使用しているサーバーポートを検出する必要があります。プラグインは「検出ファイル」を作成することでこの処理を**必ず**サポートしなければなりません。

- **CLI によるファイルの検索方法：** CLI はプロセスツリーを走査して、実行中の IDE のプロセス ID（PID）を特定します。次に、その PID をファイル名に含む検出ファイルを探します。
- **ファイルの場所：** ファイルは特定のディレクトリに作成する必要があります：`os.tmpdir()/qwen/ide/`。このディレクトリが存在しない場合は、プラグインが作成する必要があります。
- **ファイル名の命名規則：** ファイル名は非常に重要で、以下のパターンに**必ず**従う必要があります：
  `qwen-code-ide-server-${PID}-${PORT}.json`
  - `${PID}`：親 IDE プロセスのプロセス ID。プラグインはこの PID を特定し、ファイル名に含める必要があります。
  - `${PORT}`：MCP サーバーがリッスンしているポート。
- **ファイル内容とワークスペースの検証：** ファイルには以下の構造を持つ JSON オブジェクトが**必ず**含まれていなければなりません：

  ```json
  {
    "port": 12345,
    "workspacePath": "/path/to/project1:/path/to/project2",
    "authToken": "a-very-secret-token",
    "ideInfo": {
      "name": "vscode",
      "displayName": "VS Code"
    }
  }
  ```
  - `port`（数値、必須）：MCP サーバーのポート。
  - `workspacePath`（文字列、必須）：開いているすべてのワークスペースルートパスのリストで、OS 固有のパス区切り文字（Linux/macOS では `:`、Windows では `;`）で区切られます。CLI はこのパスを使用して、自身が IDE で開かれているプロジェクトフォルダと同じフォルダで実行されていることを確認します。CLI の現在の作業ディレクトリが `workspacePath` のサブディレクトリではない場合、接続は拒否されます。プラグインは、開いているワークスペースのルートへの正しい絶対パスを**必ず**提供する必要があります。
  - `authToken`（文字列、必須）：接続を保護するためのシークレットトークン。CLI はすべてのリクエストにおいて、このトークンを `Authorization: Bearer <token>` ヘッダーに含めます。
  - `ideInfo`（オブジェクト、必須）：IDE に関する情報。
    - `name`（文字列、必須）：IDE の短くて小文字の識別子（例：`vscode`、`jetbrains`）。
    - `displayName`（文字列、必須）：ユーザーに分かりやすい IDE の名前（例：`VS Code`、`JetBrains IDE`）。

- **認証：** 接続を保護するために、プラグインは一意でシークレットなトークンを生成し、それを検出ファイルに含める**必要があります**。CLI はその後、MCP サーバーへのすべてのリクエストにおいて、このトークンを `Authorization` ヘッダーに含めます（例：`Authorization: Bearer a-very-secret-token`）。サーバーはすべてのリクエストでこのトークンを検証し、不正なリクエストは拒否**しなければなりません**。
- **環境変数による優先判定（推奨）：** 最も信頼性の高い動作を実現するために、プラグインは検出ファイルの作成に加えて、統合ターミナル内で `QWEN_CODE_IDE_SERVER_PORT` 環境変数を設定**すべきです**。ファイルは主な検出メカニズムとして機能しますが、環境変数は同点時の判定に不可欠です。ユーザーが同じワークスペースに対して複数の IDE ウィンドウを開いている場合、CLI は `QWEN_CODE_IDE_SERVER_PORT` 変数を使用して、正しいウィンドウのサーバーを識別・接続します。

## II. コンテキストインターフェース

コンテキスト認識を有効にするために、プラグインは CLI に IDE でのユーザーのアクティビティに関するリアルタイム情報を提供**してもよい**。

### `ide/contextUpdate` 通知

ユーザーのコンテキストが変更されるたびに、プラグインは CLI に `ide/contextUpdate` [通知](https://modelcontextprotocol.io/specification/2025-06-18/basic/index#notifications)を送信**してもよい**。

- **トリガーイベント:** この通知は以下の場合に送信する必要があります（推奨デバウンス時間：50ms）：
  - ファイルが開かれた、閉じられた、またはフォーカスされたとき。
  - アクティブなファイルでユーザーのカーソル位置またはテキスト選択範囲が変更されたとき。
- **ペイロード（`IdeContext`）:** 通知のパラメータは `IdeContext` オブジェクトで**なければなりません**：

  ```typescript
  interface IdeContext {
    workspaceState?: {
      openFiles?: File[];
      isTrusted?: boolean;
    };
  }

  interface File {
    // ファイルへの絶対パス
    path: string;
    // 最後にフォーカスされた Unix タイムスタンプ（順序付け用）
    timestamp: number;
    // 現在フォーカスされているファイルであれば true
    isActive?: boolean;
    cursor?: {
      // 1 から始まる行番号
      line: number;
      // 1 から始まる文字番号
      character: number;
    };
    // ユーザーが現在選択しているテキスト
    selectedText?: string;
  }
  ```

  **注:** `openFiles` のリストには、ディスク上に存在するファイルのみを含める必要があります。仮想ファイル（例：パスを持たない未保存ファイルやエディタ設定ページなど）は**除外しなければなりません**。

### CLI がこのコンテキストを使用する方法

`IdeContext` オブジェクトを受け取った後、CLI は情報をモデルに送信する前に、いくつかの正規化および切り捨て処理を実行します。

- **ファイルの順序:** CLI は `timestamp` フィールドを使用して、最も最近使用されたファイルを判断します。この値に基づいて `openFiles` リストをソートします。したがって、プラグインはファイルが最後にフォーカスされた時刻の正確な Unix タイムスタンプを**必ず**提供する必要があります。
- **アクティブファイル:** CLI は（ソート後の）最新のファイルのみを「アクティブ」ファイルと見なします。他のすべてのファイルの `isActive` フラグは無視され、それらの `cursor` および `selectedText` フィールドはクリアされます。プラグインは、現在フォーカスされているファイルに対してのみ `isActive: true` を設定し、カーソル／選択範囲の詳細を提供することに集中すべきです。
- **切り捨て:** トークン数の制限に対処するため、CLI はファイルリスト（10ファイルまで）と `selectedText`（16KBまで）の両方を切り捨てます。

CLI が最終的な切り捨てを処理しますが、プラグインも送信するコンテキストの量を制限することを強く推奨します。

## III. 差分インターフェース

インタラクティブなコード変更を可能にするために、プラグインは差分インターフェースを公開する**こともできます**。これにより、CLIがIDEにファイルへの提案された変更を表示する差分ビューを開くよう要求できるようになります。ユーザーはその後、IDE内でこれらの変更を直接確認、編集、そして最終的に受け入れるか拒否するかを決定できます。

### `openDiff` ツール

プラグインは、その MCP サーバー上で `openDiff` ツールを登録する**必要があります**。

- **説明:** このツールは、特定のファイルに対して変更可能な差分ビューを開くよう IDE に指示します。
- **リクエスト (`OpenDiffRequest`):** このツールは `tools/call` リクエストを通じて呼び出されます。リクエスト内の `params` の `arguments` フィールドは、**必ず** `OpenDiffRequest` オブジェクトである必要があります。

  ```typescript
  interface OpenDiffRequest {
    // 差分表示対象のファイルへの絶対パス
    filePath: string;
    // ファイルに対する提案された新しい内容
    newContent: string;
  }
  ```

- **レスポンス (`CallToolResult`):** ツールは、リクエストを受け取ったことを確認し、差分ビューが正常に開かれたかどうかを報告するために、直ちに `CallToolResult` を返す**必要があります**。
  - 成功時: 差分ビューが正常に開かれた場合、レスポンスには空のコンテンツ（つまり `content: []`）を含める**必要があります**。
  - 失敗時: エラーにより差分ビューが開けなかった場合、レスポンスには `isError: true` を設定し、`content` 配列内にエラー内容を記述した `TextContent` ブロックを含める**必要があります**。

  実際の差分の結果（受け入れまたは拒否）については、非同期通知を通じて伝えられます。

### `closeDiff` ツール

プラグインは、その MCP サーバーに `closeDiff` ツールを登録する**必要があります**。

- **説明:** このツールは、特定のファイルに対して開かれている差分ビューを IDE に閉じるよう指示します。
- **リクエスト (`CloseDiffRequest`):** このツールは `tools/call` リクエストを通じて呼び出されます。リクエストの `params` 内にある `arguments` フィールドは、`CloseDiffRequest` オブジェクトで**なければなりません**。

  ```typescript
  interface CloseDiffRequest {
    // 差分ビューを閉じるべきファイルの絶対パス。
    filePath: string;
  }
  ```

- **レスポンス (`CallToolResult`):** このツールは `CallToolResult` を返す**必要があります**。
  - 成功時: 差分ビューが正常に閉じられた場合、レスポンスにはコンテンツ配列内に **TextContent** ブロックが一つ含まれていなければならず、その内容は閉じる前のファイルの最終的な内容である必要があります。
  - 失敗時: エラーにより差分ビューを閉じることができなかった場合、レスポンスには `isError: true` が設定され、`content` 配列内にエラー内容を記述した `TextContent` ブロックが含まれていなければなりません。

### `ide/diffAccepted` 通知

ユーザーが差分ビューでの変更を承認した場合（例：「適用」や「保存」ボタンをクリック）、プラグインは CLI に `ide/diffAccepted` 通知を**必ず**送信する必要があります。

- **ペイロード:** 通知のパラメータには、ファイルパスとそのファイルの最終的な内容を**必ず**含める必要があります。ユーザーが差分ビューで手動編集を行った場合、内容は元の `newContent` と異なる可能性があります。

  ```typescript
  {
    // 差分表示されたファイルの絶対パス。
    filePath: string;
    // 承認後のファイルの完全な内容。
    content: string;
  }
  ```

### `ide/diffRejected` 通知

ユーザーが変更を拒否した場合（例：承認せずに差分ビューを閉じた場合）、プラグインは CLI に `ide/diffRejected` 通知を**必ず**送信する必要があります。

- **ペイロード:** 通知のパラメータには、拒否された差分のファイルパスを**必ず**含める必要があります。

  ```typescript
  {
    // 差分表示されたファイルの絶対パス。
    filePath: string;
  }
  ```

## IV. ライフサイクルインターフェース

プラグインは、IDE のライフサイクルに応じて、リソースと検出ファイルを正しく管理する**必要があります**。

- **アクティブ時（IDE 起動時／プラグイン有効時）：**
  1. MCP サーバーを起動します。
  2. 検出ファイルを作成します。
- **非アクティブ時（IDE 終了時／プラグイン無効時）：**
  1. MCP サーバーを停止します。
  2. 検出ファイルを削除します。