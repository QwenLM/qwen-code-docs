# Qwen Code Companion プラグイン: インターフェース仕様

> 最終更新日: 2025年9月15日

このドキュメントでは、Qwen Code の IDE モードを有効にするためのコンパニオンプラグイン構築のための契約を定義しています。VS Code では、これらの機能（ネイティブな差分表示、コンテキスト認識）は公式拡張機能によって提供されます（[マーケットプレイス](https://marketplace.visualstudio.com/items?itemName=qwenlm.qwen-code-vscode-ide-companion)）。この仕様は、JetBrains IDE や Sublime Text などの他のエディタに同様の機能を提供したい貢献者向けです。

## I. 通信インターフェース

Qwen Code と IDE プラグインは、ローカル通信チャネルを通じて通信します。

### 1. トランスポート層: HTTP 上の MCP

プラグインは、**Model Context Protocol (MCP)** を実装するローカル HTTP サーバーを**必ず**実行する必要があります。

- **プロトコル:** サーバーは有効な MCP サーバーでなければなりません。利用可能な場合は、選択した言語用の既存 MCP SDK の使用を推奨します。
- **エンドポイント:** サーバーは、すべての MCP 通信用に単一のエンドポイント (例: `/mcp`) を公開する必要があります。
- **ポート:** サーバーは、動的に割り当てられたポート (つまり、ポート `0` でリッスン) でリッスンする**必要があります**。

### 2. 検出メカニズム: ロックファイル

Qwen Code が接続するには、サーバーが使用しているポートを検出する必要があります。プラグインは「ロックファイル」を作成し、ポートの環境変数を設定することで、これを**必ず**実現する必要があります。

- **CLI がファイルを見つける方法:** CLI は `QWEN_CODE_IDE_SERVER_PORT` からポートを読み取り、次に `~/.qwen/ide/<PORT>.lock` を読み取ります。（古い拡張機能のためのレガシーなフォールバックが存在します。下記の注釈を参照してください。）
- **ファイルの場所:** ファイルは特定のディレクトリ `~/.qwen/ide/` に作成する必要があります。プラグインは、このディレクトリが存在しない場合に作成する必要があります。
- **ファイル名の命名規則:** ファイル名は重要であり、**必ず**以下のパターンに従う必要があります:
  `<PORT>.lock`
  - `<PORT>`: MCP サーバーがリッスンしているポート。
- **ファイルの内容とワークスペースの検証:** ファイルには、以下の構造を持つ JSON オブジェクトが**必ず**含まれている必要があります:

  ```json
  {
    "port": 12345,
    "workspacePath": "/path/to/project1:/path/to/project2",
    "authToken": "a-very-secret-token",
    "ppid": 1234,
    "ideName": "VS Code"
  }
  ```
  - `port`（数値、必須）: MCP サーバーのポート。
  - `workspacePath`（文字列、必須）: OS 固有のパス区切り文字（Linux/macOS では `:`、Windows では `;`）で区切られた、開いているすべてのワークスペースルートパスのリスト。CLI はこのパスを使用して、IDE で開いているプロジェクトフォルダーと同じフォルダーで実行されていることを確認します。CLI の現在の作業ディレクトリが `workspacePath` のサブディレクトリでない場合、接続は拒否されます。プラグインは、開いているワークスペースのルートへの正しい絶対パスを**必ず**提供する必要があります。
  - `authToken`（文字列、必須）: 接続を保護するためのシークレットトークン。CLI はすべてのリクエストで `Authorization: Bearer <token>` ヘッダーにこのトークンを含めます。
  - `ppid`（数値、必須）: IDE プロセスの親プロセス ID。
  - `ideName`（文字列、必須）: IDE のユーザーフレンドリーな名前（例: `VS Code`、`JetBrains IDE`）。

- **認証:** 接続を保護するために、プラグインは一意のシークレットトークンを生成し、検出ファイルに含める**必要があります**。CLI は、このトークンを MCP サーバーへのすべてのリクエストの `Authorization` ヘッダーに含めます（例: `Authorization: Bearer a-very-secret-token`）。サーバーはすべてのリクエストでこのトークンを検証し、認証されていないリクエストを拒否する**必要があります**。
- **環境変数（必須）:** プラグインは統合ターミナルで `QWEN_CODE_IDE_SERVER_PORT` を設定する**必要があります**。これにより、CLI が正しい `<PORT>.lock` ファイルを見つけることができます。

**レガシーに関する注意:** v0.5.1 よりも古い拡張機能では、Qwen Code は `qwen-code-ide-server-<PID>.json` または `qwen-code-ide-server-<PORT>.json` という名前のシステム一時ディレクトリ内の JSON ファイルを読み込むようにフォールバックする場合があります。新しい統合では、これらのレガシーファイルに依存すべきではありません。

## II. コンテキストインターフェース

コンテキスト認識を有効にするために、プラグインはIDEでのユーザーのアクティビティに関するリアルタイム情報をCLIに提供することが**あります**。

### `ide/contextUpdate` 通知

プラグインは、ユーザーのコンテキストが変更されるたびに、CLI に対して `ide/contextUpdate` [通知](https://modelcontextprotocol.io/specification/2025-06-18/basic/index#notifications) を送信する**可能性があります**。

- **トリガーイベント:** 次の場合に (推奨されるデバウンス時間 50ms で) この通知を送信する必要があります:
  - ファイルが開かれた、閉じられた、またはフォーカスされたとき。
  - アクティブなファイル内でユーザーのカーソル位置またはテキスト選択が変更されたとき。
- **ペイロード (`IdeContext`):** 通知パラメータは `IdeContext` オブジェクトでなければなりません:

  ```typescript
  interface IdeContext {
    workspaceState?: {
      openFiles?: File[];
      isTrusted?: boolean;
    };
  }

  interface File {
    // ファイルへの絶対パス
    path: string;
    // 最後にフォーカスされた Unix タイムスタンプ (並び替え用)
    timestamp: number;
    // 現在フォーカスされているファイルの場合は true
    isActive?: boolean;
    cursor?: {
      // 1 から始まる行番号
      line: number;
      // 1 から始まる文字番号
      character: number;
    };
    // ユーザーが現在選択しているテキスト
    selectedText?: string;
  }
  ```

  **注意:** `openFiles` リストには、ディスク上に存在するファイルのみを含める必要があります。仮想ファイル (例: パスを持たない未保存のファイル、エディタ設定ページなど) は除外する**必要があります**。

### CLIがこのコンテキストを使用する方法

CLIは`IdeContext`オブジェクトを受け取った後、情報をモデルに送信する前にいくつかの正規化および切り詰め処理を実行します。

- **ファイルの順序付け:** CLIは`timestamp`フィールドを使用して最も最近使用されたファイルを特定します。`openFiles`リストはこの値に基づいてソートされます。したがって、プラグインはファイルが最後にフォーカスされた正確なUnixタイムスタンプを**必ず**提供する必要があります。
- **アクティブファイル:** CLIは（ソート後の）最も最近のファイルのみを「アクティブ」ファイルとして考慮します。他のすべてのファイルの`isActive`フラグは無視され、それらの`cursor`および`selectedText`フィールドはクリアされます。プラグインは現在フォーカスされているファイルに対してのみ`isActive: true`を設定し、カーソル/選択範囲の詳細を提供するようにしてください。
- **切り詰め:** トークン制限を管理するため、CLIはファイルリスト（10ファイルに）と`selectedText`（16KBに）の両方を切り詰めます。

CLIが最終的な切り詰め処理を行う一方で、プラグイン側でも送信するコンテキスト量を制限することを強く推奨します。

## III. ディフインターフェース

対話的なコード変更を可能にするために、プラグインは**ディフインターフェースを公開してもかまいません（MAY）**。これにより、CLI は IDE に対してファイルへの提案された変更を表示するディフビューを開くよう要求できるようになります。ユーザーは、これらの変更をレビューし、編集し、最終的に IDE 内で直接承認または拒否できます。

### `openDiff` ツール

プラグインはそのMCPサーバー上で `openDiff` ツールを**登録しなければなりません**。

- **説明:** このツールは、IDEに対して特定のファイルの編集可能な差分ビューを開くよう指示します。
- **リクエスト (`OpenDiffRequest`):** ツールは `tools/call` リクエスト経由で呼び出されます。リクエストの `params` 内の `arguments` フィールドは**`OpenDiffRequest` オブジェクトでなければなりません**。

  ```typescript
  interface OpenDiffRequest {
    // 差分を表示するファイルへの絶対パス。
    filePath: string;
    // ファイルに対する提案された新しいコンテンツ。
    newContent: string;
  }
  ```

- **レスポンス (`CallToolResult`):** ツールはリクエストを確認し、差分ビューが正常に開かれたかどうかを報告するために、即座に `CallToolResult` を返さなければなりません。
  - 成功時: 差分ビューが正常に開かれた場合、レスポンスは空のコンテンツを含まなければなりません（つまり、`content: []`）。
  - 失敗時: エラーにより差分ビューを開けなかった場合、レスポンスは `isError: true` を持ち、`content` 配列内にエラーを説明する `TextContent` ブロックを含まなければなりません。

  差分の実際の結果（承認または拒否）は、通知を通じて非同期に伝えられます。

### `closeDiff` ツール

プラグインはそのMCPサーバー上で `closeDiff` ツールを**登録しなければなりません**。

- **説明:** このツールは、特定のファイルに対する開いている差分ビューをIDEに閉じるよう指示します。
- **リクエスト (`CloseDiffRequest`):** ツールは `tools/call` リクエスト経由で呼び出されます。リクエストの `params` 内の `arguments` フィールドは `CloseDiffRequest` オブジェクトで**なければなりません**。

  ```typescript
  interface CloseDiffRequest {
    // 差分ビューを閉じる対象のファイルへの絶対パス。
    filePath: string;
  }
  ```

- **レスポンス (`CallToolResult`):** ツールは `CallToolResult` を**返さなければなりません**。
  - 成功時: 差分ビューが正常に閉じられた場合、レスポンスはコンテンツ配列にファイルの閉じる前の最終内容を含む単一の**TextContent**ブロックを含まなければなりません。
  - 失敗時: エラーにより差分ビューを閉じることができなかった場合、レスポンスは `isError: true` を持ち、`content` 配列にエラーを説明する `TextContent` ブロックを含まなければなりません。

### `ide/diffAccepted` 通知

ユーザーが差分ビューの変更を承認した場合（例：「適用」または「保存」ボタンをクリックした場合）、プラグインは CLI に `ide/diffAccepted` 通知を**送信しなければなりません**。

- **ペイロード:** 通知パラメータにはファイルパスとファイルの最終的な内容を**含めなければなりません**。ユーザーが差分ビューで手動で編集を行った場合、内容は元の `newContent` と異なる可能性があります。

  ```typescript
  {
    // 差分が表示されたファイルへの絶対パス。
    filePath: string;
    // 承認後のファイルの完全な内容。
    content: string;
  }
  ```

### `ide/diffRejected` 通知

ユーザーが変更を拒否した場合（例：承認せずに差分ビューを閉じた場合）、プラグインは CLI に `ide/diffRejected` 通知を**送信しなければなりません**。

- **ペイロード:** 通知パラメータには拒否された差分のファイルパスを**含めなければなりません**。

  ```typescript
  {
    // 差分が表示されたファイルへの絶対パス。
    filePath: string;
  }
  ```

## IV. ライフサイクルインターフェース

プラグインは、IDE のライフサイクルに従って、リソースとディスカバリファイルを正しく管理**しなければなりません**。

- **アクティブ化時 (IDE 起動時/プラグイン有効化時):**
  1.  MCP サーバーを起動する。
  2.  ディスカバリファイルを作成する。
- **非アクティブ化時 (IDE シャットダウン時/プラグイン無効化時):**
  1.  MCP サーバーを停止する。
  2.  ディスカバリファイルを削除する。