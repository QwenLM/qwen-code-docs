# IDE 連携

Qwen Code は、よりシームレスでコンテキストを意識した体験を提供するために、お使いの IDE と連携できます。この連携により、CLI がワークスペースをより適切に理解できるようになり、エディタ内での差分表示といった強力な機能が利用可能になります。

現在サポートされている IDE は [Visual Studio Code](https://code.visualstudio.com/) および VS Code 拡張機能に対応する他のエディタのみです。他のエディタへの対応を構築するには、[IDE コンパニオン拡張仕様](../users/ide-integration/ide-companion-spec) を参照してください。

## 機能

- **ワークスペースコンテキスト:** CLIは自動的にワークスペースの状況を把握し、より関連性が高く正確な応答を提供します。このコンテキストには以下が含まれます：
  - ワークスペース内の**最近アクセスした上位10ファイル**。
  - 現在のカーソル位置。
  - 選択中のテキスト（最大16KBまで；それ以上は切り捨てられます）。

- **ネイティブ差分表示:** Qwenがコード変更を提案する際、IDEのネイティブな差分ビューア内で直接変更内容を確認できます。これにより、提案された変更をシームレスにレビュー、編集、承認または拒否することが可能になります。

- **VS Codeコマンド:** VS Codeのコマンドパレット（`Cmd+Shift+P` または `Ctrl+Shift+P`）から直接Qwen Codeの機能にアクセスできます：
  - `Qwen Code: Run`: 統合ターミナルで新しいQwen Codeセッションを開始します。
  - `Qwen Code: Accept Diff`: アクティブな差分エディタ内の変更を承認します。
  - `Qwen Code: Close Diff Editor`: 変更を拒否してアクティブな差分エディタを閉じます。
  - `Qwen Code: View Third-Party Notices`: 拡張機能のサードパーティ通知を表示します。

## インストールとセットアップ

IDE連携のセットアップには3つの方法があります：

### 1. 自動案内（推奨）

サポートされているエディタ内でQwen Codeを実行すると、環境が自動的に検出され、接続を促す案内が表示されます。「はい」と答えることで、必要なセットアップが自動的に実行され、これにはコンパニオン拡張機能のインストールと接続の有効化が含まれます。

### 2. CLIからの手動インストール

以前に案内を閉じた場合や、拡張機能を手動でインストールしたい場合は、Qwen Code内で以下のコマンドを実行できます：

```
/ide install
```

このコマンドにより、使用しているIDEに適した拡張機能が検出され、インストールされます。

### 3. マーケットプレイスからの手動インストール

エクステンションは、マーケットプレイスから直接インストールすることもできます。

- **Visual Studio Code 向け:** [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=qwenlm.qwen-code-vscode-ide-companion) からインストールしてください。
- **VS Code フォーク向け:** VS Code のフォークをサポートするために、このエクステンションは [Open VSX Registry](https://open-vsx.org/extension/qwenlm/qwen-code-vscode-ide-companion) にも公開されています。お使いのエディタの指示に従って、このレジストリからエクステンションをインストールしてください。

> 注意:
> 「Qwen Code Companion」エクステンションは検索結果の下の方に表示されることがあります。すぐに見つからない場合は、スクロールダウンするか、「新着順」で並べ替えてみてください。
>
> エクステンションを手動でインストールした後、統合機能を有効化するために CLI で `/ide enable` を実行する必要があります。

## 使用方法

### 有効化と無効化

CLI から IDE 連携を制御できます：

- IDE への接続を有効にするには、以下を実行します：
  ```
  /ide enable
  ```
- 接続を無効にするには、以下を実行します：
  ```
  /ide disable
  ```

有効にすると、Qwen Code は自動的に IDE の連携拡張機能への接続を試みます。

### ステータスの確認

接続ステータスを確認し、CLI が IDE から受け取ったコンテキストを表示するには、以下を実行します：

```
/ide status
```

接続されている場合、このコマンドでは接続中の IDE と、認識している最近開いたファイルの一覧が表示されます。

（注：ファイル一覧はワークスペース内で最近アクセスした 10 個のファイルに限定され、ローカルディスク上のファイルのみが含まれます。）

### 差分の操作

Qwen モデルにファイルの変更を依頼すると、エディタ内で直接差分ビューを開くことができます。

**差分を受け入れるには**、以下のいずれかの操作を行ってください：

- 差分エディタのタイトルバーにある **チェックマークアイコン** をクリックします。
- ファイルを保存します（例：`Cmd+S` または `Ctrl+S`）。
- コマンドパレットを開き、**Qwen Code: Accept Diff** を実行します。
- CLI でプロンプトが表示されたら `yes` と応答します。

**差分を拒否するには**、以下のいずれかの操作を行ってください：

- 差分エディタのタイトルバーにある **'x' アイコン** をクリックします。
- 差分エディタのタブを閉じます。
- コマンドパレットを開き、**Qwen Code: Close Diff Editor** を実行します。
- CLI でプロンプトが表示されたら `no` と応答します。

また、差分を受け入れる前に、差分ビュー内で**提案された変更を直接編集することもできます**。

CLI で「Yes, allow always」を選択すると、変更は IDE 上で表示されなくなり、自動的に受け入れられるようになります。

## サンドボックス環境での使用

Qwen Code をサンドボックス内で使用する場合、以下の点に注意してください。

- **macOS で使用する場合：** IDE 連携機能は、IDE 向け拡張機能と通信するためにネットワークアクセスを必要とします。ネットワークアクセスを許可する Seatbelt プロファイルを使用する必要があります。
- **Docker コンテナ内で使用する場合：** Docker（または Podman）コンテナ内で Qwen Code を実行した場合でも、ホストマシン上で動作している VS Code 拡張機能に IDE 連携機能は接続可能です。CLI は自動的に `host.docker.internal` 上の IDE サーバーを見つけられるように設定されています。通常は特別な設定は不要ですが、コンテナからホストへの接続を許可するよう Docker のネットワーク設定を確認する必要があるかもしれません。

## トラブルシューティング

IDE 連携機能で問題が発生した場合、以下によくあるエラーメッセージとその解決方法を示します。

### 接続エラー

- **メッセージ:** `🔴 切断されました: [IDE 名] の IDE コンパニオン拡張機能への接続に失敗しました。拡張機能が実行中であることを確認し、ターミナルを再起動してみてください。拡張機能をインストールするには、/ide install を実行してください。`
  - **原因:** Qwen Code が IDE に接続するために必要な環境変数（`QWEN_CODE_IDE_WORKSPACE_PATH` または `QWEN_CODE_IDE_SERVER_PORT`）を見つけられませんでした。これは通常、IDE コンパニオン拡張機能が実行されていないか、正しく初期化されていないことを意味します。
  - **解決方法:**
    1. IDE に **Qwen Code Companion** 拡張機能がインストールされ、有効になっていることを確認してください。
    2. 正しい環境変数を取得できるように、IDE 内で新しいターミナルウィンドウを開いてください。

- **メッセージ:** `🔴 切断されました: IDE 接続エラー。接続が予期せず失われました。/ide enable を実行して再接続を試みてください。`
  - **原因:** IDE コンパニオンへの接続が失われました。
  - **解決方法:** `/ide enable` を実行して再接続を試みてください。問題が続く場合は、新しいターミナルウィンドウを開くか、IDE を再起動してください。

### 設定エラー

- **メッセージ:** `🔴 切断されました: ディレクトリが一致しません。Qwen Code が [IDE 名] で開いているワークスペースとは異なる場所で実行されています。プロジェクトのルートフォルダと同じディレクトリから CLI を実行してください。`
  - **原因:** CLI の現在の作業ディレクトリが、IDE で開いているフォルダまたはワークスペースの外にある。
  - **解決方法:** IDE で開いているのと同じディレクトリに `cd` して、CLI を再起動してください。

- **メッセージ:** `🔴 切断されました: この機能を使用するには、[IDE 名] でワークスペースフォルダを開いて再度お試しください。`
  - **原因:** IDE でワークスペースが開かれていない。
  - **解決方法:** IDE でワークスペースを開き、CLI を再起動してください。

### 一般的なエラー

- **メッセージ:** `IDE integration is not supported in your current environment. To use this feature, run Qwen Code in one of these supported IDEs: [List of IDEs]`
  - **原因:** サポートされている IDE ではないターミナルまたは環境で Qwen Code を実行しています。
  - **解決方法:** VS Code などのサポートされている IDE の統合ターミナルから Qwen Code を実行してください。

- **メッセージ:** `No installer is available for IDE. Please install the Qwen Code Companion extension manually from the marketplace.`
  - **原因:** `/ide install` を実行しましたが、CLI にご使用の IDE 用の自動インストーラーがありません。
  - **解決方法:** お使いの IDE の拡張機能マーケットプレイスを開き、「Qwen Code Companion」を検索して手動でインストールしてください。