# コントリビュートの方法

私たちはこのプロジェクトへのパッチとコントリビューションを歓迎します。

## コントリビューションプロセス

### コードレビュー

プロジェクトメンバーによる提出物を含め、すべての提出物はレビューが必要です。これには [GitHub プルリクエスト](https://docs.github.com/articles/about-pull-requests) を使用します。

### プルリクエストガイドライン

PR の迅速なレビューとマージのために以下のガイドラインに従ってください。これらの基準を満たしていない PR はクローズされることがあります。

#### 1. 既存の Issue へのリンク

すべてのプルリクエストは、トラッカー内の既存の Issue にリンクされている必要があります。これにより、コードを書く前にすべての変更が議論され、プロジェクトの目標と一致していることが保証されます。

- **バグ修正の場合:** プルリクエストはバグレポートの Issue にリンクしてください。
- **機能追加の場合:** プルリクエストはメンテナーによって承認された機能リクエストまたは提案の Issue にリンクしてください。

変更内容に対応する Issue が存在しない場合は、**まず Issue を作成**し、コーディングを開始する前にフィードバックを待ってください。

#### 2. 小さく、集中して

私たちは、単一の Issue を解決したり、単一の自己完結型の機能を追加したりする小さなアトミックなプルリクエストを推奨しています。

- **すべきこと:** 特定のバグを修正する、または特定の機能を追加するプルリクエストを作成してください。
- **すべきではないこと:** 複数の無関係な変更（例：バグ修正、新機能、リファクタリング）を一つのプルリクエストにまとめないでください。

大規模な変更は、レビューおよび独立してマージできる一連の小さな論理的なプルリクエストに分割する必要があります。

#### 3. 作業中のPRにはDraft PRを使用する

作業内容について早期のフィードバックを得たい場合は、GitHubの**Draft Pull Request**機能を使用してください。これにより、PRが正式なレビューの準備ができていないが、議論と初期のフィードバックのためにオープンになっていることがメンテナーに伝わります。

#### 4. すべてのチェックがパスすることを確認する

PRを提出する前に、`npm run preflight`を実行してすべての自動チェックがパスしていることを確認してください。このコマンドはすべてのテスト、リンティング、およびその他のスタイルチェックを実行します。

#### 5. ドキュメントを更新する

PRでユーザー向けの変更（新しいコマンド、修正されたフラグ、または動作の変更など）を導入する場合は、`/docs`ディレクトリ内の関連するドキュメントも更新する必要があります。

#### 6. 明確なコミットメッセージと良いPRの説明を書く

PRには、明確で説明的なタイトルと、変更内容の詳細な説明が必要です。コミットメッセージについては、[Conventional Commits](https://www.conventionalcommits.org/) 標準に従ってください。

- **良いPRのタイトル例:** `feat(cli): Add --json flag to 'config get' command`
- **悪いPRのタイトル例:** `Made some changes`

PRの説明では、変更の「理由」を説明し、関連するIssueへのリンクを記載してください（例: `Fixes #123`）。

## 開発環境のセットアップとワークフロー

このセクションでは、コントリビューターがプロジェクトの開発環境をビルド・変更・理解する方法について案内します。

### 開発環境のセットアップ

**前提条件:**

1.  **Node.js**:
    - **開発時:** Node.js `~20.19.0` を使用してください。この特定のバージョンは、上流の開発依存関係の問題により必要です。[nvm](https://github.com/nvm-sh/nvm) のようなツールを使用して Node.js のバージョンを管理できます。
    - **本番環境:** CLI を本番環境で実行する場合、Node.js `>=20` の任意のバージョンを使用できます。
2.  **Git**

### ビルドプロセス

リポジトリをクローンするには:

```bash
git clone https://github.com/QwenLM/qwen-code.git # またはあなたのフォークのURL
cd qwen-code
```

`package.json` に定義された依存関係とルートの依存関係をインストールするには:

```bash
npm install
```

プロジェクト全体（すべてのパッケージ）をビルドするには:

```bash
npm run build
```

このコマンドは通常、TypeScript を JavaScript にコンパイルし、アセットをバンドルして、パッケージを実行可能な状態に準備します。ビルド中に何が行われるかの詳細については、`scripts/build.js` および `package.json` のスクリプトを参照してください。

### サンドボックスの有効化

[サンドボックス](#sandboxing)は強く推奨されており、最低限 `~/.env` で `QWEN_SANDBOX=true` を設定し、サンドボックスプロバイダ（例：`macOS Seatbelt`、`docker`、または `podman`）が利用可能であることを確認する必要があります。詳細については[サンドボックス](#sandboxing)を参照してください。

`qwen-code` CLI ユーティリティとサンドボックスコンテナの両方をビルドするには、ルートディレクトリから `build:all` を実行します：

```bash
npm run build:all
```

サンドボックスコンテナのビルドをスキップする場合は、代わりに `npm run build` を使用できます。

### 実行

ソースコードから Qwen Code アプリケーションを起動するには（ビルド後）、ルートディレクトリから以下のコマンドを実行します：

```bash
npm start
```

qwen-code フォルダ外でソースビルドを実行したい場合は、`npm link path/to/qwen-code/packages/cli` を利用して（詳細：[docs](https://docs.npmjs.com/cli/v9/commands/npm-link)）、`qwen-code` で実行できます。

### テストの実行

このプロジェクトには、ユニットテストとインテグレーションテストの2種類のテストが含まれています。

#### 単体テスト

プロジェクトの単体テストスイートを実行するには：

```bash
npm run test
```

これにより、`packages/core` および `packages/cli` ディレクトリにあるテストが実行されます。変更を提出する前に、テストがパスすることを確認してください。より包括的なチェックを行うためには、`npm run preflight` を実行することをお勧めします。

#### 結合テスト

結合テストは、Qwen Code のエンドツーエンド機能を検証するように設計されています。デフォルトの `npm run test` コマンドでは実行されません。

結合テストを実行するには、以下のコマンドを使用してください：

```bash
npm run test:e2e
```

結合テストフレームワークの詳細については、[結合テストドキュメント](./docs/integration-tests.md)をご参照ください。

### Linting とプレフライトチェック

コードの品質とフォーマットの一貫性を確保するために、プレフライトチェックを実行します：

```bash
npm run preflight
```

このコマンドは、ESLint、Prettier、すべてのテスト、およびプロジェクトの `package.json` で定義されているその他のチェックを実行します。

_プロティップ_

クローン後に git の precommit フックファイルを作成し、コミットが常にクリーンであることを保証してください。

```bash
echo "

# npm build を実行し、エラーをチェック
if ! npm run preflight; then
  echo "npm build failed. Commit aborted."
  exit 1
fi
" > .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
```

#### フォーマット

プロジェクト内のコードを個別にフォーマットするには、ルートディレクトリから以下のコマンドを実行します：

```bash
npm run format
```

このコマンドは Prettier を使用して、プロジェクトのスタイルガイドラインに従ってコードをフォーマットします。

#### Linting

プロジェクト内のコードを個別に lint するには、ルートディレクトリから以下のコマンドを実行します：

```bash
npm run lint
```

### コーディング規約

- 既存のコードベース全体で使用されているコーディングスタイル、パターン、規約に従ってください。
- **インポート:** インポートパスには特に注意してください。プロジェクトではESLintを使用してパッケージ間の相対インポートに対する制限を強制しています。

### プロジェクト構造

- `packages/`: プロジェクトの個別サブパッケージが含まれます。
  - `cli/`: コマンドラインインターフェース。
  - `core/`: Qwen Codeのコアバックエンドロジック。
- `docs/`: すべてのプロジェクトドキュメントが含まれます。
- `scripts/`: ビルド、テスト、開発タスク用のユーティリティスクリプト。

より詳細なアーキテクチャについては、`docs/architecture.md`を参照してください。

## ドキュメント開発

このセクションでは、ドキュメントをローカルで開発およびプレビューする方法について説明します。

### 前提条件

1. Node.js（バージョン18以上）がインストールされていることを確認してください
2. npmまたはyarnが利用可能であること

### ドキュメントサイトをローカルでセットアップする

ドキュメントの作業や変更のプレビューをローカルで行うには：

1. `docs-site` ディレクトリに移動します：

   ```bash
   cd docs-site
   ```

2. 依存関係をインストールします：

   ```bash
   npm install
   ```

3. メインの `docs` ディレクトリからドキュメントコンテンツをリンクします：

   ```bash
   npm run link
   ```

   これにより、`../docs` から docs-site プロジェクト内の `content` へのシンボリックリンクが作成され、Next.js サイトでドキュメントコンテンツを提供できるようになります。

4. 開発サーバーを起動します：

   ```bash
   npm run dev
   ```

5. ブラウザで [http://localhost:3000](http://localhost:3000) を開き、変更を行うとリアルタイムで更新されるドキュメントサイトを確認します。

メインの `docs` ディレクトリにあるドキュメントファイルに加えられた変更は、すぐにドキュメントサイトに反映されます。

## デバッグ

### VS Code:

0.  `F5` を使用して VS Code で対話的にデバッグするには、CLI を実行します。
1.  ルートディレクトリから CLI をデバッグモードで起動します。
    ```bash
    npm run debug
    ```
    このコマンドは `packages/cli` ディレクトリ内で `node --inspect-brk dist/index.js` を実行し、デバッガがアタッチされるまで実行を一時停止します。その後、Chrome ブラウザで `chrome://inspect` を開いてデバッガに接続できます。
2.  VS Code で「Attach」起動設定（`.vscode/launch.json` 内にあります）を使用します。

あるいは、現在開いているファイルを直接起動する場合は、VS Code の「Launch Program」設定を使用することもできますが、一般的には「F5」の使用が推奨されます。

サンドボックスコンテナ内でブレークポイントにヒットさせるには、以下を実行します。

```bash
DEBUG=1 qwen-code
```

**注:** プロジェクトの `.env` ファイルに `DEBUG=true` があっても、自動的に除外されるため qwen-code には影響しません。qwen-code 固有のデバッグ設定には `.qwen-code/.env` ファイルを使用してください。

### React DevTools

CLI の React ベースの UI をデバッグするには、React DevTools を使用できます。CLI のインターフェースに使用されているライブラリである Ink は、React DevTools バージョン 4.x と互換性があります。

1.  **開発モードで Qwen Code アプリケーションを起動します：**

    ```bash
    DEV=true npm start
    ```

2.  **React DevTools バージョン 4.28.5（または互換性のある最新の 4.x バージョン）をインストールして実行します：**

    グローバルにインストールする方法：

    ```bash
    npm install -g react-devtools@4.28.5
    react-devtools
    ```

    または、npx を使用して直接実行する方法：

    ```bash
    npx react-devtools@4.28.5
    ```

    実行中の CLI アプリケーションが React DevTools に接続されます。

## Sandboxing

> TBD

## Manual Publish

内部レジストリには各コミットに対してアーティファクトを公開していますが、ローカルビルドを手動で作成する必要がある場合は、以下のコマンドを実行してください：

```
npm run clean
npm install
npm run auth
npm run prerelease:dev
npm publish --workspaces
```