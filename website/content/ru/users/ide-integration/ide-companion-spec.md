# Плагин Qwen Code Companion: Спецификация интерфейса

> Последнее обновление: 15 сентября 2025 г.

Этот документ определяет контракт для создания сопутствующего плагина, позволяющего использовать режим IDE Qwen Code. Для VS Code эти функции (встроенные diff-инструменты, контекстная осведомленность) предоставляются официальным расширением ([marketplace](https://marketplace.visualstudio.com/items?itemName=qwenlm.qwen-code-vscode-ide-companion)). Эта спецификация предназначена для разработчиков, желающих добавить аналогичный функционал в другие редакторы, такие как JetBrains IDE, Sublime Text и т.д.

## I. Интерфейс взаимодействия

Qwen Code и плагин IDE взаимодействуют через локальный канал связи.

### 1. Транспортный уровень: MCP поверх HTTP

Плагин **ДОЛЖЕН** запускать локальный HTTP-сервер, который реализует **протокол контекста модели (MCP)**.

- **Протокол:** Сервер должен быть действующим MCP-сервером. Мы рекомендуем использовать существующий MCP SDK для выбранного вами языка, если он доступен.
- **Конечная точка:** Сервер должен предоставлять одну конечную точку (например, `/mcp`) для всей связи MCP.
- **Порт:** Сервер **ДОЛЖЕН** прослушивать динамически назначенный порт (то есть прослушивать порт `0`).

### 2. Механизм обнаружения: Lock-файл

Чтобы Qwen Code мог подключиться, ему нужно обнаружить, какой порт использует ваш сервер. Плагин **ДОЛЖЕН** облегчить это, создав "lock-файл" и установив переменную окружения порта.

- **Как CLI находит файл:** CLI читает порт из `QWEN_CODE_IDE_SERVER_PORT`, затем читает `~/.qwen/ide/<PORT>.lock`. (Существуют резервные варианты для старых расширений; см. примечание ниже.)
- **Расположение файла:** Файл должен быть создан в определенной директории: `~/.qwen/ide/`. Ваш плагин должен создать эту директорию, если она не существует.
- **Соглашение об именовании файлов:** Имя файла критично и **ДОЛЖНО** следовать шаблону:
  `<PORT>.lock`
  - `<PORT>`: Порт, на котором слушает ваш MCP-сервер.
- **Содержимое файла и проверка рабочей области:** Файл **ДОЛЖЕН** содержать JSON-объект со следующей структурой:

  ```json
  {
    "port": 12345,
    "workspacePath": "/path/to/project1:/path/to/project2",
    "authToken": "a-very-secret-token",
    "ppid": 1234,
    "ideName": "VS Code"
  }
  ```
  - `port` (число, обязательно): Порт MCP-сервера.
  - `workspacePath` (строка, обязательно): Список всех открытых корневых путей рабочих областей, разделенных системным разделителем путей (`:` для Linux/macOS, `;` для Windows). CLI использует этот путь, чтобы убедиться, что он запущен в той же папке проекта, которая открыта в IDE. Если текущий рабочий каталог CLI не является подкаталогом `workspacePath`, подключение будет отклонено. Ваш плагин **ДОЛЖЕН** предоставлять правильный(е), абсолютный(ые) путь(и) к корню открытой(ых) рабочей(их) области(ей).
  - `authToken` (строка, обязательно): Секретный токен для обеспечения безопасности соединения. CLI будет включать этот токен в заголовок `Authorization: Bearer <token>` во всех запросах.
  - `ppid` (число, обязательно): Идентификатор родительского процесса процесса IDE.
  - `ideName` (строка, обязательно): Удобочитаемое имя IDE (например, `VS Code`, `JetBrains IDE`).

- **Аутентификация:** Для обеспечения безопасности соединения плагин **ДОЛЖЕН** генерировать уникальный секретный токен и включать его в файл обнаружения. Затем CLI будет включать этот токен в заголовок `Authorization` для всех запросов к MCP-серверу (например, `Authorization: Bearer a-very-secret-token`). Ваш сервер **ДОЛЖЕН** проверять этот токен при каждом запросе и отклонять все неавторизованные.
- **Переменные окружения (обязательно):** Ваш плагин **ДОЛЖЕН** установить `QWEN_CODE_IDE_SERVER_PORT` в интегрированном терминале, чтобы CLI мог найти правильный файл `<PORT>.lock`.

**Примечание о совместимости:** Для расширений старше v0.5.1 Qwen Code может использовать резервный вариант чтения JSON-файлов в системной временной директории с именами `qwen-code-ide-server-<PID>.json` или `qwen-code-ide-server-<PORT>.json`. Новые интеграции не должны полагаться на эти устаревшие файлы.

## II. Интерфейс контекста

Для обеспечения осведомленности о контексте плагин **МОЖЕТ** предоставлять CLI актуальную информацию о действиях пользователя в IDE.

### Уведомление `ide/contextUpdate`

Плагин **МОЖЕТ** отправлять уведомление `ide/contextUpdate` [notification](https://modelcontextprotocol.io/specification/2025-06-18/basic/index#notifications) в CLI всякий раз, когда изменяется контекст пользователя.

- **События запуска:** Это уведомление должно отправляться (с рекомендуемой задержкой 50 мс) когда:
  - Файл открывается, закрывается или получает фокус.
  - Изменяется позиция курсора пользователя или выделение текста в активном файле.
- **Полезная нагрузка (`IdeContext`):** Параметры уведомления **ДОЛЖНЫ** быть объектом `IdeContext`:

  ```typescript
  interface IdeContext {
    workspaceState?: {
      openFiles?: File[];
      isTrusted?: boolean;
    };
  }

  interface File {
    // Абсолютный путь к файлу
    path: string;
    // Последняя метка времени фокуса в формате Unix (для упорядочивания)
    timestamp: number;
    // Истина, если это текущий активный файл
    isActive?: boolean;
    cursor?: {
      // Номер строки (начиная с 1)
      line: number;
      // Номер символа (начиная с 1)
      character: number;
    };
    // Текст, выделенный пользователем в данный момент
    selectedText?: string;
  }
  ```

  **Примечание:** Список `openFiles` должен включать только файлы, существующие на диске. Виртуальные файлы (например, несохраненные файлы без пути, страницы настроек редактора) **ДОЛЖНЫ** исключаться.

### Как CLI использует этот контекст

После получения объекта `IdeContext` CLI выполняет несколько шагов нормализации и усечения перед отправкой информации в модель.

- **Порядок файлов:** CLI использует поле `timestamp`, чтобы определить недавно используемые файлы. Он сортирует список `openFiles` на основе этого значения. Поэтому ваш плагин **ДОЛЖЕН** предоставлять точную метку времени Unix для момента, когда файл был последний раз в фокусе.
- **Активный файл:** CLI считает активным только самый последний файл (после сортировки). Он проигнорирует флаг `isActive` для всех остальных файлов и очистит их поля `cursor` и `selectedText`. Ваш плагин должен сосредоточиться на установке `isActive: true` и предоставлении деталей курсора/выделения только для текущего файла в фокусе.
- **Усечение:** Для управления лимитами токенов CLI усекает как список файлов (до 10 файлов), так и `selectedText` (до 16 КБ).

Хотя CLI обрабатывает окончательное усечение, настоятельно рекомендуется, чтобы ваш плагин также ограничивал объем отправляемого контекста.

## III. Интерфейс сравнения

Для включения интерактивных модификаций кода плагин **МОЖЕТ** предоставлять интерфейс сравнения. Это позволяет CLI запрашивать у IDE открытие окна сравнения, показывающего предложенные изменения в файле. Затем пользователь может просматривать, редактировать и в конечном итоге принимать или отклонять эти изменения непосредственно в IDE.

### Инструмент `openDiff`

Плагин **ДОЛЖЕН** зарегистрировать инструмент `openDiff` на своем сервере MCP.

- **Описание:** Этот инструмент указывает IDE открыть редактируемое представление различий для конкретного файла.
- **Запрос (`OpenDiffRequest`):** Инструмент вызывается через запрос `tools/call`. Поле `arguments` внутри поля `params` запроса **ДОЛЖНО** быть объектом `OpenDiffRequest`.

  ```typescript
  interface OpenDiffRequest {
    // Абсолютный путь к файлу, для которого нужно показать различия.
    filePath: string;
    // Предлагаемое новое содержимое файла.
    newContent: string;
  }
  ```

- **Ответ (`CallToolResult`):** Инструмент **ДОЛЖЕН** немедленно вернуть `CallToolResult`, чтобы подтвердить запрос и сообщить, было ли успешно открыто представление различий.
  - При успехе: Если представление различий было успешно открыто, ответ **ДОЛЖЕН** содержать пустое содержимое (т.е. `content: []`).
  - При ошибке: Если ошибка помешала открытию представления различий, ответ **ДОЛЖЕН** иметь `isError: true` и включать блок `TextContent` в массиве `content`, описывающий ошибку.

  Фактический результат сравнения (принятие или отклонение) передается асинхронно через уведомления.

### Инструмент `closeDiff`

Плагин **ДОЛЖЕН** зарегистрировать инструмент `closeDiff` на своем сервере MCP.

- **Описание:** Этот инструмент указывает IDE закрыть открытый вид сравнения для определенного файла.
- **Запрос (`CloseDiffRequest`):** Инструмент вызывается через запрос `tools/call`. Поле `arguments` внутри `params` запроса **ДОЛЖНО** быть объектом `CloseDiffRequest`.

  ```typescript
  interface CloseDiffRequest {
    // Абсолютный путь к файлу, чей вид сравнения должен быть закрыт.
    filePath: string;
  }
  ```

- **Ответ (`CallToolResult`):** Инструмент **ДОЛЖЕН** вернуть `CallToolResult`.
  - При успехе: Если вид сравнения был успешно закрыт, ответ **ДОЛЖЕН** включать один блок **TextContent** в массиве content, содержащий окончательное содержимое файла перед закрытием.
  - При ошибке: Если ошибка помешала закрытию вида сравнения, ответ **ДОЛЖЕН** иметь `isError: true` и включать блок `TextContent` в массив `content`, описывающий ошибку.

### Уведомление `ide/diffAccepted`

Когда пользователь принимает изменения в окне сравнения (например, нажимая кнопку "Применить" или "Сохранить"), плагин **ДОЛЖЕН** отправить уведомление `ide/diffAccepted` в CLI.

- **Полезная нагрузка:** Параметры уведомления **ДОЛЖНЫ** включать путь к файлу и окончательное содержимое файла. Содержимое может отличаться от исходного `newContent`, если пользователь внес ручные изменения в окне сравнения.

  ```typescript
  {
    // Абсолютный путь к файлу, который сравнивался.
    filePath: string;
    // Полное содержимое файла после принятия.
    content: string;
  }
  ```

### Уведомление `ide/diffRejected`

Когда пользователь отклоняет изменения (например, закрывает окно сравнения без принятия), плагин **ДОЛЖЕН** отправить уведомление `ide/diffRejected` в CLI.

- **Полезная нагрузка:** Параметры уведомления **ДОЛЖНЫ** включать путь к файлу отклоненного сравнения.

  ```typescript
  {
    // Абсолютный путь к файлу, который сравнивался.
    filePath: string;
  }
  ```

## IV. Интерфейс жизненного цикла

Плагин **ДОЛЖЕН** корректно управлять своими ресурсами и файлом обнаружения в соответствии с жизненным циклом IDE.

- **При активации (запуск IDE/включение плагина):**
  1.  Запустить сервер MCP.
  2.  Создать файл обнаружения.
- **При деактивации (выключение IDE/отключение плагина):**
  1.  Остановить сервер MCP.
  2.  Удалить файл обнаружения.