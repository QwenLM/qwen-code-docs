# Плагин Qwen Code Companion: Спецификация интерфейса

> Последнее обновление: 15 сентября 2025 г.

Этот документ определяет контракт для создания плагина-компаньона, который включает режим IDE в Qwen Code. Для VS Code эти функции (нативное сравнение, осведомленность о контексте) предоставляются официальным расширением ([маркетплейс](https://marketplace.visualstudio.com/items?itemName=qwenlm.qwen-code-vscode-ide-companion)). Эта спецификация предназначена для участников, которые хотят реализовать аналогичную функциональность в других редакторах, таких как JetBrains IDE, Sublime Text и т. д.

## I. Интерфейс связи

Qwen Code и плагин IDE взаимодействуют через локальный канал связи.

### 1. Транспортный уровень: MCP поверх HTTP

Плагин **ДОЛЖЕН** запускать локальный HTTP-сервер, реализующий **Model Context Protocol (MCP)**.

- **Протокол:** Сервер должен быть корректным MCP-сервером. Мы рекомендуем использовать существующий MCP SDK для выбранного языка, если таковой доступен.
- **Конечная точка:** Сервер должен предоставлять одну конечную точку (например, `/mcp`) для всего MCP-взаимодействия.
- **Порт:** Сервер **ДОЛЖЕН** слушать динамически назначенный порт (то есть слушать порт `0`).

### 2. Механизм обнаружения: Файл порта

Для подключения Qwen Code необходимо определить, в каком экземпляре IDE он запущен, и какой порт использует ваш сервер. Плагин **ОБЯЗАН** обеспечить это, создавая «файл обнаружения».

- **Как CLI находит файл:** CLI определяет идентификатор процесса (PID) IDE, в которой он запущен, путём обхода дерева процессов. Затем он ищет файл обнаружения, имя которого содержит этот PID.
- **Расположение файла:** Файл должен быть создан в определённой директории: `os.tmpdir()/qwen/ide/`. Ваш плагин должен создать эту директорию, если она не существует.
- **Соглашение об именовании файла:** Имя файла критично и **ДОЛЖНО** соответствовать шаблону:
  `qwen-code-ide-server-${PID}-${PORT}.json`
  - `${PID}`: Идентификатор родительского процесса IDE. Ваш плагин должен определить этот PID и включить его в имя файла.
  - `${PORT}`: Порт, на котором слушает ваш сервер MCP.
- **Содержимое файла и проверка рабочей области:** Файл **ДОЛЖЕН** содержать JSON-объект со следующей структурой:

  ```json
  {
    "port": 12345,
    "workspacePath": "/path/to/project1:/path/to/project2",
    "authToken": "a-very-secret-token",
    "ideInfo": {
      "name": "vscode",
      "displayName": "VS Code"
    }
  }
  ```
  - `port` (число, обязательно): Порт сервера MCP.
  - `workspacePath` (строка, обязательно): Список всех корневых путей открытых рабочих областей, разделённых специфичным для ОС разделителем (`:` для Linux/macOS, `;` для Windows). CLI использует этот путь, чтобы убедиться, что он запущен в той же папке проекта, что открыта в IDE. Если текущая рабочая директория CLI не является подкаталогом `workspacePath`, соединение будет отклонено. Ваш плагин **ОБЯЗАН** предоставить правильные абсолютные пути к корню открытых рабочих областей.
  - `authToken` (строка, обязательно): Секретный токен для защиты соединения. CLI будет включать этот токен в заголовок `Authorization: Bearer <token>` во все запросы.
  - `ideInfo` (объект, обязательно): Информация об IDE.
    - `name` (строка, обязательно): Краткий идентификатор IDE в нижнем регистре (например, `vscode`, `jetbrains`).
    - `displayName` (строка, обязательно): Удобочитаемое имя IDE (например, `VS Code`, `JetBrains IDE`).

- **Аутентификация:** Для защиты соединения плагин **ОБЯЗАН** генерировать уникальный секретный токен и включать его в файл обнаружения. CLI затем будет включать этот токен в заголовок `Authorization` для всех запросов к серверу MCP (например, `Authorization: Bearer a-very-secret-token`). Ваш сервер **ОБЯЗАН** проверять этот токен при каждом запросе и отклонять неавторизованные запросы.
- **Разрешение конфликтов с помощью переменных окружения (рекомендуется):** Для наиболее надёжной работы ваш плагин **ДОЛЖЕН** как создавать файл обнаружения, так и устанавливать переменную окружения `QWEN_CODE_IDE_SERVER_PORT` во встроенном терминале. Файл служит основным механизмом обнаружения, но переменная окружения играет ключевую роль при разрешении конфликтов. Если пользователь открыл несколько окон IDE для одной и той же рабочей области, CLI использует переменную `QWEN_CODE_IDE_SERVER_PORT`, чтобы определить и подключиться к серверу нужного окна.

## II. Интерфейс контекста

Чтобы обеспечить осведомленность о контексте, плагин **МОЖЕТ** предоставлять CLI информацию в реальном времени об активности пользователя в IDE.

### Уведомление `ide/contextUpdate`

Плагин **МОЖЕТ** отправлять уведомление `ide/contextUpdate` [уведомление](https://modelcontextprotocol.io/specification/2025-06-18/basic/index#notifications) в CLI всякий раз, когда контекст пользователя изменяется.

- **События запуска:** Это уведомление должно быть отправлено (с рекомендуемой задержкой 50 мс) при:
  - Открытии, закрытии или фокусировке файла.
  - Изменении позиции курсора пользователя или выделения текста в активном файле.
- **Полезная нагрузка (`IdeContext`):** Параметры уведомления **ДОЛЖНЫ** быть объектом `IdeContext`:

  ```typescript
  interface IdeContext {
    workspaceState?: {
      openFiles?: File[];
      isTrusted?: boolean;
    };
  }

  interface File {
    // Абсолютный путь к файлу
    path: string;
    // Временная метка последнего фокуса (для упорядочивания)
    timestamp: number;
    // True, если это текущий сфокусированный файл
    isActive?: boolean;
    cursor?: {
      // Номер строки (начинается с 1)
      line: number;
      // Номер символа (начинается с 1)
      character: number;
    };
    // Текст, выбранный пользователем в данный момент
    selectedText?: string;
  }
  ```

  **Примечание:** Список `openFiles` должен включать только файлы, существующие на диске. Виртуальные файлы (например, несохраненные файлы без пути, страницы настроек редактора) **ДОЛЖНЫ** быть исключены.

### Как CLI использует этот контекст

После получения объекта `IdeContext` CLI выполняет несколько шагов нормализации и усечения перед отправкой информации в модель.

- **Порядок файлов:** CLI использует поле `timestamp`, чтобы определить самые недавно использованные файлы. Он сортирует список `openFiles` на основе этого значения. Поэтому ваш плагин **ДОЛЖЕН** предоставлять точную метку времени Unix для момента, когда файл был последний раз в фокусе.
- **Активный файл:** CLI считает только самый последний файл (после сортировки) «активным» файлом. Он будет игнорировать флаг `isActive` на всех остальных файлах и очищать их поля `cursor` и `selectedText`. Ваш плагин должен сосредоточиться на установке `isActive: true` и предоставлении деталей курсора/выделения только для текущего активного файла.
- **Усечение:** Чтобы управлять лимитами токенов, CLI усекает как список файлов (до 10 файлов), так и `selectedText` (до 16 КБ).

Хотя CLI обрабатывает окончательное усечение, настоятельно рекомендуется, чтобы ваш плагин также ограничивал объем отправляемого контекста.

## III. Интерфейс сравнения

Чтобы включить интерактивные изменения кода, плагин **МОЖЕТ** предоставить интерфейс сравнения. Это позволяет CLI запросить у IDE открытие представления различий, показывающего предложенные изменения в файле. Затем пользователь может просмотреть, отредактировать и в конечном итоге принять или отклонить эти изменения непосредственно в IDE.

### Инструмент `openDiff`

Плагин **ДОЛЖЕН** зарегистрировать инструмент `openDiff` на своем MCP-сервере.

- **Описание:** Этот инструмент указывает IDE открыть изменяемое представление diff для определенного файла.
- **Запрос (`OpenDiffRequest`):** Инструмент вызывается через запрос `tools/call`. Поле `arguments` в `params` запроса **ДОЛЖНО** быть объектом типа `OpenDiffRequest`.

  ```typescript
  interface OpenDiffRequest {
    // Абсолютный путь к файлу, по которому будет создан diff.
    filePath: string;
    // Предлагаемое новое содержимое файла.
    newContent: string;
  }
  ```

- **Ответ (`CallToolResult`):** Инструмент **ДОЛЖЕН** немедленно вернуть `CallToolResult`, чтобы подтвердить получение запроса и сообщить, успешно ли было открыто представление diff.
  - В случае успеха: Если представление diff было успешно открыто, ответ **ДОЛЖЕН** содержать пустой контент (т.е. `content: []`).
  - В случае ошибки: Если ошибка помешала открытию представления diff, ответ **ДОЛЖЕН** иметь `isError: true` и включать блок `TextContent` в массиве `content`, описывающий ошибку.

  Фактический результат применения diff (принятие или отклонение) передается асинхронно через уведомления.

### Инструмент `closeDiff`

Плагин **ДОЛЖЕН** зарегистрировать инструмент `closeDiff` на своем MCP-сервере.

- **Описание:** Этот инструмент указывает IDE закрыть открытую панель сравнения для определенного файла.
- **Запрос (`CloseDiffRequest`):** Инструмент вызывается через запрос `tools/call`. Поле `arguments` в `params` запроса **ДОЛЖНО** быть объектом типа `CloseDiffRequest`.

  ```typescript
  interface CloseDiffRequest {
    // Абсолютный путь к файлу, панель сравнения которого следует закрыть.
    filePath: string;
  }
  ```

- **Ответ (`CallToolResult`):** Инструмент **ДОЛЖЕН** вернуть `CallToolResult`.
  - В случае успеха: Если панель сравнения была успешно закрыта, ответ **ДОЛЖЕН** содержать один блок **TextContent** в массиве content с финальным содержимым файла перед закрытием.
  - В случае ошибки: Если ошибка помешала закрытию панели сравнения, ответ **ДОЛЖЕН** иметь `isError: true` и включать блок `TextContent` в массиве `content`, описывающий ошибку.

### Уведомление `ide/diffAccepted`

Когда пользователь принимает изменения в представлении diff (например, нажимая кнопку «Применить» или «Сохранить»), плагин **ДОЛЖЕН** отправить уведомление `ide/diffAccepted` в CLI.

- **Полезная нагрузка:** Параметры уведомления **ДОЛЖНЫ** включать путь к файлу и окончательное содержимое файла. Содержимое может отличаться от оригинального `newContent`, если пользователь внес ручные правки в представлении diff.

  ```typescript
  {
    // Абсолютный путь к файлу, по которому был сделан diff.
    filePath: string;
    // Полное содержимое файла после принятия изменений.
    content: string;
  }
  ```

### Уведомление `ide/diffRejected`

Когда пользователь отклоняет изменения (например, закрывая представление diff без подтверждения), плагин **ДОЛЖЕН** отправить уведомление `ide/diffRejected` в CLI.

- **Полезная нагрузка:** Параметры уведомления **ДОЛЖНЫ** включать путь к файлу отклонённого diff.

  ```typescript
  {
    // Абсолютный путь к файлу, по которому был сделан diff.
    filePath: string;
  }
  ```

## IV. Интерфейс жизненного цикла

Плагин **ДОЛЖЕН** правильно управлять своими ресурсами и файлом обнаружения в соответствии с жизненным циклом IDE.

- **При активации (запуск IDE/включение плагина):**
  1.  Запустить сервер MCP.
  2.  Создать файл обнаружения.
- **При деактивации (выключение IDE/отключение плагина):**
  1.  Остановить сервер MCP.
  2.  Удалить файл обнаружения.