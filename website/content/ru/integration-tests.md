# Интеграционные тесты

Этот документ содержит информацию о фреймворке интеграционного тестирования, используемом в проекте.

## Обзор

Интеграционные тесты предназначены для проверки сквозной функциональности Qwen Code. Они запускают собранный бинарный файл в контролируемой среде и проверяют, что он ведет себя должным образом при взаимодействии с файловой системой.

Тесты находятся в директории `integration-tests` и запускаются с помощью кастомного test runner'а.

## Запуск тестов

Интеграционные тесты не запускаются по умолчанию командой `npm run test`. Их нужно запускать явно, используя скрипт `npm run test:integration:all`.

Также интеграционные тесты можно запустить, используя следующий ярлык:

```bash
npm run test:e2e
```

## Запуск определенного набора тестов

Чтобы запустить подмножество тестовых файлов, можно использовать команду `npm run <integration test command> <file_name1> ....`, где <integration test command> — это либо `test:e2e`, либо `test:integration*`, а `<file_name>` — любой из файлов `.test.js` в директории `integration-tests/`. Например, следующая команда запускает `list_directory.test.js` и `write_file.test.js`:

```bash
npm run test:e2e list_directory write_file
```

### Запуск одного теста по названию

Чтобы запустить один тест по его названию, используйте флаг `--test-name-pattern`:

```bash
npm run test:e2e -- --test-name-pattern "reads a file"
```

### Запуск всех тестов

Чтобы запустить весь набор интеграционных тестов, используйте следующую команду:

```bash
npm run test:integration:all
```

### Матрица песочниц

Команда `all` запустит тесты для `no sandboxing`, `docker` и `podman`.  
Каждый отдельный тип можно запустить с помощью следующих команд:

```bash
npm run test:integration:sandbox:none
```

```bash
npm run test:integration:sandbox:docker
```

```bash
npm run test:integration:sandbox:podman
```

## Диагностика

Test runner интеграционных тестов предоставляет несколько опций для диагностики, которые помогут отследить причины падений тестов.

### Сохранение вывода тестов

Вы можете сохранить временные файлы, созданные во время запуска тестов, для последующего анализа. Это полезно при отладке проблем с операциями файловой системы.

Чтобы сохранить вывод тестов, можно либо использовать флаг `--keep-output`, либо установить переменную окружения `KEEP_OUTPUT` в значение `true`.

```bash

# С использованием флага
npm run test:integration:sandbox:none -- --keep-output

# Использование переменной окружения

```bash
KEEP_OUTPUT=true npm run test:integration:sandbox:none
```

Если вывод сохраняется, test runner выведет путь к уникальному каталогу для этого запуска тестов.

### Подробный вывод (Verbose output)

Для более детальной отладки флаг `--verbose` передаёт вывод команды `qwen` в реальном времени прямо в консоль.

```bash
npm run test:integration:sandbox:none -- --verbose
```

Если в одной команде используются одновременно `--verbose` и `--keep-output`, то вывод будет отображаться в консоли и также сохраняться в log-файл внутри временного каталога теста.

Формат подробного вывода позволяет легко определить источник логов:

```
--- TEST: <file-name-without-js>:<test-name> ---
... вывод от команды qwen ...
--- END TEST: <file-name-without-js>:<test-name> ---
```

## Линтинг и форматирование

Для обеспечения качества и единообразия кода, файлы интеграционных тестов проходят линтинг в рамках основного процесса сборки. Также можно вручную запустить линтер и автоисправление.

### Запуск линтера

Чтобы проверить наличие ошибок линтинга, выполните следующую команду:

```bash
npm run lint
```

Вы можете добавить флаг `:fix` к команде, чтобы автоматически исправить все ошибки линтинга, которые можно исправить:

```bash
npm run lint:fix
```

## Структура директорий

Интеграционные тесты создают уникальную директорию для каждого запуска теста внутри директории `.integration-tests`. В этой директории создается поддиректория для каждого тестового файла, а внутри нее — поддиректория для каждого отдельного тест-кейса.

Такая структура позволяет легко находить артефакты для конкретного запуска теста, файла или кейса.

```
.integration-tests/
└── <run-id>/
    └── <test-file-name>.test.js/
        └── <test-case-name>/
            ├── output.log
            └── ...другие артефакты теста...
```

## Непрерывная интеграция

Чтобы гарантировать, что интеграционные тесты всегда выполняются, в `.github/workflows/e2e.yml` определен workflow для GitHub Actions. Этот workflow автоматически запускает интеграционные тесты для pull request'ов в ветку `main`, или когда pull request добавляется в очередь на слияние.

Workflow запускает тесты в различных средах песочницы, чтобы убедиться, что Qwen Code тестируется в каждой из них:

- `sandbox:none`: Запускает тесты без какой-либо песочницы.
- `sandbox:docker`: Запускает тесты в Docker-контейнере.
- `sandbox:podman`: Запускает тесты в Podman-контейнере.