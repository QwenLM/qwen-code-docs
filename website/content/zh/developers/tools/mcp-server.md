# ä½¿ç”¨ Qwen Code é…ç½® MCP æœåŠ¡å™¨

æœ¬æ–‡æ¡£æä¾›äº†ä½¿ç”¨ Qwen Code é…ç½®å’Œä½¿ç”¨æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼ˆMCPï¼‰æœåŠ¡å™¨çš„æŒ‡å—ã€‚

## ä»€ä¹ˆæ˜¯ MCP æœåŠ¡å™¨ï¼Ÿ

MCP æœåŠ¡å™¨æ˜¯ä¸€ç§é€šè¿‡æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼ˆModel Context Protocolï¼‰å‘ CLI æš´éœ²å·¥å…·å’Œèµ„æºçš„åº”ç”¨ç¨‹åºï¼Œä½¿å…¶èƒ½å¤Ÿä¸å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æºè¿›è¡Œäº¤äº’ã€‚MCP æœåŠ¡å™¨å……å½“äº†æ¨¡å‹ä¸æœ¬åœ°ç¯å¢ƒæˆ–å…¶ä»–æœåŠ¡ï¼ˆå¦‚ APIï¼‰ä¹‹é—´çš„æ¡¥æ¢ã€‚

MCP æœåŠ¡å™¨ä½¿ CLI èƒ½å¤Ÿï¼š

- **å‘ç°å·¥å…·ï¼š** é€šè¿‡æ ‡å‡†åŒ–çš„æ¨¡å¼å®šä¹‰åˆ—å‡ºå¯ç”¨å·¥å…·ã€å…¶æè¿°åŠå‚æ•°ã€‚
- **æ‰§è¡Œå·¥å…·ï¼š** ä½¿ç”¨å®šä¹‰å¥½çš„å‚æ•°è°ƒç”¨ç‰¹å®šå·¥å…·ï¼Œå¹¶æ¥æ”¶ç»“æ„åŒ–å“åº”ã€‚
- **è®¿é—®èµ„æºï¼š** ä»ç‰¹å®šèµ„æºä¸­è¯»å–æ•°æ®ï¼ˆå°½ç®¡ CLI ä¸»è¦ä¸“æ³¨äºå·¥å…·æ‰§è¡Œï¼‰ã€‚

å€ŸåŠ© MCP æœåŠ¡å™¨ï¼Œä½ å¯ä»¥æ‰©å±• CLI çš„åŠŸèƒ½ï¼Œä½¿å…¶æ‰§è¡Œè¶…å‡ºå†…ç½®ç‰¹æ€§èŒƒå›´çš„æ“ä½œï¼Œä¾‹å¦‚ä¸æ•°æ®åº“ã€APIã€è‡ªå®šä¹‰è„šæœ¬æˆ–ä¸“ç”¨å·¥ä½œæµè¿›è¡Œäº¤äº’ã€‚

## æ ¸å¿ƒé›†æˆæ¶æ„

Qwen Code é€šè¿‡æ ¸å¿ƒåŒ…ï¼ˆ`packages/core/src/tools/`ï¼‰ä¸­å†…ç½®çš„å¤æ‚å‘ç°å’Œæ‰§è¡Œç³»ç»Ÿä¸ MCP æœåŠ¡å™¨è¿›è¡Œé›†æˆï¼š

### å‘ç°é˜¶æ®µï¼ˆ`mcp-client.ts`ï¼‰

å‘ç°è¿‡ç¨‹ç”± `discoverMcpTools()` ç¼–æ’ï¼Œè¯¥å‡½æ•°ï¼š

1. **éå†é…ç½®çš„æœåŠ¡å™¨**ï¼šä»ä½ çš„ `settings.json` ä¸­çš„ `mcpServers` é…ç½®è¯»å–æœåŠ¡å™¨åˆ—è¡¨  
2. **å»ºç«‹è¿æ¥**ï¼šä½¿ç”¨é€‚å½“çš„ä¼ è¾“æœºåˆ¶ï¼ˆStdioã€SSE æˆ–å¯æµå¼ HTTPï¼‰å»ºç«‹è¿æ¥  
3. **è·å–å·¥å…·å®šä¹‰**ï¼šé€šè¿‡ MCP åè®®ä»æ¯ä¸ªæœåŠ¡å™¨è·å–å·¥å…·å®šä¹‰  
4. **æ¸…ç†å¹¶éªŒè¯**ï¼šå¯¹å·¥å…· schema è¿›è¡Œæ¸…ç†å’ŒéªŒè¯ï¼Œç¡®ä¿å…¶ä¸ Qwen API å…¼å®¹  
5. **æ³¨å†Œå·¥å…·**ï¼šå°†å·¥å…·æ³¨å†Œåˆ°å…¨å±€å·¥å…·æ³¨å†Œè¡¨ä¸­ï¼Œå¹¶å¤„ç†å†²çªé—®é¢˜

### æ‰§è¡Œå±‚ (`mcp-tool.ts`)

æ¯ä¸ªå‘ç°çš„ MCP å·¥å…·éƒ½ä¼šè¢«å°è£…åœ¨ä¸€ä¸ª `DiscoveredMCPTool` å®ä¾‹ä¸­ï¼Œè¯¥å®ä¾‹ï¼š

- **å¤„ç†ç¡®è®¤é€»è¾‘**ï¼šåŸºäºæœåŠ¡å™¨ä¿¡ä»»è®¾ç½®å’Œç”¨æˆ·åå¥½è¿›è¡Œåˆ¤æ–­
- **ç®¡ç†å·¥å…·æ‰§è¡Œ**ï¼šé€šè¿‡æ­£ç¡®çš„å‚æ•°è°ƒç”¨ MCP æœåŠ¡å™¨
- **å¤„ç†å“åº”**ï¼šä¸º LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æ˜¾ç¤ºåˆ†åˆ«å¤„ç†å“åº”å†…å®¹
- **ç»´æŠ¤è¿æ¥çŠ¶æ€**ï¼šå¤„ç†è¶…æ—¶ç­‰è¿æ¥é—®é¢˜

### ä¼ è¾“æœºåˆ¶

CLI æ”¯æŒä¸‰ç§ MCP ä¼ è¾“ç±»å‹ï¼š

- **Stdio ä¼ è¾“**ï¼šå¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹å¹¶é€šè¿‡ stdin/stdout è¿›è¡Œé€šä¿¡
- **SSE ä¼ è¾“**ï¼šè¿æ¥åˆ° Server-Sent Events ç«¯ç‚¹
- **å¯æµå¼ HTTP ä¼ è¾“**ï¼šä½¿ç”¨ HTTP æµè¿›è¡Œé€šä¿¡

## å¦‚ä½•è®¾ç½®ä½ çš„ MCP æœåŠ¡å™¨

Qwen Code ä½¿ç”¨ `settings.json` æ–‡ä»¶ä¸­çš„ `mcpServers` é…ç½®æ¥å®šä½å¹¶è¿æ¥åˆ° MCP æœåŠ¡å™¨ã€‚æ­¤é…ç½®æ”¯æŒå¤šä¸ªä½¿ç”¨ä¸åŒä¼ è¾“æœºåˆ¶çš„æœåŠ¡å™¨ã€‚

### åœ¨ settings.json ä¸­é…ç½® MCP æœåŠ¡å™¨

ä½ å¯ä»¥åœ¨ `settings.json` æ–‡ä»¶ä¸­é€šè¿‡ä¸¤ç§ä¸»è¦æ–¹å¼é…ç½® MCP æœåŠ¡å™¨ï¼šé€šè¿‡é¡¶å±‚çš„ `mcpServers` å¯¹è±¡æ¥å®šä¹‰ç‰¹å®šçš„æœåŠ¡å™¨ï¼Œä»¥åŠé€šè¿‡ `mcp` å¯¹è±¡æ¥é…ç½®æ§åˆ¶æœåŠ¡å™¨å‘ç°å’Œæ‰§è¡Œçš„å…¨å±€è®¾ç½®ã€‚

#### å…¨å±€ MCP è®¾ç½® (`mcp`)

åœ¨ä½ çš„ `settings.json` ä¸­çš„ `mcp` å¯¹è±¡å…è®¸ä½ ä¸ºæ‰€æœ‰ MCP æœåŠ¡å™¨å®šä¹‰å…¨å±€è§„åˆ™ã€‚

- **`mcp.serverCommand`** (å­—ç¬¦ä¸²): å¯åŠ¨ MCP æœåŠ¡å™¨çš„å…¨å±€å‘½ä»¤ã€‚
- **`mcp.allowed`** (å­—ç¬¦ä¸²æ•°ç»„): å…è®¸çš„ MCP æœåŠ¡å™¨åç§°åˆ—è¡¨ã€‚å¦‚æœè®¾ç½®äº†æ­¤é¡¹ï¼Œåˆ™åªä¼šè¿æ¥æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡å™¨ï¼ˆä¸ `mcpServers` å¯¹è±¡ä¸­çš„é”®åŒ¹é…ï¼‰ã€‚
- **`mcp.excluded`** (å­—ç¬¦ä¸²æ•°ç»„): æ’é™¤çš„ MCP æœåŠ¡å™¨åç§°åˆ—è¡¨ã€‚æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡å™¨å°†ä¸ä¼šè¢«è¿æ¥ã€‚

**ç¤ºä¾‹ï¼š**

```json
{
  "mcp": {
    "allowed": ["my-trusted-server"],
    "excluded": ["experimental-server"]
  }
}
```

#### æœåŠ¡å™¨ç‰¹å®šé…ç½® (`mcpServers`)

`mcpServers` å¯¹è±¡ç”¨äºå®šä¹‰ CLI éœ€è¦è¿æ¥çš„æ¯ä¸ªç‹¬ç«‹ MCP æœåŠ¡å™¨ã€‚

### é…ç½®ç»“æ„

åœ¨ä½ çš„ `settings.json` æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª `mcpServers` å¯¹è±¡ï¼š

```json
{ ...æ–‡ä»¶åŒ…å«å…¶ä»–é…ç½®å¯¹è±¡
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### é…ç½®å±æ€§

æ¯ä¸ªæœåŠ¡å™¨é…ç½®æ”¯æŒä»¥ä¸‹å±æ€§ï¼š

#### å¿…éœ€ï¼ˆä»¥ä¸‹ä¹‹ä¸€ï¼‰

- **`command`** (string): ç”¨äº Stdio ä¼ è¾“çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
- **`url`** (string): SSE ç«¯ç‚¹ URLï¼ˆä¾‹å¦‚ï¼Œ`"http://localhost:8080/sse"`ï¼‰
- **`httpUrl`** (string): HTTP æµå¼ä¼ è¾“ç«¯ç‚¹ URL

#### å¯é€‰

- **`args`** (string[]): Stdio ä¼ è¾“çš„å‘½ä»¤è¡Œå‚æ•°
- **`headers`** (object): ä½¿ç”¨ `url` æˆ– `httpUrl` æ—¶çš„è‡ªå®šä¹‰ HTTP å¤´
- **`env`** (object): æœåŠ¡å™¨è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚å€¼å¯ä»¥ä½¿ç”¨ `$VAR_NAME` æˆ– `${VAR_NAME}` è¯­æ³•å¼•ç”¨ç¯å¢ƒå˜é‡
- **`cwd`** (string): Stdio ä¼ è¾“çš„å·¥ä½œç›®å½•
- **`timeout`** (number): è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤å€¼ï¼š600,000ms = 10 åˆ†é’Ÿï¼‰
- **`trust`** (boolean): å½“è®¾ç½®ä¸º `true` æ—¶ï¼Œå°†è·³è¿‡æ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤ï¼ˆé»˜è®¤å€¼ï¼š`false`ï¼‰
- **`includeTools`** (string[]): è¦ä»æ­¤ MCP æœåŠ¡å™¨åŒ…å«çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æŒ‡å®šåï¼Œä»…æ­¤å¤„åˆ—å‡ºçš„å·¥å…·å°†å¯ä»è¯¥æœåŠ¡å™¨ä½¿ç”¨ï¼ˆç™½åå•è¡Œä¸ºï¼‰ã€‚æœªæŒ‡å®šæ—¶ï¼Œé»˜è®¤å¯ç”¨æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å·¥å…·ã€‚
- **`excludeTools`** (string[]): è¦ä»æ­¤ MCP æœåŠ¡å™¨æ’é™¤çš„å·¥å…·åç§°åˆ—è¡¨ã€‚å³ä½¿æœåŠ¡å™¨æš´éœ²äº†è¿™äº›å·¥å…·ï¼Œæ¨¡å‹ä¹Ÿæ— æ³•ä½¿ç”¨å®ƒä»¬ã€‚**æ³¨æ„ï¼š** `excludeTools` çš„ä¼˜å…ˆçº§é«˜äº `includeTools` â€”â€” å¦‚æœæŸä¸ªå·¥å…·åŒæ—¶å‡ºç°åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­ï¼Œåˆ™ä¼šè¢«æ’é™¤ã€‚
- **`targetAudience`** (string): åœ¨ä½ å°è¯•è®¿é—®çš„å— IAP ä¿æŠ¤çš„åº”ç”¨ç¨‹åºä¸Šåˆ—å…¥ç™½åå•çš„ OAuth å®¢æˆ·ç«¯ IDã€‚ä¸ `authProviderType: 'service_account_impersonation'` ä¸€èµ·ä½¿ç”¨ã€‚
- **`targetServiceAccount`** (string): è¦æ¨¡æ‹Ÿçš„ Google Cloud æœåŠ¡è´¦æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ã€‚ä¸ `authProviderType: 'service_account_impersonation'` ä¸€èµ·ä½¿ç”¨ã€‚

### è¿œç¨‹ MCP æœåŠ¡å™¨çš„ OAuth æ”¯æŒ

Qwen Code æ”¯æŒé€šè¿‡ SSE æˆ– HTTP ä¼ è¾“æ–¹å¼å¯¹è¿œç¨‹ MCP æœåŠ¡å™¨è¿›è¡Œ OAuth 2.0 èº«ä»½éªŒè¯ã€‚è¿™ä½¿å¾—èƒ½å¤Ÿå®‰å…¨åœ°è®¿é—®éœ€è¦èº«ä»½éªŒè¯çš„ MCP æœåŠ¡å™¨ã€‚

#### è‡ªåŠ¨ OAuth å‘ç°

å¯¹äºæ”¯æŒ OAuth å‘ç°çš„æœåŠ¡å™¨ï¼Œä½ å¯ä»¥çœç•¥ OAuth é…ç½®ï¼Œè®© CLI è‡ªåŠ¨å‘ç°ï¼š

```json
{
  "mcpServers": {
    "discoveredServer": {
      "url": "https://api.example.com/sse"
    }
  }
}
```

CLI å°†è‡ªåŠ¨ï¼š

- æ£€æµ‹æœåŠ¡å™¨ä½•æ—¶éœ€è¦ OAuth èº«ä»½éªŒè¯ï¼ˆ401 å“åº”ï¼‰
- ä»æœåŠ¡å™¨å…ƒæ•°æ®ä¸­å‘ç° OAuth ç«¯ç‚¹
- å¦‚æœæ”¯æŒï¼Œæ‰§è¡ŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ
- å¤„ç† OAuth æµç¨‹å’Œä»¤ç‰Œç®¡ç†

#### è®¤è¯æµç¨‹

å½“è¿æ¥åˆ°å¯ç”¨ OAuth çš„æœåŠ¡å™¨æ—¶ï¼š

1. **åˆå§‹è¿æ¥å°è¯•** å¤±è´¥ï¼Œè¿”å› 401 æœªæˆæƒ
2. **OAuth å‘ç°** æ‰¾åˆ°æˆæƒå’Œä»¤ç‰Œç«¯ç‚¹
3. **æµè§ˆå™¨æ‰“å¼€** ä»¥è¿›è¡Œç”¨æˆ·è®¤è¯ï¼ˆéœ€è¦æœ¬åœ°æµè§ˆå™¨è®¿é—®æƒé™ï¼‰
4. **æˆæƒç ** è¢«äº¤æ¢ä¸ºè®¿é—®ä»¤ç‰Œ
5. **ä»¤ç‰Œè¢«å®‰å…¨å­˜å‚¨** ä»¥ä¾›å°†æ¥ä½¿ç”¨
6. **è¿æ¥é‡è¯•** ä½¿ç”¨æœ‰æ•ˆä»¤ç‰ŒæˆåŠŸ

#### æµè§ˆå™¨é‡å®šå‘è¦æ±‚

**é‡è¦ï¼š** OAuth è®¤è¯è¦æ±‚ä½ çš„æœ¬åœ°æœºå™¨èƒ½å¤Ÿï¼š

- æ‰“å¼€ç½‘é¡µæµè§ˆå™¨è¿›è¡Œè®¤è¯
- åœ¨ `http://localhost:7777/oauth/callback` ä¸Šæ¥æ”¶é‡å®šå‘

æ­¤åŠŸèƒ½å°†æ— æ³•åœ¨ä»¥ä¸‹ç¯å¢ƒä¸­å·¥ä½œï¼š

- æ²¡æœ‰æµè§ˆå™¨è®¿é—®æƒé™çš„æ— å¤´ç¯å¢ƒ
- æ²¡æœ‰ X11 è½¬å‘çš„è¿œç¨‹ SSH ä¼šè¯
- æ²¡æœ‰æµè§ˆå™¨æ”¯æŒçš„å®¹å™¨åŒ–ç¯å¢ƒ

#### ç®¡ç† OAuth è®¤è¯

ä½¿ç”¨ `/mcp auth` å‘½ä»¤æ¥ç®¡ç† OAuth è®¤è¯ï¼š

```bash

# åˆ—å‡ºéœ€è¦è®¤è¯çš„æœåŠ¡å™¨
/mcp auth
```

```markdown
# ä¸ç‰¹å®šæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName

# ä»¤ç‰Œè¿‡æœŸæ—¶é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName
```

#### OAuth é…ç½®å±æ€§

- **`enabled`** (boolean): ä¸ºæ­¤æœåŠ¡å™¨å¯ç”¨ OAuth
- **`clientId`** (string): OAuth å®¢æˆ·ç«¯æ ‡è¯†ç¬¦ï¼ˆä½¿ç”¨åŠ¨æ€æ³¨å†Œæ—¶ä¸ºå¯é€‰ï¼‰
- **`clientSecret`** (string): OAuth å®¢æˆ·ç«¯å¯†é’¥ï¼ˆå¯¹äºå…¬å…±å®¢æˆ·ç«¯ä¸ºå¯é€‰ï¼‰
- **`authorizationUrl`** (string): OAuth æˆæƒç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`tokenUrl`** (string): OAuth ä»¤ç‰Œç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`scopes`** (string[]): æ‰€éœ€çš„ OAuth èŒƒå›´
- **`redirectUri`** (string): è‡ªå®šä¹‰é‡å®šå‘ URIï¼ˆé»˜è®¤ä¸º `http://localhost:7777/oauth/callback`ï¼‰
- **`tokenParamName`** (string): SSE URL ä¸­ä»¤ç‰Œçš„æŸ¥è¯¢å‚æ•°åç§°
- **`audiences`** (string[]): ä»¤ç‰Œæœ‰æ•ˆçš„å—ä¼—åˆ—è¡¨

#### ä»¤ç‰Œç®¡ç†

OAuth ä»¤ç‰Œä¼šè‡ªåŠ¨ï¼š

- **å®‰å…¨å­˜å‚¨** åœ¨ `~/.qwen/mcp-oauth-tokens.json` ä¸­
- **è‡ªåŠ¨åˆ·æ–°** è¿‡æœŸæ—¶ï¼ˆå¦‚æœæœ‰åˆ·æ–°ä»¤ç‰Œï¼‰
- **è¿æ¥å‰éªŒè¯** æ¯æ¬¡è¿æ¥å°è¯•å‰
- **æ¸…ç†æ— æ•ˆæˆ–è¿‡æœŸä»¤ç‰Œ**

#### èº«ä»½éªŒè¯æä¾›ç¨‹åºç±»å‹

ä½ å¯ä»¥ä½¿ç”¨ `authProviderType` å±æ€§æŒ‡å®šèº«ä»½éªŒè¯æä¾›ç¨‹åºç±»å‹ï¼š

- **`authProviderType`**ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šæŒ‡å®šèº«ä»½éªŒè¯æä¾›ç¨‹åºã€‚å¯ä»¥æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€ï¼š
  - **`dynamic_discovery`**ï¼ˆé»˜è®¤ï¼‰ï¼šCLI å°†è‡ªåŠ¨ä»æœåŠ¡å™¨å‘ç° OAuth é…ç½®ã€‚
  - **`google_credentials`**ï¼šCLI å°†ä½¿ç”¨ Google åº”ç”¨é»˜è®¤å‡­æ®ï¼ˆADCï¼‰å‘æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚ä½¿ç”¨æ­¤æä¾›ç¨‹åºæ—¶ï¼Œä½ å¿…é¡»æŒ‡å®šæ‰€éœ€çš„èŒƒå›´ã€‚
  - **`service_account_impersonation`**ï¼šCLI å°†æ¨¡æ‹Ÿ Google Cloud æœåŠ¡è´¦å·å‘æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¿™å¯¹äºè®¿é—®å— IAP ä¿æŠ¤çš„æœåŠ¡éå¸¸æœ‰ç”¨ï¼ˆè¿™æ˜¯ä¸“é—¨ä¸º Cloud Run æœåŠ¡è®¾è®¡çš„ï¼‰ã€‚

#### Google å‡­æ®

```json
{
  "mcpServers": {
    "googleCloudServer": {
      "httpUrl": "https://my-gcp-service.run.app/mcp",
      "authProviderType": "google_credentials",
      "oauth": {
        "scopes": ["https://www.googleapis.com/auth/userinfo.email"]
      }
    }
  }
}
```

#### æœåŠ¡è´¦æˆ·æ¨¡æ‹Ÿ

è¦ä½¿ç”¨æœåŠ¡è´¦æˆ·æ¨¡æ‹Ÿå‘æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä½ å¿…é¡»å°† `authProviderType` è®¾ç½®ä¸º `service_account_impersonation` å¹¶æä¾›ä»¥ä¸‹å±æ€§ï¼š

- **`targetAudience`**ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šåœ¨ä½ å°è¯•è®¿é—®çš„å— IAP ä¿æŠ¤çš„åº”ç”¨ç¨‹åºä¸Šå…è®¸åˆ—å‡ºçš„ OAuth å®¢æˆ·ç«¯ IDã€‚
- **`targetServiceAccount`**ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šè¦æ¨¡æ‹Ÿçš„ Google Cloud æœåŠ¡è´¦æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ã€‚

CLI å°†ä½¿ç”¨ä½ æœ¬åœ°çš„ Application Default Credentials (ADC) ä¸ºæŒ‡å®šçš„æœåŠ¡è´¦æˆ·å’Œå—ä¼—ç”Ÿæˆä¸€ä¸ª OIDC ID ä»¤ç‰Œã€‚ç„¶åè¯¥ä»¤ç‰Œå°†ç”¨äºä¸ MCP æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚

#### è®¾ç½®è¯´æ˜

1. **[åˆ›å»º](https://cloud.google.com/iap/docs/oauth-client-creation) æˆ–ä½¿ç”¨ç°æœ‰çš„ OAuth 2.0 å®¢æˆ·ç«¯ IDã€‚** è¦ä½¿ç”¨ç°æœ‰çš„ OAuth 2.0 å®¢æˆ·ç«¯ IDï¼Œè¯·æŒ‰ç…§ [å¦‚ä½•å…±äº« OAuth å®¢æˆ·ç«¯](https://cloud.google.com/iap/docs/sharing-oauth-clients) ä¸­çš„æ­¥éª¤æ“ä½œã€‚
2. **å°† OAuth ID æ·»åŠ åˆ°åº”ç”¨ç¨‹åºçš„[ç¨‹åºåŒ–è®¿é—®](https://cloud.google.com/iap/docs/sharing-oauth-clients#programmatic_access)å…è®¸åˆ—è¡¨ä¸­ã€‚** ç”±äº Cloud Run å°šæœªæˆä¸º gcloud iap ä¸­æ”¯æŒçš„èµ„æºç±»å‹ï¼Œä½ å¿…é¡»åœ¨é¡¹ç›®çº§åˆ«å°†å®¢æˆ·ç«¯ ID åŠ å…¥å…è®¸åˆ—è¡¨ã€‚
3. **åˆ›å»ºæœåŠ¡è´¦å·ã€‚** [æ–‡æ¡£](https://cloud.google.com/iam/docs/service-accounts-create#creating)ï¼Œ[Cloud Console é“¾æ¥](https://console.cloud.google.com/iam-admin/serviceaccounts)
4. **å°†æœåŠ¡è´¦å·å’Œç”¨æˆ·æ·»åŠ åˆ° IAP ç­–ç•¥ä¸­**ï¼Œå¯ä»¥åœ¨ Cloud Run æœåŠ¡æœ¬èº«çš„â€œå®‰å…¨â€æ ‡ç­¾é¡µä¸­æ“ä½œï¼Œæˆ–é€šè¿‡ gcloud å‘½ä»¤è¡Œå·¥å…·å®Œæˆã€‚
5. **ä¸ºæ‰€æœ‰å°†è¦è®¿é—® MCP Server çš„ç”¨æˆ·å’Œç»„** æˆäºˆ [æ¨¡æ‹ŸæœåŠ¡è´¦å·](https://cloud.google.com/docs/authentication/use-service-account-impersonation) æ‰€éœ€çš„æƒé™ï¼ˆå³ `roles/iam.serviceAccountTokenCreator`ï¼‰ã€‚
6. **ä¸ºä½ çš„é¡¹ç›®[å¯ç”¨](https://console.cloud.google.com/apis/library/iamcredentials.googleapis.com) IAM å‡­æ® API**ã€‚

### ç¤ºä¾‹é…ç½®

#### Python MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

#### Node.js MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

#### åŸºäº Docker çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

#### åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

#### å¸¦è‡ªå®šä¹‰è¯·æ±‚å¤´çš„åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServerWithAuth": {
      "httpUrl": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer your-api-token",
        "X-Custom-Header": "custom-value",
        "Content-Type": "application/json"
      },
      "timeout": 5000
    }
  }
}
```

#### å¸¦å·¥å…·è¿‡æ»¤çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "filteredServer": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "includeTools": ["safe_tool", "file_reader", "data_processor"],
      // "excludeTools": ["dangerous_tool", "file_deleter"],
      "timeout": 30000
    }
  }
}
```

### å¸¦æœåŠ¡è´¦å·æ¨¡æ‹Ÿçš„ SSE MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "myIapProtectedServer": {
      "url": "https://my-iap-service.run.app/sse",
      "authProviderType": "service_account_impersonation",
      "targetAudience": "YOUR_IAP_CLIENT_ID.apps.googleusercontent.com",
      "targetServiceAccount": "your-sa@your-project.iam.gserviceaccount.com"
    }
  }
}
```

## å‘ç°è¿‡ç¨‹æ·±å…¥è§£æ

å½“ Qwen Code å¯åŠ¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡ä»¥ä¸‹è¯¦ç»†è¿‡ç¨‹æ‰§è¡Œ MCP æœåŠ¡å™¨å‘ç°ï¼š

### 1. æœåŠ¡å™¨è¿­ä»£ä¸è¿æ¥

å¯¹äº `mcpServers` ä¸­é…ç½®çš„æ¯ä¸ªæœåŠ¡å™¨ï¼š

1. **çŠ¶æ€è·Ÿè¸ªå¼€å§‹ï¼š** æœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `CONNECTING`
2. **ä¼ è¾“æ–¹å¼é€‰æ‹©ï¼š** æ ¹æ®é…ç½®å±æ€§ï¼š
   - `httpUrl` â†’ `StreamableHTTPClientTransport`
   - `url` â†’ `SSEClientTransport`
   - `command` â†’ `StdioClientTransport`
3. **å»ºç«‹è¿æ¥ï¼š** MCP å®¢æˆ·ç«¯å°è¯•åœ¨é…ç½®çš„è¶…æ—¶æ—¶é—´å†…è¿æ¥
4. **é”™è¯¯å¤„ç†ï¼š** è¿æ¥å¤±è´¥ä¼šè¢«è®°å½•æ—¥å¿—ï¼Œå¹¶å°†æœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `DISCONNECTED`

### 2. å·¥å…·å‘ç°

è¿æ¥æˆåŠŸåï¼š

1. **å·¥å…·åˆ—è¡¨è·å–ï¼š** å®¢æˆ·ç«¯è°ƒç”¨ MCP æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨ç«¯ç‚¹
2. **æ¨¡å¼éªŒè¯ï¼š** éªŒè¯æ¯ä¸ªå·¥å…·çš„å‡½æ•°å£°æ˜
3. **å·¥å…·è¿‡æ»¤ï¼š** æ ¹æ® `includeTools` å’Œ `excludeTools` é…ç½®å¯¹å·¥å…·è¿›è¡Œè¿‡æ»¤
4. **åç§°æ¸…ç†ï¼š** æ¸…ç†å·¥å…·åç§°ä»¥æ»¡è¶³ Qwen API è¦æ±‚ï¼š
   - å°†æ— æ•ˆå­—ç¬¦ï¼ˆéå­—æ¯æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹å·ã€è¿å­—ç¬¦ï¼‰æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
   - åç§°è¶…è¿‡ 63 ä¸ªå­—ç¬¦æ—¶ï¼Œå°†ä¸­é—´éƒ¨åˆ†æ›¿æ¢ä¸º (`___`) è¿›è¡Œæˆªæ–­

### 3. å†²çªè§£å†³

å½“å¤šä¸ªæœåŠ¡å™¨æš´éœ²åŒåå·¥å…·æ—¶ï¼š

1. **é¦–æ¬¡æ³¨å†Œä¼˜å…ˆï¼š** ç¬¬ä¸€ä¸ªæ³¨å†Œè¯¥å·¥å…·åç§°çš„æœåŠ¡å™¨è·å¾—æ— å‰ç¼€çš„åç§°
2. **è‡ªåŠ¨æ·»åŠ å‰ç¼€ï¼š** åç»­æœåŠ¡å™¨çš„å·¥å…·åç§°ä¼šè¢«åŠ ä¸Šå‰ç¼€ï¼š`serverName__toolName`
3. **æ³¨å†Œè¡¨è·Ÿè¸ªï¼š** å·¥å…·æ³¨å†Œè¡¨ç»´æŠ¤æœåŠ¡å™¨åç§°ä¸å…¶å·¥å…·ä¹‹é—´çš„æ˜ å°„å…³ç³»

### 4. Schema å¤„ç†

å·¥å…·å‚æ•° schema ä¼šç»è¿‡æ¸…ç†ä»¥ç¡®ä¿ API å…¼å®¹æ€§ï¼š

- **`$schema` å±æ€§** ä¼šè¢«ç§»é™¤
- **`additionalProperties`** ä¼šè¢«å‰¥ç¦»
- **å¸¦æœ‰ `default` çš„ `anyOf`** ä¼šç§»é™¤å…¶é»˜è®¤å€¼ï¼ˆå…¼å®¹ Vertex AIï¼‰
- **é€’å½’å¤„ç†** ä¼šåº”ç”¨åˆ°åµŒå¥—çš„ schema

### 5. è¿æ¥ç®¡ç†

å‘ç°å®Œæˆåï¼š

- **æŒä¹…è¿æ¥ï¼š** æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨å°†ä¿æŒå…¶è¿æ¥
- **æ¸…ç†ï¼š** å¯¹äºæœªæä¾›å¯ç”¨å·¥å…·çš„æœåŠ¡å™¨ï¼Œå…¶è¿æ¥å°†è¢«å…³é—­
- **çŠ¶æ€æ›´æ–°ï¼š** æœ€ç»ˆæœåŠ¡å™¨çŠ¶æ€å°†è®¾ç½®ä¸º `CONNECTED` æˆ– `DISCONNECTED`

## å·¥å…·æ‰§è¡Œæµç¨‹

å½“æ¨¡å‹å†³å®šä½¿ç”¨æŸä¸ª MCP å·¥å…·æ—¶ï¼Œå°†æŒ‰ä»¥ä¸‹æµç¨‹æ‰§è¡Œï¼š

### 1. å·¥å…·è°ƒç”¨

æ¨¡å‹ç”Ÿæˆä¸€ä¸ª `FunctionCall`ï¼ŒåŒ…å«ï¼š

- **å·¥å…·åç§°ï¼š** æ³¨å†Œæ—¶çš„åç§°ï¼ˆå¯èƒ½å¸¦å‰ç¼€ï¼‰
- **å‚æ•°ï¼š** ç¬¦åˆå·¥å…·å‚æ•° schema çš„ JSON å¯¹è±¡

### 2. ç¡®è®¤æµç¨‹

æ¯ä¸ª `DiscoveredMCPTool` éƒ½å®ç°äº†å¤æ‚çš„ç¡®è®¤é€»è¾‘ï¼š

#### åŸºäºä¿¡ä»»çš„è·³è¿‡æœºåˆ¶

```typescript
if (this.trust) {
  return false; // æ— éœ€ç¡®è®¤
}
```

#### åŠ¨æ€ç™½åå•æœºåˆ¶

ç³»ç»Ÿç»´æŠ¤ä»¥ä¸‹å†…éƒ¨ç™½åå•ï¼š

- **æœåŠ¡å™¨çº§åˆ«ï¼š** `serverName` â†’ æ¥è‡ªæ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·å‡å—ä¿¡ä»»
- **å·¥å…·çº§åˆ«ï¼š** `serverName.toolName` â†’ æ­¤ç‰¹å®šå·¥å…·å—ä¿¡ä»»

#### ç”¨æˆ·é€‰æ‹©å¤„ç†

å½“éœ€è¦ç¡®è®¤æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š

- **ä»…æœ¬æ¬¡æ‰§è¡Œï¼š** ä»…æ­¤æ¬¡æ‰§è¡Œ
- **å§‹ç»ˆå…è®¸æ­¤å·¥å…·ï¼š** æ·»åŠ åˆ°å·¥å…·çº§åˆ«çš„ç™½åå•ä¸­
- **å§‹ç»ˆå…è®¸æ­¤æœåŠ¡å™¨ï¼š** æ·»åŠ åˆ°æœåŠ¡å™¨çº§åˆ«çš„ç™½åå•ä¸­
- **å–æ¶ˆï¼š** ä¸­æ­¢æ‰§è¡Œ

### 3. æ‰§è¡Œ

ç¡®è®¤åï¼ˆæˆ–ç»•è¿‡ä¿¡ä»»ï¼‰ï¼š

1. **å‚æ•°å‡†å¤‡ï¼š** å‚æ•°æ ¹æ®å·¥å…·çš„ schema è¿›è¡ŒéªŒè¯
2. **MCP è°ƒç”¨ï¼š** åº•å±‚ `CallableTool` ä½¿ç”¨ä»¥ä¸‹å†…å®¹è°ƒç”¨æœåŠ¡å™¨ï¼š

   ```typescript
   const functionCalls = [
     {
       name: this.serverToolName, // åŸå§‹æœåŠ¡å™¨å·¥å…·åç§°
       args: params,
     },
   ];
   ```

3. **å“åº”å¤„ç†ï¼š** ç»“æœä¼šè¢«æ ¼å¼åŒ–ï¼Œæ—¢ç”¨äº LLM ä¸Šä¸‹æ–‡ä¹Ÿç”¨äºç”¨æˆ·å±•ç¤º

### 4. å“åº”å¤„ç†

æ‰§è¡Œç»“æœåŒ…å«ï¼š

- **`llmContent`ï¼š** ä¾›è¯­è¨€æ¨¡å‹ä¸Šä¸‹æ–‡ä½¿ç”¨çš„åŸå§‹å“åº”éƒ¨åˆ†
- **`returnDisplay`ï¼š** ä¾›ç”¨æˆ·å±•ç¤ºçš„æ ¼å¼åŒ–è¾“å‡ºï¼ˆé€šå¸¸ä¸º Markdown ä»£ç å—ä¸­çš„ JSONï¼‰

## å¦‚ä½•ä¸ä½ çš„ MCP æœåŠ¡å™¨äº¤äº’

### ä½¿ç”¨ `/mcp` å‘½ä»¤

`/mcp` å‘½ä»¤æä¾›å…³äºä½ çš„ MCP æœåŠ¡å™¨è®¾ç½®çš„å…¨é¢ä¿¡æ¯ï¼š

```bash
/mcp
```

è¯¥å‘½ä»¤æ˜¾ç¤ºä»¥ä¸‹å†…å®¹ï¼š

- **æœåŠ¡å™¨åˆ—è¡¨ï¼š** æ‰€æœ‰å·²é…ç½®çš„ MCP æœåŠ¡å™¨
- **è¿æ¥çŠ¶æ€ï¼š** `CONNECTED`ã€`CONNECTING` æˆ– `DISCONNECTED`
- **æœåŠ¡å™¨è¯¦æƒ…ï¼š** é…ç½®æ‘˜è¦ï¼ˆä¸åŒ…å«æ•æ„Ÿæ•°æ®ï¼‰
- **å¯ç”¨å·¥å…·ï¼š** æ¯ä¸ªæœåŠ¡å™¨æä¾›çš„å·¥å…·åˆ—è¡¨åŠå…¶æè¿°
- **å‘ç°çŠ¶æ€ï¼š** æ•´ä½“å‘ç°è¿‡ç¨‹çš„çŠ¶æ€

### ç¤ºä¾‹ `/mcp` è¾“å‡º

```
MCP æœåŠ¡å™¨çŠ¶æ€ï¼š

ğŸ“¡ pythonTools (CONNECTED)
  å‘½ä»¤: python -m my_mcp_server --port 8080
  å·¥ä½œç›®å½•: ./mcp-servers/python
  è¶…æ—¶æ—¶é—´: 15000ms
  å·¥å…·: calculate_sum, file_analyzer, data_processor

ğŸ”Œ nodeServer (DISCONNECTED)
  å‘½ä»¤: node dist/server.js --verbose
  é”™è¯¯: è¿æ¥è¢«æ‹’ç»

.dockerizedServer (CONNECTED)
  å‘½ä»¤: docker run -i --rm -e API_KEY my-mcp-server:latest
  å·¥å…·: docker__deploy, docker__status

å‘ç°çŠ¶æ€: COMPLETED
```

### å·¥å…·ä½¿ç”¨

ä¸€æ—¦è¢«å‘ç°ï¼ŒMCP å·¥å…·å°±ä¼šåƒå†…ç½®å·¥å…·ä¸€æ ·æä¾›ç»™ Qwen æ¨¡å‹ä½¿ç”¨ã€‚æ¨¡å‹å°†è‡ªåŠ¨ï¼š

1. **æ ¹æ®ä½ çš„è¯·æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·**
2. **æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†**ï¼ˆé™¤éæœåŠ¡å™¨æ˜¯å—ä¿¡ä»»çš„ï¼‰
3. **ä½¿ç”¨æ­£ç¡®çš„å‚æ•°æ‰§è¡Œå·¥å…·**
4. **ä»¥ç”¨æˆ·å‹å¥½çš„æ ¼å¼æ˜¾ç¤ºç»“æœ**

## çŠ¶æ€ç›‘æ§å’Œæ•…éšœæ’é™¤

### è¿æ¥çŠ¶æ€

MCP é›†æˆä¼šè·Ÿè¸ªä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š

#### æœåŠ¡å™¨çŠ¶æ€ (`MCPServerStatus`)

- **`DISCONNECTED`:** æœåŠ¡å™¨æœªè¿æ¥æˆ–å‡ºç°é”™è¯¯
- **`CONNECTING`:** æ­£åœ¨å°è¯•è¿æ¥
- **`CONNECTED`:** æœåŠ¡å™¨å·²è¿æ¥å¹¶å‡†å¤‡å°±ç»ª

#### å‘ç°é˜¶æ®µ (`MCPDiscoveryState`)

- **`NOT_STARTED`:** å°šæœªå¼€å§‹å‘ç°
- **`IN_PROGRESS`:** æ­£åœ¨å‘ç°æœåŠ¡å™¨
- **`COMPLETED`:** å‘ç°å·²å®Œæˆï¼ˆæ— è®ºæ˜¯å¦æœ‰é”™è¯¯ï¼‰

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### æœåŠ¡å™¨æ— æ³•è¿æ¥

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨æ˜¾ç¤º `DISCONNECTED` çŠ¶æ€

**æ•…éšœæ’æŸ¥ï¼š**

1. **æ£€æŸ¥é…ç½®ï¼š** éªŒè¯ `command`ã€`args` å’Œ `cwd` æ˜¯å¦æ­£ç¡®
2. **æ‰‹åŠ¨æµ‹è¯•ï¼š** ç›´æ¥è¿è¡ŒæœåŠ¡å™¨å‘½ä»¤ä»¥ç¡®ä¿å…¶æ­£å¸¸å·¥ä½œ
3. **æ£€æŸ¥ä¾èµ–é¡¹ï¼š** ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„åŒ…éƒ½å·²å®‰è£…
4. **æŸ¥çœ‹æ—¥å¿—ï¼š** åœ¨ CLI è¾“å‡ºä¸­æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯
5. **éªŒè¯æƒé™ï¼š** ç¡®ä¿ CLI å¯ä»¥æ‰§è¡ŒæœåŠ¡å™¨å‘½ä»¤

#### æœªå‘ç°å·¥å…·

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨è¿æ¥æˆåŠŸä½†æ²¡æœ‰å¯ç”¨å·¥å…·

**æ•…éšœæ’æŸ¥ï¼š**

1. **éªŒè¯å·¥å…·æ³¨å†Œï¼š** ç¡®ä¿ä½ çš„æœåŠ¡å™¨å®é™…æ³¨å†Œäº†å·¥å…·
2. **æ£€æŸ¥ MCP åè®®ï¼š** ç¡®è®¤ä½ çš„æœåŠ¡å™¨æ­£ç¡®å®ç°äº† MCP å·¥å…·åˆ—è¡¨
3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š** æ£€æŸ¥ stderr è¾“å‡ºä»¥æŸ¥æ‰¾æœåŠ¡å™¨ç«¯é”™è¯¯
4. **æµ‹è¯•å·¥å…·åˆ—è¡¨ï¼š** æ‰‹åŠ¨æµ‹è¯•æœåŠ¡å™¨çš„å·¥å…·å‘ç°ç«¯ç‚¹

#### å·¥å…·æ— æ³•æ‰§è¡Œ

**ç—‡çŠ¶ï¼š** å·¥å…·è¢«å‘ç°ä½†åœ¨æ‰§è¡ŒæœŸé—´å¤±è´¥

**æ•…éšœæ’é™¤ï¼š**

1. **å‚æ•°éªŒè¯ï¼š** ç¡®ä¿ä½ çš„å·¥å…·æ¥å—é¢„æœŸçš„å‚æ•°
2. **æ¨¡å¼å…¼å®¹æ€§ï¼š** éªŒè¯ä½ çš„è¾“å…¥æ¨¡å¼æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON Schema
3. **é”™è¯¯å¤„ç†ï¼š** æ£€æŸ¥ä½ çš„å·¥å…·æ˜¯å¦æŠ›å‡ºäº†æœªå¤„ç†çš„å¼‚å¸¸
4. **è¶…æ—¶é—®é¢˜ï¼š** è€ƒè™‘å¢åŠ  `timeout` è®¾ç½®

#### æ²™ç®±å…¼å®¹æ€§

**ç—‡çŠ¶ï¼š** å¯ç”¨æ²™ç®±æ—¶ MCP æœåŠ¡å™¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**

1. **åŸºäº Docker çš„æœåŠ¡å™¨ï¼š** ä½¿ç”¨åŒ…å«æ‰€æœ‰ä¾èµ–é¡¹çš„ Docker å®¹å™¨
2. **è·¯å¾„å¯è®¿é—®æ€§ï¼š** ç¡®ä¿æœåŠ¡å™¨å¯æ‰§è¡Œæ–‡ä»¶åœ¨æ²™ç®±ä¸­å¯ç”¨
3. **ç½‘ç»œè®¿é—®ï¼š** é…ç½®æ²™ç®±ä»¥å…è®¸å¿…è¦çš„ç½‘ç»œè¿æ¥
4. **ç¯å¢ƒå˜é‡ï¼š** éªŒè¯æ‰€éœ€çš„ç¯å¢ƒå˜é‡æ˜¯å¦å·²ä¼ é€’

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š** ä½¿ç”¨ `--debug` å‚æ•°è¿è¡Œ CLI ä»¥è·å–è¯¦ç»†è¾“å‡º
2. **æ£€æŸ¥ stderrï¼š** MCP æœåŠ¡å™¨çš„ stderr è¾“å‡ºä¼šè¢«æ•è·å¹¶è®°å½•ï¼ˆINFO çº§åˆ«æ¶ˆæ¯å·²è¢«è¿‡æ»¤ï¼‰
3. **ç‹¬ç«‹æµ‹è¯•ï¼š** åœ¨é›†æˆä¹‹å‰ï¼Œå…ˆç‹¬ç«‹æµ‹è¯•ä½ çš„ MCP æœåŠ¡å™¨
4. **å¢é‡è®¾ç½®ï¼š** å…ˆä»ç®€å•å·¥å…·å¼€å§‹ï¼Œå†é€æ­¥æ·»åŠ å¤æ‚åŠŸèƒ½
5. **é¢‘ç¹ä½¿ç”¨ `/mcp`ï¼š** åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç›‘æ§æœåŠ¡å™¨çŠ¶æ€

## é‡è¦è¯´æ˜

### å®‰å…¨æ³¨æ„äº‹é¡¹

- **ä¿¡ä»»è®¾ç½®ï¼š** `trust` é€‰é¡¹ä¼šè·³è¿‡æ‰€æœ‰ç¡®è®¤å¯¹è¯æ¡†ã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œä»…ç”¨äºä½ å®Œå…¨æ§åˆ¶çš„æœåŠ¡å™¨
- **è®¿é—®ä»¤ç‰Œï¼š** é…ç½®åŒ…å« API å¯†é’¥æˆ–ä»¤ç‰Œçš„ç¯å¢ƒå˜é‡æ—¶ï¼Œè¯·æ³¨æ„å®‰å…¨é£é™©
- **æ²™ç›’å…¼å®¹æ€§ï¼š** ä½¿ç”¨æ²™ç›’æ—¶ï¼Œç¡®ä¿ MCP æœåŠ¡å™¨åœ¨æ²™ç›’ç¯å¢ƒä¸­å¯ç”¨
- **ç§æœ‰æ•°æ®ï¼š** ä½¿ç”¨èŒƒå›´è¿‡å¹¿çš„ä¸ªäººè®¿é—®ä»¤ç‰Œå¯èƒ½å¯¼è‡´ä»“åº“é—´ä¿¡æ¯æ³„éœ²

### æ€§èƒ½ä¸èµ„æºç®¡ç†

- **è¿æ¥æŒä¹…åŒ–ï¼š** CLI ä¼šä¸æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨ä¿æŒæŒä¹…è¿æ¥
- **è‡ªåŠ¨æ¸…ç†ï¼š** è‡ªåŠ¨å…³é—­æœªæä¾›ä»»ä½•å·¥å…·çš„æœåŠ¡å™¨è¿æ¥
- **è¶…æ—¶ç®¡ç†ï¼š** æ ¹æ®æœåŠ¡å™¨å“åº”ç‰¹æ€§é…ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
- **èµ„æºç›‘æ§ï¼š** MCP æœåŠ¡å™¨ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼Œä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æº

### Schema å…¼å®¹æ€§

- **å±æ€§å‰¥ç¦»ï¼š** ç³»ç»Ÿä¼šè‡ªåŠ¨ç§»é™¤æŸäº› Schema å±æ€§ï¼ˆå¦‚ `$schema`ã€`additionalProperties`ï¼‰ä»¥ç¡®ä¿ä¸ Qwen API çš„å…¼å®¹æ€§
- **åç§°æ¸…ç†ï¼š** å·¥å…·åç§°ä¼šè¢«è‡ªåŠ¨æ¸…ç†ä»¥æ»¡è¶³ API è¦æ±‚
- **å†²çªè§£å†³ï¼š** ä¸åŒæœåŠ¡å™¨ä¹‹é—´çš„å·¥å…·åç§°å†²çªå°†é€šè¿‡è‡ªåŠ¨æ·»åŠ å‰ç¼€çš„æ–¹å¼è§£å†³

è¿™ç§å…¨é¢çš„é›†æˆä½¿ MCP æœåŠ¡å™¨æˆä¸ºæ‰©å±• CLI åŠŸèƒ½çš„å¼ºå¤§æ–¹å¼ï¼ŒåŒæ—¶å…¼é¡¾å®‰å…¨æ€§ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## ä»å·¥å…·è¿”å›ä¸°å¯Œå†…å®¹

MCP å·¥å…·ä¸ä»…é™äºè¿”å›ç®€å•çš„æ–‡æœ¬ã€‚ä½ å¯ä»¥è¿”å›ä¸°å¯Œçš„å¤šéƒ¨åˆ†çš„å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘å’Œå…¶ä»–äºŒè¿›åˆ¶æ•°æ®ï¼Œæ‰€æœ‰è¿™äº›éƒ½å¯ä»¥åœ¨å•ä¸ªå·¥å…·å“åº”ä¸­å®Œæˆã€‚è¿™ä½¿ä½ èƒ½å¤Ÿæ„å»ºå¼ºå¤§çš„å·¥å…·ï¼Œåœ¨ä¸€æ¬¡äº¤äº’ä¸­ä¸ºæ¨¡å‹æä¾›å¤šæ ·åŒ–çš„ä¿¡æ¯ã€‚

ä»å·¥å…·è¿”å›çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè¢«å¤„ç†å¹¶ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ç»™æ¨¡å‹ï¼Œä»¥ä¾›å…¶ä¸‹ä¸€æ¬¡ç”Ÿæˆä½¿ç”¨ï¼Œä»è€Œä½¿æ¨¡å‹èƒ½å¤Ÿå¯¹æä¾›çš„ä¿¡æ¯è¿›è¡Œæ¨ç†æˆ–æ€»ç»“ã€‚

### å·¥ä½œåŸç†

è¦è¿”å›å¯Œå†…å®¹ï¼Œä½ çš„å·¥å…·å“åº”å¿…é¡»éµå¾ª MCP è§„èŒƒä¸­å¯¹ [`CallToolResult`](https://modelcontextprotocol.io/specification/2025-06-18/server/tools#tool-result) çš„å®šä¹‰ã€‚ç»“æœçš„ `content` å­—æ®µåº”ä¸ºä¸€ä¸ª `ContentBlock` å¯¹è±¡æ•°ç»„ã€‚CLI ä¼šæ­£ç¡®å¤„ç†è¯¥æ•°ç»„ï¼Œå°†æ–‡æœ¬ä¸äºŒè¿›åˆ¶æ•°æ®åˆ†ç¦»ï¼Œå¹¶æ‰“åŒ…ä¼ é€’ç»™æ¨¡å‹ã€‚

ä½ å¯ä»¥åœ¨ `content` æ•°ç»„ä¸­æ··åˆä½¿ç”¨ä¸åŒç±»å‹çš„ content blockã€‚æ”¯æŒçš„ block ç±»å‹åŒ…æ‹¬ï¼š

- `text`
- `image`
- `audio`
- `resource`ï¼ˆåµŒå…¥å†…å®¹ï¼‰
- `resource_link`

### ç¤ºä¾‹ï¼šè¿”å›æ–‡æœ¬å’Œå›¾åƒ

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ MCP å·¥å…· JSON å“åº”ç¤ºä¾‹ï¼Œè¯¥å“åº”åŒæ—¶è¿”å›æ–‡æœ¬æè¿°å’Œå›¾åƒï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "Here is the logo you requested."
    },
    {
      "type": "image",
      "data": "BASE64_ENCODED_IMAGE_DATA_HERE",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "The logo was created in 2025."
    }
  ]
}
```

å½“ Qwen Code æ¥æ”¶åˆ°æ­¤å“åº”æ—¶ï¼Œå®ƒå°†ï¼š

1. æå–æ‰€æœ‰æ–‡æœ¬å¹¶å°†å…¶åˆå¹¶ä¸ºå•ä¸ª `functionResponse` éƒ¨åˆ†ä»¥ä¾›æ¨¡å‹ä½¿ç”¨ã€‚
2. å°†å›¾åƒæ•°æ®ä½œä¸ºå•ç‹¬çš„ `inlineData` éƒ¨åˆ†å‘ˆç°ã€‚
3. åœ¨ CLI ä¸­æä¾›æ¸…æ™°ã€ç”¨æˆ·å‹å¥½çš„æ‘˜è¦ï¼Œè¡¨æ˜å·²æ¥æ”¶åˆ°æ–‡æœ¬å’Œå›¾åƒã€‚

è¿™ä½¿æ‚¨èƒ½å¤Ÿæ„å»ºå¤æ‚çš„å·¥å…·ï¼Œä»è€Œå‘ Qwen æ¨¡å‹æä¾›ä¸°å¯Œçš„å¤šæ¨¡æ€ä¸Šä¸‹æ–‡ã€‚

## MCP æç¤ºè¯ä½œä¸ºæ–œæ å‘½ä»¤

é™¤äº†å·¥å…·ä¹‹å¤–ï¼ŒMCP æœåŠ¡å™¨è¿˜å¯ä»¥æš´éœ²é¢„å®šä¹‰çš„æç¤ºè¯ï¼Œè¿™äº›æç¤ºè¯å¯ä»¥ä½œä¸ºæ–œæ å‘½ä»¤åœ¨ Qwen Code ä¸­æ‰§è¡Œã€‚è¿™ä½¿ä½ èƒ½å¤Ÿä¸ºå¸¸è§æˆ–å¤æ‚çš„æŸ¥è¯¢åˆ›å»ºå¿«æ·æ–¹å¼ï¼Œé€šè¿‡åç§°å³å¯è½»æ¾è°ƒç”¨ã€‚

### åœ¨æœåŠ¡å™¨ä¸Šå®šä¹‰æç¤º

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®šä¹‰äº†æç¤ºçš„å°å‹ stdio MCP æœåŠ¡å™¨ç¤ºä¾‹ï¼š

```ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

const server = new McpServer({
  name: 'prompt-server',
  version: '1.0.0',
});

server.registerPrompt(
  'poem-writer',
  {
    title: 'Poem Writer',
    description: 'Write a nice haiku',
    argsSchema: { title: z.string(), mood: z.string().optional() },
  },
  ({ title, mood }) => ({
    messages: [
      {
        role: 'user',
        content: {
          type: 'text',
          text: `Write a haiku${mood ? ` with the mood ${mood}` : ''} called ${title}. Note that a haiku is 5 syllables followed by 7 syllables followed by 5 syllables `,
        },
      },
    ],
  }),
);

const transport = new StdioServerTransport();
await server.connect(transport);
```

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å°†å…¶åŒ…å«åœ¨ `settings.json` çš„ `mcpServers` ä¸­ï¼š

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["filename.ts"]
    }
  }
}
```

### è°ƒç”¨æç¤º

ä¸€æ—¦å‘ç°æŸä¸ªæç¤ºï¼Œä½ å¯ä»¥é€šè¿‡å…¶åç§°ä½œä¸ºæ–œæ å‘½ä»¤æ¥è°ƒç”¨å®ƒã€‚CLI ä¼šè‡ªåŠ¨å¤„ç†å‚æ•°è§£æã€‚

```bash
/poem-writer --title="Qwen Code" --mood="reverent"
```

æˆ–è€…ï¼Œä½¿ç”¨ä½ç½®å‚æ•°ï¼š

```bash
/poem-writer "Qwen Code" reverent
```

å½“ä½ è¿è¡Œæ­¤å‘½ä»¤æ—¶ï¼ŒCLI ä¼šåœ¨ MCP æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `prompts/get` æ–¹æ³•ï¼Œå¹¶ä¼ å…¥æä¾›çš„å‚æ•°ã€‚æœåŠ¡å™¨è´Ÿè´£å°†å‚æ•°ä»£å…¥æç¤ºæ¨¡æ¿å¹¶è¿”å›æœ€ç»ˆçš„æç¤ºæ–‡æœ¬ã€‚ç„¶å CLI å°†è¯¥æç¤ºå‘é€ç»™æ¨¡å‹æ‰§è¡Œã€‚è¿™ä¸ºè‡ªåŠ¨åŒ–å’Œå…±äº«å¸¸è§å·¥ä½œæµæä¾›äº†ä¸€ç§ä¾¿æ·çš„æ–¹å¼ã€‚

## ä½¿ç”¨ `qwen mcp` ç®¡ç† MCP æœåŠ¡å™¨

è™½ç„¶ä½ å§‹ç»ˆå¯ä»¥é€šè¿‡æ‰‹åŠ¨ç¼–è¾‘ `settings.json` æ–‡ä»¶æ¥é…ç½® MCP æœåŠ¡å™¨ï¼Œä½† CLI æä¾›äº†ä¸€ç»„ä¾¿æ·çš„å‘½ä»¤ï¼Œå¯ä»¥è®©ä½ ä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†æœåŠ¡å™¨é…ç½®ã€‚è¿™äº›å‘½ä»¤ç®€åŒ–äº†æ·»åŠ ã€åˆ—å‡ºå’Œåˆ é™¤ MCP æœåŠ¡å™¨çš„è¿‡ç¨‹ï¼Œè€Œæ— éœ€ç›´æ¥ç¼–è¾‘ JSON æ–‡ä»¶ã€‚

### æ·»åŠ æœåŠ¡å™¨ (`qwen mcp add`)

`add` å‘½ä»¤ç”¨äºåœ¨ä½ çš„ `settings.json` ä¸­é…ç½®ä¸€ä¸ªæ–°çš„ MCP æœåŠ¡å™¨ã€‚æ ¹æ®ä½œç”¨åŸŸï¼ˆ`-s, --scope`ï¼‰ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°ç”¨æˆ·é…ç½®æ–‡ä»¶ `~/.qwen/settings.json` æˆ–é¡¹ç›®é…ç½®æ–‡ä»¶ `.qwen/settings.json` ä¸­ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp add [options] <name> <commandOrUrl> [args...]
```

- `<name>`ï¼šæœåŠ¡å™¨çš„å”¯ä¸€åç§°ã€‚
- `<commandOrUrl>`ï¼šè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆç”¨äº `stdio`ï¼‰æˆ– URLï¼ˆç”¨äº `http`/`sse`ï¼‰ã€‚
- `[args...]`ï¼š`stdio` å‘½ä»¤çš„å¯é€‰å‚æ•°ã€‚

**é€‰é¡¹ï¼ˆæ ‡å¿—ï¼‰ï¼š**

- `-s, --scope`ï¼šé…ç½®ä½œç”¨åŸŸï¼ˆuser æˆ– projectï¼‰ã€‚[é»˜è®¤å€¼ï¼š"project"]
- `-t, --transport`ï¼šä¼ è¾“ç±»å‹ï¼ˆstdioã€sseã€httpï¼‰ã€‚[é»˜è®¤å€¼ï¼š"stdio"]
- `-e, --env`ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ -e KEY=valueï¼‰ã€‚
- `-H, --header`ï¼šä¸º SSE å’Œ HTTP ä¼ è¾“è®¾ç½® HTTP å¤´ï¼ˆä¾‹å¦‚ -H "X-Api-Key: abc123" -H "Authorization: Bearer abc123"ï¼‰ã€‚
- `--timeout`ï¼šè®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚
- `--trust`ï¼šä¿¡ä»»è¯¥æœåŠ¡å™¨ï¼ˆè·³è¿‡æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤æç¤ºï¼‰ã€‚
- `--description`ï¼šè®¾ç½®æœåŠ¡å™¨æè¿°ã€‚
- `--include-tools`ï¼šåŒ…å«çš„å·¥å…·åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚
- `--exclude-tools`ï¼šæ’é™¤çš„å·¥å…·åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚

#### æ·»åŠ  stdio æœåŠ¡å™¨

è¿™æ˜¯è¿è¡Œæœ¬åœ°æœåŠ¡å™¨çš„é»˜è®¤ä¼ è¾“æ–¹å¼ã€‚

```bash

# åŸºæœ¬è¯­æ³•
qwen mcp add <name> <command> [args...]

# ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ªæœ¬åœ°æœåŠ¡å™¨
qwen mcp add my-stdio-server -e API_KEY=123 /path/to/server arg1 arg2 arg3

# ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ªæœ¬åœ° Python æœåŠ¡å™¨
qwen mcp add python-server python server.py --port 8080
```

#### æ·»åŠ  HTTP æœåŠ¡å™¨

æ­¤ä¼ è¾“æ–¹å¼é€‚ç”¨äºä½¿ç”¨å¯æµå¼ HTTP ä¼ è¾“çš„æœåŠ¡å™¨ã€‚

```bash

# åŸºæœ¬è¯­æ³•
qwen mcp add --transport http <name> <url>

# ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ª HTTP æœåŠ¡å™¨
qwen mcp add --transport http http-server https://api.example.com/mcp/

# ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ªå¸¦è®¤è¯å¤´éƒ¨çš„ HTTP æœåŠ¡å™¨
qwen mcp add --transport http secure-http https://api.example.com/mcp/ --header "Authorization: Bearer abc123"
```

#### æ·»åŠ  SSE æœåŠ¡å™¨

æ­¤ä¼ è¾“æ–¹å¼é€‚ç”¨äºä½¿ç”¨æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰çš„æœåŠ¡å™¨ã€‚

```bash

# åŸºæœ¬è¯­æ³•
qwen mcp add --transport sse <name> <url>
```

# ç¤ºä¾‹ï¼šæ·»åŠ  SSE æœåŠ¡å™¨
qwen mcp add --transport sse sse-server https://api.example.com/sse/

# ç¤ºä¾‹ï¼šæ·»åŠ å¸¦è®¤è¯å¤´éƒ¨çš„ SSE æœåŠ¡å™¨
qwen mcp add --transport sse secure-sse https://api.example.com/sse/ --header "Authorization: Bearer abc123"
```

### åˆ—å‡ºæœåŠ¡å™¨ (`qwen mcp list`)

è¦æŸ¥çœ‹å½“å‰é…ç½®çš„æ‰€æœ‰ MCP æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ `list` å‘½ä»¤ã€‚è¯¥å‘½ä»¤ä¼šæ˜¾ç¤ºæ¯ä¸ªæœåŠ¡å™¨çš„åç§°ã€é…ç½®è¯¦æƒ…ä»¥åŠè¿æ¥çŠ¶æ€ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp list
```

**ç¤ºä¾‹è¾“å‡ºï¼š**

```sh
âœ“ stdio-server: command: python3 server.py (stdio) - Connected
âœ“ http-server: https://api.example.com/mcp (http) - Connected
âœ— sse-server: https://api.example.com/sse (sse) - Disconnected
```

### åˆ é™¤æœåŠ¡å™¨ (`qwen mcp remove`)

è¦ä»é…ç½®ä¸­åˆ é™¤ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `remove` å‘½ä»¤å¹¶æŒ‡å®šæœåŠ¡å™¨åç§°ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp remove <name>
```

**ç¤ºä¾‹ï¼š**

```bash
qwen mcp remove my-server
```

è¯¥å‘½ä»¤ä¼šæ ¹æ®ä½œç”¨åŸŸï¼ˆ`-s, --scope`ï¼‰åœ¨ç›¸åº”çš„ `settings.json` æ–‡ä»¶ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤ `mcpServers` å¯¹è±¡ä¸­çš„ "my-server" æ¡ç›®ã€‚