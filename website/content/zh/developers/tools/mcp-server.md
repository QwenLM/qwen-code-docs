# ä½¿ç”¨ Qwen Code çš„ MCP æœåŠ¡å™¨

æœ¬æ–‡æ¡£æä¾›äº†å…³äºé…ç½®å’Œä½¿ç”¨ Model Context Protocol (MCP) æœåŠ¡å™¨ä¸ Qwen Code çš„æŒ‡å—ã€‚

## ä»€ä¹ˆæ˜¯ MCP æœåŠ¡å™¨ï¼Ÿ

MCP æœåŠ¡å™¨æ˜¯ä¸€ç§é€šè¿‡æ¨¡å‹ä¸Šä¸‹æ–‡åè®® (Model Context Protocol) å‘ CLI æš´éœ²å·¥å…·å’Œèµ„æºçš„åº”ç”¨ç¨‹åºï¼Œä½¿å…¶èƒ½å¤Ÿä¸å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æºè¿›è¡Œäº¤äº’ã€‚MCP æœåŠ¡å™¨å……å½“æ¨¡å‹ä¸ä½ çš„æœ¬åœ°ç¯å¢ƒæˆ–å…¶ä»–æœåŠ¡ï¼ˆå¦‚ APIï¼‰ä¹‹é—´çš„æ¡¥æ¢ã€‚

MCP æœåŠ¡å™¨ä½¿ CLI èƒ½å¤Ÿï¼š

- **å‘ç°å·¥å…·ï¼š** é€šè¿‡æ ‡å‡†åŒ–çš„æ¨¡å¼å®šä¹‰åˆ—å‡ºå¯ç”¨å·¥å…·ã€å…¶æè¿°å’Œå‚æ•°ã€‚
- **æ‰§è¡Œå·¥å…·ï¼š** ä½¿ç”¨å®šä¹‰çš„å‚æ•°è°ƒç”¨ç‰¹å®šå·¥å…·å¹¶æ¥æ”¶ç»“æ„åŒ–å“åº”ã€‚
- **è®¿é—®èµ„æºï¼š** ä»ç‰¹å®šèµ„æºè¯»å–æ•°æ®ï¼ˆå°½ç®¡ CLI ä¸»è¦ä¸“æ³¨äºå·¥å…·æ‰§è¡Œï¼‰ã€‚

é€šè¿‡ MCP æœåŠ¡å™¨ï¼Œä½ å¯ä»¥æ‰©å±• CLI çš„åŠŸèƒ½ï¼Œæ‰§è¡Œè¶…å‡ºå…¶å†…ç½®åŠŸèƒ½çš„æ“ä½œï¼Œä¾‹å¦‚ä¸æ•°æ®åº“ã€APIã€è‡ªå®šä¹‰è„šæœ¬æˆ–ä¸“ç”¨å·¥ä½œæµè¿›è¡Œäº¤äº’ã€‚

## æ ¸å¿ƒé›†æˆæ¶æ„

Qwen Code é€šè¿‡å†…ç½®åœ¨æ ¸å¿ƒåŒ… (`packages/core/src/tools/`) ä¸­çš„å¤æ‚å‘ç°å’Œæ‰§è¡Œç³»ç»Ÿä¸ MCP æœåŠ¡å™¨é›†æˆï¼š

### å‘ç°å±‚ (`mcp-client.ts`)

å‘ç°è¿‡ç¨‹ç”± `discoverMcpTools()` åè°ƒï¼Œè¯¥å‡½æ•°ï¼š

1. **éå†é…ç½®çš„æœåŠ¡å™¨**ï¼Œä»ä½ çš„ `settings.json` ä¸­çš„ `mcpServers` é…ç½®è·å–
2. **å»ºç«‹è¿æ¥**ï¼Œä½¿ç”¨é€‚å½“çš„ä¼ è¾“æœºåˆ¶ï¼ˆStdioã€SSE æˆ–å¯æµå¼ HTTPï¼‰
3. **ä»æ¯ä¸ªæœåŠ¡å™¨è·å–å·¥å…·å®šä¹‰**ï¼Œä½¿ç”¨ MCP åè®®
4. **æ¸…ç†å’ŒéªŒè¯** å·¥å…·æ¨¡å¼ï¼Œç¡®ä¿ä¸ Qwen API å…¼å®¹
5. **åœ¨å…¨å±€å·¥å…·æ³¨å†Œè¡¨ä¸­æ³¨å†Œå·¥å…·**ï¼Œå¹¶è§£å†³å†²çª

### æ‰§è¡Œå±‚ (`mcp-tool.ts`)

æ¯ä¸ªå‘ç°çš„ MCP å·¥å…·éƒ½è¢«åŒ…è£…åœ¨ `DiscoveredMCPTool` å®ä¾‹ä¸­ï¼Œè¯¥å®ä¾‹ï¼š

- **åŸºäºæœåŠ¡å™¨ä¿¡ä»»è®¾ç½®å’Œç”¨æˆ·åå¥½å¤„ç†ç¡®è®¤é€»è¾‘**
- **é€šè¿‡ä½¿ç”¨æ­£ç¡®å‚æ•°è°ƒç”¨ MCP æœåŠ¡å™¨æ¥ç®¡ç†å·¥å…·æ‰§è¡Œ**
- **å¤„ç†å“åº”**ï¼Œç”¨äº LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æ˜¾ç¤º
- **ç»´æŠ¤è¿æ¥çŠ¶æ€** å¹¶å¤„ç†è¶…æ—¶

### ä¼ è¾“æœºåˆ¶

CLI æ”¯æŒä¸‰ç§ MCP ä¼ è¾“ç±»å‹ï¼š

- **Stdio ä¼ è¾“ï¼š** ç”Ÿæˆå­è¿›ç¨‹å¹¶é€šè¿‡ stdin/stdout è¿›è¡Œé€šä¿¡
- **SSE ä¼ è¾“ï¼š** è¿æ¥åˆ°æœåŠ¡å™¨å‘é€äº‹ä»¶ç«¯ç‚¹
- **å¯æµå¼ HTTP ä¼ è¾“ï¼š** ä½¿ç”¨ HTTP æµè¿›è¡Œé€šä¿¡

## å¦‚ä½•è®¾ç½®ä½ çš„ MCP æœåŠ¡å™¨

Qwen Code ä½¿ç”¨ä½ åœ¨ `settings.json` æ–‡ä»¶ä¸­çš„ `mcpServers` é…ç½®æ¥å®šä½å’Œè¿æ¥åˆ° MCP æœåŠ¡å™¨ã€‚æ­¤é…ç½®æ”¯æŒä½¿ç”¨ä¸åŒä¼ è¾“æœºåˆ¶çš„å¤šä¸ªæœåŠ¡å™¨ã€‚

### åœ¨ settings.json ä¸­é…ç½® MCP æœåŠ¡å™¨

ä½ å¯ä»¥åœ¨ `settings.json` æ–‡ä»¶ä¸­é€šè¿‡ä¸¤ç§ä¸»è¦æ–¹å¼é…ç½® MCP æœåŠ¡å™¨ï¼šé€šè¿‡é¡¶çº§çš„ `mcpServers` å¯¹è±¡å®šä¹‰ç‰¹å®šæœåŠ¡å™¨ï¼Œä»¥åŠé€šè¿‡ `mcp` å¯¹è±¡è®¾ç½®æ§åˆ¶æœåŠ¡å™¨å‘ç°å’Œæ‰§è¡Œçš„å…¨å±€é…ç½®ã€‚

#### å…¨å±€ MCP è®¾ç½® (`mcp`)

`settings.json` ä¸­çš„ `mcp` å¯¹è±¡å…è®¸ä½ ä¸ºæ‰€æœ‰ MCP æœåŠ¡å™¨å®šä¹‰å…¨å±€è§„åˆ™ã€‚

- **`mcp.serverCommand`** (string): å¯åŠ¨ MCP æœåŠ¡å™¨çš„å…¨å±€å‘½ä»¤ã€‚
- **`mcp.allowed`** (å­—ç¬¦ä¸²æ•°ç»„): å…è®¸çš„ MCP æœåŠ¡å™¨åç§°åˆ—è¡¨ã€‚å¦‚æœè®¾ç½®äº†æ­¤é€‰é¡¹ï¼Œåªä¼šè¿æ¥åˆ°æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡å™¨ï¼ˆåŒ¹é… `mcpServers` å¯¹è±¡ä¸­çš„é”®ï¼‰ã€‚
- **`mcp.excluded`** (å­—ç¬¦ä¸²æ•°ç»„): æ’é™¤çš„ MCP æœåŠ¡å™¨åç§°åˆ—è¡¨ã€‚æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡å™¨å°†ä¸ä¼šè¢«è¿æ¥ã€‚

**ç¤ºä¾‹ï¼š**

```json
{
  "mcp": {
    "allowed": ["my-trusted-server"],
    "excluded": ["experimental-server"]
  }
}
```

#### æœåŠ¡å™¨ç‰¹å®šé…ç½® (`mcpServers`)

`mcpServers` å¯¹è±¡æ˜¯ä½ å®šä¹‰ CLI éœ€è¦è¿æ¥çš„æ¯ä¸ªç‹¬ç«‹ MCP æœåŠ¡å™¨çš„åœ°æ–¹ã€‚

### é…ç½®ç»“æ„

åœ¨ä½ çš„ `settings.json` æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª `mcpServers` å¯¹è±¡ï¼š

```json
{ ...æ–‡ä»¶åŒ…å«å…¶ä»–é…ç½®å¯¹è±¡
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### é…ç½®å±æ€§

æ¯ä¸ªæœåŠ¡å™¨é…ç½®æ”¯æŒä»¥ä¸‹å±æ€§ï¼š

#### å¿…éœ€ï¼ˆä»¥ä¸‹ä¹‹ä¸€ï¼‰

- **`command`** (string): Stdio ä¼ è¾“çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
- **`url`** (string): SSE ç«¯ç‚¹ URL (ä¾‹å¦‚ `"http://localhost:8080/sse"`)
- **`httpUrl`** (string): HTTP æµå¼ä¼ è¾“ç«¯ç‚¹ URL

#### å¯é€‰

- **`args`** (string[]): Stdio ä¼ è¾“çš„å‘½ä»¤è¡Œå‚æ•°
- **`headers`** (object): ä½¿ç”¨ `url` æˆ– `httpUrl` æ—¶çš„è‡ªå®šä¹‰ HTTP å¤´
- **`env`** (object): æœåŠ¡å™¨è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚å€¼å¯ä»¥ä½¿ç”¨ `$VAR_NAME` æˆ– `${VAR_NAME}` è¯­æ³•å¼•ç”¨ç¯å¢ƒå˜é‡
- **`cwd`** (string): Stdio ä¼ è¾“çš„å·¥ä½œç›®å½•
- **`timeout`** (number): è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ï¼š600,000ms = 10 åˆ†é’Ÿï¼‰
- **`trust`** (boolean): ä¸º `true` æ—¶ï¼Œç»•è¿‡æ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤ï¼ˆé»˜è®¤ï¼š`false`ï¼‰
- **`includeTools`** (string[]): è¦ä»æ­¤ MCP æœåŠ¡å™¨åŒ…å«çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æŒ‡å®šæ—¶ï¼Œåªæœ‰æ­¤å¤„åˆ—å‡ºçš„å·¥å…·å¯ä»æ­¤æœåŠ¡å™¨ä½¿ç”¨ï¼ˆç™½åå•è¡Œä¸ºï¼‰ã€‚å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤å¯ç”¨æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·ã€‚
- **`excludeTools`** (string[]): è¦ä»æ­¤ MCP æœåŠ¡å™¨æ’é™¤çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æ­¤å¤„åˆ—å‡ºçš„å·¥å…·å¯¹æ¨¡å‹ä¸å¯ç”¨ï¼Œå³ä½¿æœåŠ¡å™¨æš´éœ²äº†è¿™äº›å·¥å…·ã€‚**æ³¨æ„ï¼š** `excludeTools` ä¼˜å…ˆäº `includeTools` - å¦‚æœå·¥å…·åŒæ—¶åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­ï¼Œå°†è¢«æ’é™¤ã€‚
- **`targetAudience`** (string): ä½ å°è¯•è®¿é—®çš„ IAP ä¿æŠ¤åº”ç”¨ç¨‹åºä¸Šç™½åå•çš„ OAuth å®¢æˆ·ç«¯ IDã€‚ä¸ `authProviderType: 'service_account_impersonation'` ä¸€èµ·ä½¿ç”¨ã€‚
- **`targetServiceAccount`** (string): è¦æ¨¡æ‹Ÿçš„ Google Cloud æœåŠ¡è´¦æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ã€‚ä¸ `authProviderType: 'service_account_impersonation'` ä¸€èµ·ä½¿ç”¨ã€‚

### è¿œç¨‹ MCP æœåŠ¡å™¨çš„ OAuth æ”¯æŒ

Qwen Code æ”¯æŒä½¿ç”¨ SSE æˆ– HTTP ä¼ è¾“åè®®å¯¹è¿œç¨‹ MCP æœåŠ¡å™¨è¿›è¡Œ OAuth 2.0 è®¤è¯ã€‚è¿™ä½¿å¾—å¯ä»¥å®‰å…¨è®¿é—®éœ€è¦è®¤è¯çš„ MCP æœåŠ¡å™¨ã€‚

#### è‡ªåŠ¨ OAuth å‘ç°

å¯¹äºæ”¯æŒ OAuth å‘ç°çš„æœåŠ¡å™¨ï¼Œä½ å¯ä»¥çœç•¥ OAuth é…ç½®ï¼Œè®© CLI è‡ªåŠ¨å‘ç°ï¼š

```json
{
  "mcpServers": {
    "discoveredServer": {
      "url": "https://api.example.com/sse"
    }
  }
}
```

CLI å°†è‡ªåŠ¨ï¼š

- æ£€æµ‹æœåŠ¡å™¨ä½•æ—¶éœ€è¦ OAuth è®¤è¯ï¼ˆ401 å“åº”ï¼‰
- ä»æœåŠ¡å™¨å…ƒæ•°æ®ä¸­å‘ç° OAuth ç«¯ç‚¹
- å¦‚æœæ”¯æŒåˆ™æ‰§è¡ŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ
- å¤„ç† OAuth æµç¨‹å’Œä»¤ç‰Œç®¡ç†

#### è®¤è¯æµç¨‹

è¿æ¥åˆ°å¯ç”¨ OAuth çš„æœåŠ¡å™¨æ—¶ï¼š

1. **åˆå§‹è¿æ¥å°è¯•** å¤±è´¥ï¼Œè¿”å› 401 æœªæˆæƒ
2. **OAuth å‘ç°** æ‰¾åˆ°æˆæƒå’Œä»¤ç‰Œç«¯ç‚¹
3. **æµè§ˆå™¨æ‰“å¼€** è¿›è¡Œç”¨æˆ·è®¤è¯ï¼ˆéœ€è¦æœ¬åœ°æµè§ˆå™¨è®¿é—®ï¼‰
4. **æˆæƒç ** äº¤æ¢ä¸ºè®¿é—®ä»¤ç‰Œ
5. **ä»¤ç‰Œè¢«å®‰å…¨å­˜å‚¨** ä¾›å°†æ¥ä½¿ç”¨
6. **è¿æ¥é‡è¯•** ä½¿ç”¨æœ‰æ•ˆä»¤ç‰ŒæˆåŠŸ

#### æµè§ˆå™¨é‡å®šå‘è¦æ±‚

**é‡è¦ï¼š** OAuth è®¤è¯è¦æ±‚ä½ çš„æœ¬åœ°æœºå™¨èƒ½å¤Ÿï¼š

- æ‰“å¼€ç½‘é¡µæµè§ˆå™¨è¿›è¡Œè®¤è¯
- æ¥æ”¶ `http://localhost:7777/oauth/callback` ä¸Šçš„é‡å®šå‘

æ­¤åŠŸèƒ½åœ¨ä»¥ä¸‹ç¯å¢ƒä¸­æ— æ³•å·¥ä½œï¼š

- æ²¡æœ‰æµè§ˆå™¨è®¿é—®æƒé™çš„æ— å¤´ç¯å¢ƒ
- æ²¡æœ‰ X11 è½¬å‘çš„è¿œç¨‹ SSH ä¼šè¯
- æ²¡æœ‰æµè§ˆå™¨æ”¯æŒçš„å®¹å™¨åŒ–ç¯å¢ƒ

#### ç®¡ç† OAuth è®¤è¯

ä½¿ç”¨ `/mcp auth` å‘½ä»¤ç®¡ç† OAuth è®¤è¯ï¼š

```bash

# åˆ—å‡ºéœ€è¦è®¤è¯çš„æœåŠ¡å™¨
/mcp auth
```

# ä¸ç‰¹å®šæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName

# å¦‚æœä»¤ç‰Œè¿‡æœŸåˆ™é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName
```

#### OAuth é…ç½®å±æ€§

- **`enabled`** (boolean): ä¸ºæ­¤æœåŠ¡å™¨å¯ç”¨ OAuth
- **`clientId`** (string): OAuth å®¢æˆ·ç«¯æ ‡è¯†ç¬¦ï¼ˆä½¿ç”¨åŠ¨æ€æ³¨å†Œæ—¶å¯é€‰ï¼‰
- **`clientSecret`** (string): OAuth å®¢æˆ·ç«¯å¯†é’¥ï¼ˆå…¬å…±å®¢æˆ·ç«¯å¯é€‰ï¼‰
- **`authorizationUrl`** (string): OAuth æˆæƒç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`tokenUrl`** (string): OAuth ä»¤ç‰Œç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`scopes`** (string[]): å¿…éœ€çš„ OAuth èŒƒå›´
- **`redirectUri`** (string): è‡ªå®šä¹‰é‡å®šå‘ URIï¼ˆé»˜è®¤ä¸º `http://localhost:7777/oauth/callback`ï¼‰
- **`tokenParamName`** (string): SSE URL ä¸­ä»¤ç‰Œçš„æŸ¥è¯¢å‚æ•°åç§°
- **`audiences`** (string[]): ä»¤ç‰Œæœ‰æ•ˆçš„å—ä¼—ç¾¤ä½“

#### ä»¤ç‰Œç®¡ç†

OAuth ä»¤ç‰Œä¼šè‡ªåŠ¨ï¼š

- **å®‰å…¨å­˜å‚¨**åœ¨ `~/.qwen/mcp-oauth-tokens.json` ä¸­
- **åˆ·æ–°**è¿‡æœŸçš„ä»¤ç‰Œï¼ˆå¦‚æœæœ‰åˆ·æ–°ä»¤ç‰Œå¯ç”¨ï¼‰
- åœ¨æ¯æ¬¡è¿æ¥å°è¯•å‰**éªŒè¯**ä»¤ç‰Œ
- æ— æ•ˆæˆ–è¿‡æœŸæ—¶**æ¸…ç†**ä»¤ç‰Œ

#### è®¤è¯æä¾›ç¨‹åºç±»å‹

ä½ å¯ä»¥ä½¿ç”¨ `authProviderType` å±æ€§æŒ‡å®šè®¤è¯æä¾›ç¨‹åºç±»å‹ï¼š

- **`authProviderType`** (string): æŒ‡å®šè®¤è¯æä¾›ç¨‹åºã€‚å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š
  - **`dynamic_discovery`** (é»˜è®¤): CLI å°†è‡ªåŠ¨ä»æœåŠ¡å™¨å‘ç° OAuth é…ç½®ã€‚
  - **`google_credentials`**: CLI å°†ä½¿ç”¨ Google Application Default Credentials (ADC) å‘æœåŠ¡å™¨è¿›è¡Œè®¤è¯ã€‚ä½¿ç”¨æ­¤æä¾›ç¨‹åºæ—¶ï¼Œä½ å¿…é¡»æŒ‡å®šæ‰€éœ€çš„èŒƒå›´ã€‚
  - **`service_account_impersonation`**: CLI å°†æ¨¡æ‹Ÿä¸€ä¸ª Google Cloud æœåŠ¡è´¦å·å‘æœåŠ¡å™¨è¿›è¡Œè®¤è¯ã€‚è¿™å¯¹äºè®¿é—® IAP ä¿æŠ¤çš„æœåŠ¡å¾ˆæœ‰ç”¨ï¼ˆè¿™æ˜¯ä¸“é—¨ä¸º Cloud Run æœåŠ¡è®¾è®¡çš„ï¼‰ã€‚

#### Google å‡­æ®

```json
{
  "mcpServers": {
    "googleCloudServer": {
      "httpUrl": "https://my-gcp-service.run.app/mcp",
      "authProviderType": "google_credentials",
      "oauth": {
        "scopes": ["https://www.googleapis.com/auth/userinfo.email"]
      }
    }
  }
}
```

#### æœåŠ¡è´¦å·æ¨¡æ‹Ÿ

è¦ä½¿ç”¨æœåŠ¡è´¦å·æ¨¡æ‹Ÿå¯¹æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä½ å¿…é¡»å°† `authProviderType` è®¾ç½®ä¸º `service_account_impersonation` å¹¶æä¾›ä»¥ä¸‹å±æ€§ï¼š

- **`targetAudience`** (string): OAuth å®¢æˆ·ç«¯ IDï¼Œå…è®¸è®¿é—®ä½ å°è¯•è®¿é—®çš„ IAP ä¿æŠ¤åº”ç”¨ç¨‹åºã€‚
- **`targetServiceAccount`** (string): è¦æ¨¡æ‹Ÿçš„ Google Cloud æœåŠ¡è´¦å·çš„é‚®ç®±åœ°å€ã€‚

CLI å°†ä½¿ç”¨ä½ çš„æœ¬åœ°åº”ç”¨ç¨‹åºé»˜è®¤å‡­æ® (ADC) ä¸ºæŒ‡å®šçš„æœåŠ¡è´¦å·å’Œå—ä¼—ç”Ÿæˆ OIDC ID ä»¤ç‰Œã€‚ç„¶åè¯¥ä»¤ç‰Œå°†ç”¨äºä¸ MCP æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚

#### è®¾ç½®è¯´æ˜

1. **[åˆ›å»º](https://cloud.google.com/iap/docs/oauth-client-creation) æˆ–ä½¿ç”¨ç°æœ‰çš„ OAuth 2.0 å®¢æˆ·ç«¯ IDã€‚** è¦ä½¿ç”¨ç°æœ‰çš„ OAuth 2.0 å®¢æˆ·ç«¯ IDï¼Œè¯·æŒ‰ç…§ [å¦‚ä½•å…±äº« OAuth å®¢æˆ·ç«¯](https://cloud.google.com/iap/docs/sharing-oauth-clients) ä¸­çš„æ­¥éª¤æ“ä½œã€‚
2. **å°† OAuth ID æ·»åŠ åˆ°åº”ç”¨ç¨‹åºçš„[ç¨‹åºåŒ–è®¿é—®](https://cloud.google.com/iap/docs/sharing-oauth-clients#programmatic_access) å…è®¸åˆ—è¡¨ä¸­ã€‚** ç”±äº Cloud Run å°šæœªæˆä¸º gcloud iap ä¸­å—æ”¯æŒçš„èµ„æºç±»å‹ï¼Œä½ å¿…é¡»åœ¨é¡¹ç›®ä¸Šå°†å®¢æˆ·ç«¯ ID åŠ å…¥å…è®¸åˆ—è¡¨ã€‚
3. **åˆ›å»ºæœåŠ¡è´¦å·ã€‚** [æ–‡æ¡£](https://cloud.google.com/iam/docs/service-accounts-create#creating)ï¼Œ[Cloud Console é“¾æ¥](https://console.cloud.google.com/iam-admin/serviceaccounts)
4. **åœ¨ Cloud Run æœåŠ¡æœ¬èº«çš„ "Security" é€‰é¡¹å¡ä¸­æˆ–é€šè¿‡ gcloudï¼Œå°†æœåŠ¡è´¦å·å’Œç”¨æˆ·éƒ½æ·»åŠ åˆ° IAP ç­–ç•¥ä¸­**
5. **æˆäºˆæ‰€æœ‰å°†è®¿é—® MCP æœåŠ¡å™¨çš„ç”¨æˆ·å’Œç»„** [æ¨¡æ‹ŸæœåŠ¡è´¦å·](https://cloud.google.com/docs/authentication/use-service-account-impersonation) æ‰€éœ€çš„æƒé™ï¼ˆå³ `roles/iam.serviceAccountTokenCreator`ï¼‰ã€‚
6. **ä¸ºä½ çš„é¡¹ç›®[å¯ç”¨](https://console.cloud.google.com/apis/library/iamcredentials.googleapis.com) IAM Credentials API**ã€‚

### é…ç½®ç¤ºä¾‹

#### Python MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

#### Node.js MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

#### åŸºäº Docker çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

#### åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

#### å¸¦è‡ªå®šä¹‰å¤´éƒ¨çš„åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServerWithAuth": {
      "httpUrl": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer your-api-token",
        "X-Custom-Header": "custom-value",
        "Content-Type": "application/json"
      },
      "timeout": 5000
    }
  }
}
```

#### å¸¦å·¥å…·è¿‡æ»¤çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "filteredServer": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "includeTools": ["safe_tool", "file_reader", "data_processor"],
      // "excludeTools": ["dangerous_tool", "file_deleter"],
      "timeout": 30000
    }
  }
}
```

### ä½¿ç”¨æœåŠ¡è´¦å·æ¨¡æ‹Ÿçš„ SSE MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "myIapProtectedServer": {
      "url": "https://my-iap-service.run.app/sse",
      "authProviderType": "service_account_impersonation",
      "targetAudience": "YOUR_IAP_CLIENT_ID.apps.googleusercontent.com",
      "targetServiceAccount": "your-sa@your-project.iam.gserviceaccount.com"
    }
  }
}
```

## å‘ç°è¿‡ç¨‹æ·±å…¥è§£æ

å½“ Qwen Code å¯åŠ¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡ä»¥ä¸‹è¯¦ç»†è¿‡ç¨‹æ‰§è¡Œ MCP æœåŠ¡å™¨å‘ç°ï¼š

### 1. æœåŠ¡å™¨è¿­ä»£å’Œè¿æ¥

å¯¹äº `mcpServers` ä¸­çš„æ¯ä¸ªé…ç½®æœåŠ¡å™¨ï¼š

1. **çŠ¶æ€è·Ÿè¸ªå¼€å§‹ï¼š** æœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `CONNECTING`
2. **ä¼ è¾“é€‰æ‹©ï¼š** åŸºäºé…ç½®å±æ€§ï¼š
   - `httpUrl` â†’ `StreamableHTTPClientTransport`
   - `url` â†’ `SSEClientTransport`
   - `command` â†’ `StdioClientTransport`
3. **è¿æ¥å»ºç«‹ï¼š** MCP å®¢æˆ·ç«¯å°è¯•ä½¿ç”¨é…ç½®çš„è¶…æ—¶æ—¶é—´è¿›è¡Œè¿æ¥
4. **é”™è¯¯å¤„ç†ï¼š** è¿æ¥å¤±è´¥ä¼šè¢«è®°å½•ï¼ŒæœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `DISCONNECTED`

### 2. å·¥å…·å‘ç°

è¿æ¥æˆåŠŸåï¼š

1. **å·¥å…·åˆ—è¡¨ï¼š** å®¢æˆ·ç«¯è°ƒç”¨ MCP æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨ç«¯ç‚¹
2. **æ¨¡å¼éªŒè¯ï¼š** éªŒè¯æ¯ä¸ªå·¥å…·çš„å‡½æ•°å£°æ˜
3. **å·¥å…·è¿‡æ»¤ï¼š** æ ¹æ® `includeTools` å’Œ `excludeTools` é…ç½®è¿‡æ»¤å·¥å…·
4. **åç§°æ¸…ç†ï¼š** æ¸…ç†å·¥å…·åç§°ä»¥æ»¡è¶³ Qwen API è¦æ±‚ï¼š
   - æ— æ•ˆå­—ç¬¦ï¼ˆéå­—æ¯æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹ã€è¿å­—ç¬¦ï¼‰è¢«æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
   - è¶…è¿‡ 63 ä¸ªå­—ç¬¦çš„åç§°ä¼šè¢«æˆªæ–­ï¼Œä¸­é—´éƒ¨åˆ†æ›¿æ¢ä¸º (`___`)

### 3. å†²çªè§£å†³

å½“å¤šä¸ªæœåŠ¡å™¨æš´éœ²å…·æœ‰ç›¸åŒåç§°çš„å·¥å…·æ—¶ï¼š

1. **å…ˆæ³¨å†Œä¼˜å…ˆï¼š** ç¬¬ä¸€ä¸ªæ³¨å†Œå·¥å…·åç§°çš„æœåŠ¡å™¨è·å¾—æ— å‰ç¼€çš„åç§°
2. **è‡ªåŠ¨æ·»åŠ å‰ç¼€ï¼š** åç»­æœåŠ¡å™¨è·å¾—å¸¦å‰ç¼€çš„åç§°ï¼š`serverName__toolName`
3. **æ³¨å†Œè·Ÿè¸ªï¼š** å·¥å…·æ³¨å†Œè¡¨ç»´æŠ¤æœåŠ¡å™¨åç§°å’Œå…¶å·¥å…·ä¹‹é—´çš„æ˜ å°„å…³ç³»

### 4. æ¨¡å¼å¤„ç†

å·¥å…·å‚æ•°æ¨¡å¼ä¼šè¿›è¡Œæ¸…ç†ä»¥ç¡®ä¿ API å…¼å®¹æ€§ï¼š

- **`$schema` å±æ€§** ä¼šè¢«ç§»é™¤
- **`additionalProperties`** ä¼šè¢«å‰¥ç¦»
- **å¸¦æœ‰ `default` çš„ `anyOf`** ä¼šç§»é™¤å…¶é»˜è®¤å€¼ï¼ˆä¸ Vertex AI å…¼å®¹ï¼‰
- **é€’å½’å¤„ç†** é€‚ç”¨äºåµŒå¥—æ¨¡å¼

### 5. è¿æ¥ç®¡ç†

å‘ç°åï¼š

- **æŒä¹…è¿æ¥ï¼š** æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨ä¼šä¿æŒå…¶è¿æ¥
- **æ¸…ç†ï¼š** æœªæä¾›å¯ç”¨å·¥å…·çš„æœåŠ¡å™¨ä¼šå…³é—­å…¶è¿æ¥
- **çŠ¶æ€æ›´æ–°ï¼š** æœ€ç»ˆæœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `CONNECTED` æˆ– `DISCONNECTED`

## å·¥å…·æ‰§è¡Œæµç¨‹

å½“æ¨¡å‹å†³å®šä½¿ç”¨ MCP å·¥å…·æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹æ‰§è¡Œæµç¨‹ï¼š

### 1. å·¥å…·è°ƒç”¨

æ¨¡å‹ç”Ÿæˆä¸€ä¸ª `FunctionCall`ï¼ŒåŒ…å«ï¼š

- **å·¥å…·åç§°ï¼š** æ³¨å†Œçš„åç§°ï¼ˆå¯èƒ½å¸¦æœ‰å‰ç¼€ï¼‰
- **å‚æ•°ï¼š** ä¸å·¥å…·å‚æ•°æ¨¡å¼åŒ¹é…çš„ JSON å¯¹è±¡

### 2. ç¡®è®¤æµç¨‹

æ¯ä¸ª `DiscoveredMCPTool` éƒ½å®ç°äº†å¤æ‚çš„ç¡®è®¤é€»è¾‘ï¼š

#### åŸºäºä¿¡ä»»çš„ç»•è¿‡

```typescript
if (this.trust) {
  return false; // æ— éœ€ç¡®è®¤
}
```

#### åŠ¨æ€ç™½åå•

ç³»ç»Ÿç»´æŠ¤å†…éƒ¨ç™½åå•ï¼ŒåŒ…æ‹¬ï¼š

- **æœåŠ¡å™¨çº§åˆ«ï¼š** `serverName` â†’ æ¥è‡ªæ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·éƒ½è¢«ä¿¡ä»»
- **å·¥å…·çº§åˆ«ï¼š** `serverName.toolName` â†’ æ­¤ç‰¹å®šå·¥å…·è¢«ä¿¡ä»»

#### ç”¨æˆ·é€‰æ‹©å¤„ç†

å½“éœ€è¦ç¡®è®¤æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š

- **æ‰§è¡Œä¸€æ¬¡ï¼š** ä»…æœ¬æ¬¡æ‰§è¡Œ
- **å§‹ç»ˆå…è®¸æ­¤å·¥å…·ï¼š** æ·»åŠ åˆ°å·¥å…·çº§åˆ«ç™½åå•
- **å§‹ç»ˆå…è®¸æ­¤æœåŠ¡å™¨ï¼š** æ·»åŠ åˆ°æœåŠ¡å™¨çº§åˆ«ç™½åå•
- **å–æ¶ˆï¼š** ä¸­æ­¢æ‰§è¡Œ

### 3. æ‰§è¡Œ

ç¡®è®¤åï¼ˆæˆ–è·³è¿‡ä¿¡ä»»éªŒè¯ï¼‰ï¼š

1. **å‚æ•°å‡†å¤‡ï¼š** æ ¹æ®å·¥å…·çš„ schema éªŒè¯å‚æ•°
2. **MCP è°ƒç”¨ï¼š** åº•å±‚çš„ `CallableTool` ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è°ƒç”¨æœåŠ¡å™¨ï¼š

   ```typescript
   const functionCalls = [
     {
       name: this.serverToolName, // åŸå§‹æœåŠ¡å™¨å·¥å…·åç§°
       args: params,
     },
   ];
   ```

3. **å“åº”å¤„ç†ï¼š** ç»“æœæ ¼å¼åŒ–ä¸º LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æ˜¾ç¤ºä¸¤ç§å½¢å¼

### 4. å“åº”å¤„ç†

æ‰§è¡Œç»“æœåŒ…å«ï¼š

- **`llmContent`ï¼š** è¯­è¨€æ¨¡å‹ä¸Šä¸‹æ–‡çš„åŸå§‹å“åº”éƒ¨åˆ†
- **`returnDisplay`ï¼š** ä¸ºç”¨æˆ·æ˜¾ç¤ºæ ¼å¼åŒ–çš„è¾“å‡ºï¼ˆé€šå¸¸åœ¨ markdown ä»£ç å—ä¸­çš„ JSONï¼‰

## å¦‚ä½•ä¸ä½ çš„ MCP æœåŠ¡å™¨äº¤äº’

### ä½¿ç”¨ `/mcp` å‘½ä»¤

`/mcp` å‘½ä»¤æä¾›å…³äºä½ çš„ MCP æœåŠ¡å™¨è®¾ç½®çš„å…¨é¢ä¿¡æ¯ï¼š

```bash
/mcp
```

è¿™ä¼šæ˜¾ç¤ºï¼š

- **æœåŠ¡å™¨åˆ—è¡¨ï¼š** æ‰€æœ‰å·²é…ç½®çš„ MCP æœåŠ¡å™¨
- **è¿æ¥çŠ¶æ€ï¼š** `CONNECTED`ã€`CONNECTING` æˆ– `DISCONNECTED`
- **æœåŠ¡å™¨è¯¦æƒ…ï¼š** é…ç½®æ‘˜è¦ï¼ˆä¸åŒ…æ‹¬æ•æ„Ÿæ•°æ®ï¼‰
- **å¯ç”¨å·¥å…·ï¼š** æ¥è‡ªæ¯ä¸ªæœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨åŠå…¶æè¿°
- **å‘ç°çŠ¶æ€ï¼š** æ•´ä½“å‘ç°è¿‡ç¨‹çŠ¶æ€

### `/mcp` è¾“å‡ºç¤ºä¾‹

```
MCP æœåŠ¡å™¨çŠ¶æ€ï¼š

ğŸ“¡ pythonTools (å·²è¿æ¥)
  å‘½ä»¤: python -m my_mcp_server --port 8080
  å·¥ä½œç›®å½•: ./mcp-servers/python
  è¶…æ—¶: 15000ms
  å·¥å…·: calculate_sum, file_analyzer, data_processor

ğŸ”Œ nodeServer (å·²æ–­å¼€)
  å‘½ä»¤: node dist/server.js --verbose
  é”™è¯¯: è¿æ¥è¢«æ‹’ç»

ğŸ³ dockerizedServer (å·²è¿æ¥)
  å‘½ä»¤: docker run -i --rm -e API_KEY my-mcp-server:latest
  å·¥å…·: docker__deploy, docker__status

å‘ç°çŠ¶æ€: å·²å®Œæˆ
```

### å·¥å…·ä½¿ç”¨

ä¸€æ—¦å‘ç°ï¼ŒMCP å·¥å…·å°±ä¼šåƒå†…ç½®å·¥å…·ä¸€æ ·æä¾›ç»™ Qwen æ¨¡å‹ä½¿ç”¨ã€‚æ¨¡å‹å°†è‡ªåŠ¨ï¼š

1. **æ ¹æ®ä½ çš„è¯·æ±‚é€‰æ‹©é€‚å½“çš„å·¥å…·**
2. **æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†**ï¼ˆé™¤éæœåŠ¡å™¨æ˜¯å—ä¿¡ä»»çš„ï¼‰
3. **ä½¿ç”¨é€‚å½“çš„å‚æ•°æ‰§è¡Œå·¥å…·**
4. **ä»¥ç”¨æˆ·å‹å¥½çš„æ ¼å¼æ˜¾ç¤ºç»“æœ**

## çŠ¶æ€ç›‘æ§å’Œæ•…éšœæ’é™¤

### è¿æ¥çŠ¶æ€

MCP é›†æˆè·Ÿè¸ªå‡ ç§çŠ¶æ€ï¼š

#### æœåŠ¡å™¨çŠ¶æ€ (`MCPServerStatus`)

- **`DISCONNECTED`ï¼š** æœåŠ¡å™¨æœªè¿æ¥æˆ–å‡ºç°é”™è¯¯
- **`CONNECTING`ï¼š** è¿æ¥å°è¯•æ­£åœ¨è¿›è¡Œä¸­
- **`CONNECTED`ï¼š** æœåŠ¡å™¨å·²è¿æ¥å¹¶å°±ç»ª

#### å‘ç°çŠ¶æ€ (`MCPDiscoveryState`)

- **`NOT_STARTED`ï¼š** å‘ç°å°šæœªå¼€å§‹
- **`IN_PROGRESS`ï¼š** å½“å‰æ­£åœ¨å‘ç°æœåŠ¡å™¨
- **`COMPLETED`ï¼š** å‘ç°å®Œæˆï¼ˆæ— è®ºæ˜¯å¦å‡ºç°é”™è¯¯ï¼‰

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### æœåŠ¡å™¨æ— æ³•è¿æ¥

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨æ˜¾ç¤º `DISCONNECTED` çŠ¶æ€

**æ•…éšœæ’é™¤ï¼š**

1. **æ£€æŸ¥é…ç½®ï¼š** éªŒè¯ `command`ã€`args` å’Œ `cwd` æ˜¯å¦æ­£ç¡®
2. **æ‰‹åŠ¨æµ‹è¯•ï¼š** ç›´æ¥è¿è¡ŒæœåŠ¡å™¨å‘½ä»¤ä»¥ç¡®ä¿å…¶æ­£å¸¸å·¥ä½œ
3. **æ£€æŸ¥ä¾èµ–é¡¹ï¼š** ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„åŒ…éƒ½å·²å®‰è£…
4. **æŸ¥çœ‹æ—¥å¿—ï¼š** åœ¨ CLI è¾“å‡ºä¸­æŸ¥æ‰¾é”™è¯¯æ¶ˆæ¯
5. **éªŒè¯æƒé™ï¼š** ç¡®ä¿ CLI å¯ä»¥æ‰§è¡ŒæœåŠ¡å™¨å‘½ä»¤

#### æœªå‘ç°å·¥å…·

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨è¿æ¥æˆåŠŸä½†æ²¡æœ‰å¯ç”¨çš„å·¥å…·

**æ•…éšœæ’é™¤ï¼š**

1. **éªŒè¯å·¥å…·æ³¨å†Œï¼š** ç¡®ä¿ä½ çš„æœåŠ¡å™¨å®é™…æ³¨å†Œäº†å·¥å…·
2. **æ£€æŸ¥ MCP åè®®ï¼š** ç¡®è®¤ä½ çš„æœåŠ¡å™¨æ­£ç¡®å®ç°äº† MCP å·¥å…·åˆ—è¡¨
3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š** æ£€æŸ¥ stderr è¾“å‡ºä¸­çš„æœåŠ¡å™¨ç«¯é”™è¯¯
4. **æµ‹è¯•å·¥å…·åˆ—è¡¨ï¼š** æ‰‹åŠ¨æµ‹è¯•ä½ çš„æœåŠ¡å™¨çš„å·¥å…·å‘ç°ç«¯ç‚¹

#### å·¥å…·æœªæ‰§è¡Œ

**ç—‡çŠ¶ï¼š** å·¥å…·è¢«å‘ç°ä½†åœ¨æ‰§è¡ŒæœŸé—´å¤±è´¥

**æ•…éšœæ’é™¤ï¼š**

1. **å‚æ•°éªŒè¯ï¼š** ç¡®ä¿ä½ çš„å·¥å…·æ¥å—é¢„æœŸçš„å‚æ•°
2. **æ¨¡å¼å…¼å®¹æ€§ï¼š** éªŒè¯ä½ çš„è¾“å…¥æ¨¡å¼æ˜¯æœ‰æ•ˆçš„ JSON Schema
3. **é”™è¯¯å¤„ç†ï¼š** æ£€æŸ¥ä½ çš„å·¥å…·æ˜¯å¦æŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸
4. **è¶…æ—¶é—®é¢˜ï¼š** è€ƒè™‘å¢åŠ  `timeout` è®¾ç½®

#### æ²™ç®±å…¼å®¹æ€§

**ç—‡çŠ¶ï¼š** å¯ç”¨æ²™ç®±æ—¶ MCP æœåŠ¡å™¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**

1. **åŸºäº Docker çš„æœåŠ¡å™¨ï¼š** ä½¿ç”¨åŒ…å«æ‰€æœ‰ä¾èµ–é¡¹çš„ Docker å®¹å™¨
2. **è·¯å¾„å¯è®¿é—®æ€§ï¼š** ç¡®ä¿æœåŠ¡å™¨å¯æ‰§è¡Œæ–‡ä»¶åœ¨æ²™ç®±ä¸­å¯ç”¨
3. **ç½‘ç»œè®¿é—®ï¼š** é…ç½®æ²™ç®±ä»¥å…è®¸å¿…è¦çš„ç½‘ç»œè¿æ¥
4. **ç¯å¢ƒå˜é‡ï¼š** éªŒè¯æ‰€éœ€çš„ç¯å¢ƒå˜é‡å·²ä¼ é€’é€šè¿‡

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š** ä½¿ç”¨ `--debug` è¿è¡Œ CLI ä»¥è·å¾—è¯¦ç»†è¾“å‡º
2. **æ£€æŸ¥ stderrï¼š** MCP æœåŠ¡å™¨çš„ stderr ä¼šè¢«æ•è·å¹¶è®°å½•ï¼ˆINFO çº§åˆ«æ¶ˆæ¯ä¼šè¢«è¿‡æ»¤ï¼‰
3. **æµ‹è¯•éš”ç¦»ï¼š** åœ¨é›†æˆä¹‹å‰ç‹¬ç«‹æµ‹è¯•ä½ çš„ MCP æœåŠ¡å™¨
4. **æ¸è¿›å¼è®¾ç½®ï¼š** ä»ç®€å•å·¥å…·å¼€å§‹ï¼Œå†æ·»åŠ å¤æ‚åŠŸèƒ½
5. **é¢‘ç¹ä½¿ç”¨ `/mcp`ï¼š** åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç›‘æ§æœåŠ¡å™¨çŠ¶æ€

## é‡è¦æ³¨æ„äº‹é¡¹

### å®‰å…¨è€ƒè™‘

- **ä¿¡ä»»è®¾ç½®ï¼š** `trust` é€‰é¡¹ä¼šç»•è¿‡æ‰€æœ‰ç¡®è®¤å¯¹è¯æ¡†ã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œä»…ç”¨äºä½ å®Œå…¨æ§åˆ¶çš„æœåŠ¡å™¨
- **è®¿é—®ä»¤ç‰Œï¼š** é…ç½®åŒ…å« API å¯†é’¥æˆ–ä»¤ç‰Œçš„ç¯å¢ƒå˜é‡æ—¶è¯·æ³¨æ„å®‰å…¨æ€§
- **æ²™ç›’å…¼å®¹æ€§ï¼š** ä½¿ç”¨æ²™ç›’æ—¶ï¼Œè¯·ç¡®ä¿ MCP æœåŠ¡å™¨åœ¨æ²™ç›’ç¯å¢ƒä¸­å¯ç”¨
- **ç§æœ‰æ•°æ®ï¼š** ä½¿ç”¨èŒƒå›´å¹¿æ³›çš„ä¸ªäººè®¿é—®ä»¤ç‰Œå¯èƒ½å¯¼è‡´ä»“åº“é—´çš„ä¿¡æ¯æ³„éœ²

### æ€§èƒ½å’Œèµ„æºç®¡ç†

- **è¿æ¥æŒä¹…æ€§ï¼š** CLI ä¸æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨ä¿æŒæŒä¹…è¿æ¥
- **è‡ªåŠ¨æ¸…ç†ï¼š** è‡ªåŠ¨å…³é—­ä¸æœªæä¾›å·¥å…·çš„æœåŠ¡å™¨çš„è¿æ¥
- **è¶…æ—¶ç®¡ç†ï¼š** æ ¹æ®æœåŠ¡å™¨çš„å“åº”ç‰¹æ€§é…ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´
- **èµ„æºç›‘æ§ï¼š** MCP æœåŠ¡å™¨ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œå¹¶æ¶ˆè€—ç³»ç»Ÿèµ„æº

### æ¨¡å¼å…¼å®¹æ€§

- **æ¨¡å¼åˆè§„æ¨¡å¼ï¼š** é»˜è®¤æƒ…å†µä¸‹ï¼ˆ`schemaCompliance: "auto"`ï¼‰ï¼Œå·¥å…·æ¨¡å¼ä¼šåŸæ ·ä¼ é€’ã€‚åœ¨ `settings.json` ä¸­è®¾ç½® `"model": { "generationConfig": { "schemaCompliance": "openapi_30" } }` ä»¥å°†æ¨¡å‹è½¬æ¢ä¸ºä¸¥æ ¼çš„ OpenAPI 3.0 æ ¼å¼ã€‚
- **OpenAPI 3.0 è½¬æ¢ï¼š** å¯ç”¨ `openapi_30` æ¨¡å¼æ—¶ï¼Œç³»ç»Ÿä¼šå¤„ç†ï¼š
  - å¯ç©ºç±»å‹ï¼š`["string", "null"]` -> `type: "string", nullable: true`
  - å¸¸é‡å€¼ï¼š`const: "foo"` -> `enum: ["foo"]`
  - æ’ä»–é™åˆ¶ï¼šæ•°å€¼ `exclusiveMinimum` -> å¸¦ `minimum` çš„å¸ƒå°”å½¢å¼
  - å…³é”®å­—ç§»é™¤ï¼š`$schema`ã€`$id`ã€`dependencies`ã€`patternProperties`
- **åç§°æ¸…ç†ï¼š** å·¥å…·åç§°ä¼šè‡ªåŠ¨æ¸…ç†ä»¥æ»¡è¶³ API è¦æ±‚
- **å†²çªè§£å†³ï¼š** æœåŠ¡å™¨ä¹‹é—´çš„å·¥å…·åç§°å†²çªé€šè¿‡è‡ªåŠ¨å‰ç¼€è§£å†³

è¿™ç§å…¨é¢çš„é›†æˆä½¿ MCP æœåŠ¡å™¨æˆä¸ºæ‰©å±• CLI åŠŸèƒ½çš„å¼ºå¤§æ–¹å¼ï¼ŒåŒæ—¶ä¿æŒå®‰å…¨æ€§ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## ä»å·¥å…·è¿”å›å¯Œå†…å®¹

MCP å·¥å…·ä¸ä»…é™äºè¿”å›ç®€å•çš„æ–‡æœ¬ã€‚ä½ å¯ä»¥è¿”å›ä¸°å¯Œçš„å¤šéƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘å’Œå…¶ä»–äºŒè¿›åˆ¶æ•°æ®ï¼Œå…¨éƒ¨åŒ…å«åœ¨å•ä¸ªå·¥å…·å“åº”ä¸­ã€‚è¿™ä½¿ä½ èƒ½å¤Ÿæ„å»ºå¼ºå¤§çš„å·¥å…·ï¼Œåœ¨å•æ¬¡äº¤äº’ä¸­å‘æ¨¡å‹æä¾›å¤šæ ·åŒ–ä¿¡æ¯ã€‚

ä»å·¥å…·è¿”å›çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè¢«å¤„ç†å¹¶ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ç»™æ¨¡å‹ï¼Œç”¨äºå…¶ä¸‹ä¸€æ¬¡ç”Ÿæˆï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿæ¨ç†æˆ–æ€»ç»“æä¾›çš„ä¿¡æ¯ã€‚

### å·¥ä½œåŸç†

è¦è¿”å›å¯Œå†…å®¹ï¼Œä½ çš„å·¥å…·å“åº”å¿…é¡»éµå¾ª MCP è§„èŒƒä¸­çš„ [`CallToolResult`](https://modelcontextprotocol.io/specification/2025-06-18/server/tools#tool-result)ã€‚ç»“æœä¸­çš„ `content` å­—æ®µåº”è¯¥æ˜¯ä¸€ä¸ª `ContentBlock` å¯¹è±¡æ•°ç»„ã€‚CLI å°†æ­£ç¡®å¤„ç†æ­¤æ•°ç»„ï¼Œå°†æ–‡æœ¬ä¸äºŒè¿›åˆ¶æ•°æ®åˆ†ç¦»å¹¶ä¸ºæ¨¡å‹æ‰“åŒ…ã€‚

ä½ å¯ä»¥åœ¨ `content` æ•°ç»„ä¸­æ··åˆä½¿ç”¨ä¸åŒçš„å†…å®¹å—ç±»å‹ã€‚æ”¯æŒçš„å—ç±»å‹åŒ…æ‹¬ï¼š

- `text`
- `image`
- `audio`
- `resource`ï¼ˆåµŒå…¥å†…å®¹ï¼‰
- `resource_link`

### ç¤ºä¾‹ï¼šè¿”å›æ–‡æœ¬å’Œå›¾åƒ

ä»¥ä¸‹æ˜¯ä¸€ä¸ª MCP å·¥å…·è¿”å›æ–‡æœ¬æè¿°å’Œå›¾åƒçš„æœ‰æ•ˆ JSON å“åº”ç¤ºä¾‹ï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "è¿™æ˜¯ä½ è¯·æ±‚çš„ logoã€‚"
    },
    {
      "type": "image",
      "data": "BASE64_ENCODED_IMAGE_DATA_HERE",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "è¯¥ logo åˆ›å»ºäº 2025 å¹´ã€‚"
    }
  ]
}
```

å½“ Qwen Code æ¥æ”¶åˆ°æ­¤å“åº”æ—¶ï¼Œå®ƒå°†ï¼š

1.  æå–æ‰€æœ‰æ–‡æœ¬å¹¶å°†å…¶åˆå¹¶ä¸ºæ¨¡å‹çš„å•ä¸ª `functionResponse` éƒ¨åˆ†ã€‚
2.  å°†å›¾åƒæ•°æ®ä½œä¸ºå•ç‹¬çš„ `inlineData` éƒ¨åˆ†å‘ˆç°ã€‚
3.  åœ¨ CLI ä¸­æä¾›ç®€æ´çš„ç”¨æˆ·å‹å¥½æ‘˜è¦ï¼Œè¡¨æ˜å·²æ¥æ”¶åˆ°æ–‡æœ¬å’Œå›¾åƒã€‚

è¿™ä½¿ä½ èƒ½å¤Ÿæ„å»ºå¤æ‚çš„å·¥å…·ï¼Œä¸º Qwen æ¨¡å‹æä¾›ä¸°å¯Œçš„å¤šæ¨¡æ€ä¸Šä¸‹æ–‡ã€‚

## MCP æç¤ºä½œä¸ºæ–œæ å‘½ä»¤

é™¤äº†å·¥å…·ä¹‹å¤–ï¼ŒMCP æœåŠ¡å™¨è¿˜å¯ä»¥æš´éœ²é¢„å®šä¹‰çš„æç¤ºï¼Œè¿™äº›æç¤ºå¯ä»¥åœ¨ Qwen Code ä¸­ä½œä¸ºæ–œæ å‘½ä»¤æ‰§è¡Œã€‚è¿™å…è®¸ä½ ä¸ºå¸¸è§æˆ–å¤æ‚çš„æŸ¥è¯¢åˆ›å»ºå¿«æ·æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡åç§°è½»æ¾è°ƒç”¨ã€‚

### åœ¨æœåŠ¡å™¨ä¸Šå®šä¹‰æç¤º

è¿™æ˜¯ä¸€ä¸ªå®šä¹‰æç¤ºçš„å°å‹ stdio MCP æœåŠ¡å™¨ç¤ºä¾‹ï¼š

```ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

const server = new McpServer({
  name: 'prompt-server',
  version: '1.0.0',
});

server.registerPrompt(
  'poem-writer',
  {
    title: 'Poem Writer',
    description: 'Write a nice haiku',
    argsSchema: { title: z.string(), mood: z.string().optional() },
  },
  ({ title, mood }) => ({
    messages: [
      {
        role: 'user',
        content: {
          type: 'text',
          text: `Write a haiku${mood ? ` with the mood ${mood}` : ''} called ${title}. Note that a haiku is 5 syllables followed by 7 syllables followed by 5 syllables `,
        },
      },
    ],
  }),
);

const transport = new StdioServerTransport();
await server.connect(transport);
```

è¿™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åœ¨ `settings.json` ä¸­çš„ `mcpServers` ä¸‹åŒ…å«ï¼š

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["filename.ts"]
    }
  }
}
```

### è°ƒç”¨æç¤º

ä¸€æ—¦å‘ç°æç¤ºï¼Œä½ å¯ä»¥ä½¿ç”¨å…¶åç§°ä½œä¸ºæ–œæ å‘½ä»¤æ¥è°ƒç”¨å®ƒã€‚CLI å°†è‡ªåŠ¨å¤„ç†å‚æ•°è§£æã€‚

```bash
/poem-writer --title="Qwen Code" --mood="reverent"
```

æˆ–è€…ï¼Œä½¿ç”¨ä½ç½®å‚æ•°ï¼š

```bash
/poem-writer "Qwen Code" reverent
```

å½“ä½ è¿è¡Œæ­¤å‘½ä»¤æ—¶ï¼ŒCLI ä¼šåœ¨ MCP æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `prompts/get` æ–¹æ³•å¹¶ä¼ å…¥æä¾›çš„å‚æ•°ã€‚æœåŠ¡å™¨è´Ÿè´£å°†å‚æ•°ä»£å…¥æç¤ºæ¨¡æ¿å¹¶è¿”å›æœ€ç»ˆçš„æç¤ºæ–‡æœ¬ã€‚ç„¶å CLI å°†æ­¤æç¤ºå‘é€ç»™æ¨¡å‹æ‰§è¡Œã€‚è¿™æä¾›äº†ä¸€ç§ä¾¿æ·çš„æ–¹å¼æ¥è‡ªåŠ¨åŒ–å’Œå…±äº«å¸¸è§å·¥ä½œæµç¨‹ã€‚

## ä½¿ç”¨ `qwen mcp` ç®¡ç† MCP æœåŠ¡å™¨

è™½ç„¶ä½ å¯ä»¥é€šè¿‡æ‰‹åŠ¨ç¼–è¾‘ `settings.json` æ–‡ä»¶æ¥é…ç½® MCP æœåŠ¡å™¨ï¼Œä½† CLI æä¾›äº†ä¸€ç»„ä¾¿æ·çš„å‘½ä»¤æ¥ä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†æœåŠ¡å™¨é…ç½®ã€‚è¿™äº›å‘½ä»¤ç®€åŒ–äº†æ·»åŠ ã€åˆ—å‡ºå’Œåˆ é™¤ MCP æœåŠ¡å™¨çš„è¿‡ç¨‹ï¼Œæ— éœ€ç›´æ¥ç¼–è¾‘ JSON æ–‡ä»¶ã€‚

### æ·»åŠ æœåŠ¡å™¨ (`qwen mcp add`)

`add` å‘½ä»¤åœ¨ä½ çš„ `settings.json` ä¸­é…ç½®ä¸€ä¸ªæ–°çš„ MCP æœåŠ¡å™¨ã€‚æ ¹æ®ä½œç”¨åŸŸ (`-s, --scope`)ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°ç”¨æˆ·é…ç½® `~/.qwen/settings.json` æˆ–é¡¹ç›®é…ç½® `.qwen/settings.json` æ–‡ä»¶ä¸­ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp add [options] <name> <commandOrUrl> [args...]
```

- `<name>`: æœåŠ¡å™¨çš„å”¯ä¸€åç§°ã€‚
- `<commandOrUrl>`: è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆç”¨äº `stdio`ï¼‰æˆ– URLï¼ˆç”¨äº `http`/`sse`ï¼‰ã€‚
- `[args...]`: `stdio` å‘½ä»¤çš„å¯é€‰å‚æ•°ã€‚

**é€‰é¡¹ï¼ˆæ ‡å¿—ï¼‰ï¼š**

- `-s, --scope`: é…ç½®ä½œç”¨åŸŸï¼ˆç”¨æˆ·æˆ–é¡¹ç›®ï¼‰ã€‚[é»˜è®¤å€¼: "project"]
- `-t, --transport`: ä¼ è¾“ç±»å‹ï¼ˆstdio, sse, httpï¼‰ã€‚[é»˜è®¤å€¼: "stdio"]
- `-e, --env`: è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ -e KEY=valueï¼‰ã€‚
- `-H, --header`: ä¸º SSE å’Œ HTTP ä¼ è¾“è®¾ç½® HTTP å¤´ï¼ˆä¾‹å¦‚ -H "X-Api-Key: abc123" -H "Authorization: Bearer abc123"ï¼‰ã€‚
- `--timeout`: è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚
- `--trust`: ä¿¡ä»»æœåŠ¡å™¨ï¼ˆç»•è¿‡æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤æç¤ºï¼‰ã€‚
- `--description`: è®¾ç½®æœåŠ¡å™¨æè¿°ã€‚
- `--include-tools`: è¦åŒ…å«çš„å·¥å…·çš„é€—å·åˆ†éš”åˆ—è¡¨ã€‚
- `--exclude-tools`: è¦æ’é™¤çš„å·¥å…·çš„é€—å·åˆ†éš”åˆ—è¡¨ã€‚

#### æ·»åŠ  stdio æœåŠ¡å™¨

è¿™æ˜¯è¿è¡Œæœ¬åœ°æœåŠ¡å™¨çš„é»˜è®¤ä¼ è¾“æ–¹å¼ã€‚

```bash
# åŸºæœ¬è¯­æ³•
qwen mcp add <name> <command> [args...]

# ç¤ºä¾‹ï¼šæ·»åŠ æœ¬åœ°æœåŠ¡å™¨
qwen mcp add my-stdio-server -e API_KEY=123 /path/to/server arg1 arg2 arg3

# ç¤ºä¾‹ï¼šæ·»åŠ æœ¬åœ° python æœåŠ¡å™¨
qwen mcp add python-server python server.py --port 8080
```

#### æ·»åŠ  HTTP æœåŠ¡å™¨

æ­¤ä¼ è¾“æ–¹å¼ç”¨äºä½¿ç”¨å¯æµå¼ HTTP ä¼ è¾“çš„æœåŠ¡å™¨ã€‚

```bash
# åŸºæœ¬è¯­æ³•
qwen mcp add --transport http <name> <url>

# ç¤ºä¾‹ï¼šæ·»åŠ  HTTP æœåŠ¡å™¨
qwen mcp add --transport http http-server https://api.example.com/mcp/

# ç¤ºä¾‹ï¼šæ·»åŠ å¸¦æœ‰è®¤è¯å¤´çš„ HTTP æœåŠ¡å™¨
qwen mcp add --transport http secure-http https://api.example.com/mcp/ --header "Authorization: Bearer abc123"
```

#### æ·»åŠ  SSE æœåŠ¡å™¨

æ­¤ä¼ è¾“æ–¹å¼ç”¨äºä½¿ç”¨æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰çš„æœåŠ¡å™¨ã€‚

```bash
# åŸºæœ¬è¯­æ³•
qwen mcp add --transport sse <name> <url>
```

# ç¤ºä¾‹ï¼šæ·»åŠ  SSE æœåŠ¡å™¨
qwen mcp add --transport sse sse-server https://api.example.com/sse/

# ç¤ºä¾‹ï¼šæ·»åŠ å¸¦è®¤è¯å¤´çš„ SSE æœåŠ¡å™¨
qwen mcp add --transport sse secure-sse https://api.example.com/sse/ --header "Authorization: Bearer abc123"
```

### åˆ—å‡ºæœåŠ¡å™¨ (`qwen mcp list`)

è¦æŸ¥çœ‹å½“å‰é…ç½®çš„æ‰€æœ‰ MCP æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `list` å‘½ä»¤ã€‚å®ƒä¼šæ˜¾ç¤ºæ¯ä¸ªæœåŠ¡å™¨çš„åç§°ã€é…ç½®è¯¦æƒ…å’Œè¿æ¥çŠ¶æ€ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp list
```

**ç¤ºä¾‹è¾“å‡ºï¼š**

```sh
âœ“ stdio-server: command: python3 server.py (stdio) - å·²è¿æ¥
âœ“ http-server: https://api.example.com/mcp (http) - å·²è¿æ¥
âœ— sse-server: https://api.example.com/sse (sse) - å·²æ–­å¼€è¿æ¥
```

### åˆ é™¤æœåŠ¡å™¨ (`qwen mcp remove`)

è¦ä»é…ç½®ä¸­åˆ é™¤æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `remove` å‘½ä»¤å¹¶æŒ‡å®šæœåŠ¡å™¨åç§°ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp remove <name>
```

**ç¤ºä¾‹ï¼š**

```bash
qwen mcp remove my-server
```

è¿™å°†æ ¹æ®ä½œç”¨åŸŸ (`-s, --scope`) åœ¨ç›¸åº”çš„ `settings.json` æ–‡ä»¶ä¸­æ‰¾åˆ°å¹¶åˆ é™¤ `mcpServers` å¯¹è±¡ä¸­çš„ "my-server" æ¡ç›®ã€‚