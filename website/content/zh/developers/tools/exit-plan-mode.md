# 退出计划模式工具 (`exit_plan_mode`)

本文档描述了 Qwen Code 的 `exit_plan_mode` 工具。

## 描述

当你处于计划模式并且已完成展示你的实现计划时，请使用 `exit_plan_mode`。此工具会提示用户批准或拒绝该计划，并从计划模式过渡到实现模式。

该工具专为需要在编写代码之前规划实现步骤的任务而设计。它不应被用于研究或信息收集类任务。

### 参数

`exit_plan_mode` 接受一个参数：

- `plan`（字符串，必填）：你希望向用户展示以供批准的实现计划。这应该是一个简洁的、markdown 格式的计划，描述实现步骤。

## 如何在 Qwen Code 中使用 `exit_plan_mode`

退出计划模式工具是 Qwen Code 规划工作流的一部分。当你处于计划模式时（通常是在探索代码库并设计实现方案之后），你可以使用此工具来：

1. 向用户展示你的实现计划
2. 请求批准以继续进行实现
3. 根据用户的响应从计划模式过渡到实现模式

该工具会向用户显示你的计划，并提供以下选项：

- **仅本次执行**：仅在此会话中批准该计划
- **始终执行**：批准该计划并为未来的编辑操作启用自动批准
- **取消**：拒绝该计划并保持在计划模式

用法：

```
exit_plan_mode(plan="在此处填写你详细的实现计划...")
```

## 何时使用此工具

在以下情况下使用 `exit_plan_mode`：

1. **实现任务**：你正在为编码任务规划实现步骤
2. **计划完成**：你已完成探索和设计实现方案
3. **需要用户批准**：在继续进行代码更改之前需要用户确认
4. **代码编写任务**：任务涉及编写、修改或重构代码

### 适当使用的示例：

- "帮助我实现用户认证" → 在规划完认证系统实现后使用
- "添加一个新的用户管理API端点" → 在设计完端点结构后使用
- "重构数据库层以使用TypeORM" → 在规划完重构方法后使用

## 何时不使用此工具

不要对以下情况使用 `exit_plan_mode`：

1. **研究任务**：专注于理解或探索现有代码的任务
2. **信息收集**：仅进行搜索、阅读或分析而不实施的任务
3. **文档任务**：创建文档但不涉及代码更改的任务
4. **分析任务**：提供解释或审查但不实施的任务

### 不当使用的示例：

- "在代码库中搜索并理解 vim 模式的实现" → 不要使用（研究任务）
- "解释认证系统的工作原理" → 不要使用（分析任务）
- "查找项目中的所有 TODO 注释" → 不要使用（信息收集）

## `exit_plan_mode` 示例

### 实施规划示例

```
exit_plan_mode(plan="## 用户仪表板的实施计划

### 1. 创建仪表板组件
- 创建 `UserDashboard.tsx` 用于主仪表板布局
- 添加 `DashboardStats.tsx` 用于显示用户统计数据
- 实现 `ActivityFeed.tsx` 用于展示最近的用户活动

### 2. 添加 API 集成
- 创建 `dashboardApi.ts` 用于获取仪表板数据
- 添加用户统计和活动数据的端点
- 实现错误处理和加载状态

### 3. 更新路由
- 在 `App.tsx` 中添加仪表板路由
- 更新导航组件，加入仪表板链接
- 为认证用户添加路由保护

### 4. 测试与文档
- 编写仪表板组件的单元测试
- 添加 API 调用的集成测试
- 更新用户文档，介绍仪表板功能

此实现大约需要 4-6 小时，并需修改 8-10 个文件。")
```

### 重构计划示例

```
exit_plan_mode(plan="## 数据库层重构计划

### 第一阶段：设置与配置
- 安装并配置 TypeORM 依赖项
- 创建数据库连接配置
- 为现有模型设置实体定义

### 第二阶段：迁移
- 为现有数据创建迁移脚本
- 使用 TypeORM 实现新的仓储模式
- 将原生 SQL 查询替换为 TypeORM 查询构建器

### 第三阶段：测试与验证
- 更新所有数据库测试以使用 TypeORM
- 验证迁移后的数据完整性
- 进行性能测试以确保无性能倒退

此次重构将在保持向后兼容性的同时，现代化我们的数据库层。")```

## 用户响应处理

调用 `exit_plan_mode` 后，用户可以通过以下几种方式响应：

- **执行一次**：计划被批准，并使用默认确认设置立即实施
- **始终执行**：计划被批准，并为后续编辑操作启用自动批准
- **取消**：计划被拒绝，系统保持在计划模式以进行进一步规划

工具会根据用户的选择自动调整批准模式，从而按照用户的偏好简化实施流程。

## 重要说明

- **仅限计划模式**：此工具仅应在当前处于计划模式时使用
- **实现重点**：仅用于涉及编写或修改代码的任务
- **简洁计划**：保持计划聚焦且简洁——追求清晰而非详尽细节
- **Markdown 支持**：计划支持 markdown 格式以提高可读性
- **单次使用**：每次计划会话准备继续时应仅使用一次该工具
- **用户控制**：最终是否继续的决定权始终在用户手中

## 与规划工作流的集成

退出计划模式工具是更大规划工作流的一部分：

1. **进入计划模式**：用户请求或系统确定需要进行规划
2. **探索阶段**：分析代码库，理解需求，探索选项
3. **计划设计**：基于探索结果创建实施策略
4. **计划展示**：使用 `exit_plan_mode` 向用户展示计划
5. **实施阶段**：获得批准后，按照计划进行实施

此工作流确保了深思熟虑的实施方法，并让用户能够控制重要的代码变更。