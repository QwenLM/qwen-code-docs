# ä½¿ç”¨ Qwen Code çš„ MCP æœåŠ¡å™¨

æœ¬æ–‡æ¡£æä¾›äº†é…ç½®å’Œä½¿ç”¨ Model Context Protocol (MCP) æœåŠ¡å™¨ä¸ Qwen Code é…åˆçš„æŒ‡å—ã€‚

## ä»€ä¹ˆæ˜¯ MCP serverï¼Ÿ

MCP server æ˜¯ä¸€ä¸ªé€šè¿‡ Model Context Protocol å‘ CLI æš´éœ²å·¥å…·å’Œèµ„æºçš„åº”ç”¨ç¨‹åºï¼Œä½¿å…¶èƒ½å¤Ÿä¸å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æºè¿›è¡Œäº¤äº’ã€‚MCP server å……å½“äº†æ¨¡å‹ä¸ä½ çš„æœ¬åœ°ç¯å¢ƒæˆ–å…¶ä»–æœåŠ¡ï¼ˆå¦‚ APIï¼‰ä¹‹é—´çš„æ¡¥æ¢ã€‚

MCP server ä½¿ CLI èƒ½å¤Ÿï¼š

- **å‘ç°å·¥å…·**ï¼šé€šè¿‡æ ‡å‡†åŒ–çš„ schema å®šä¹‰åˆ—å‡ºå¯ç”¨çš„å·¥å…·ã€å®ƒä»¬çš„æè¿°å’Œå‚æ•°ã€‚
- **æ‰§è¡Œå·¥å…·**ï¼šä½¿ç”¨å®šä¹‰å¥½çš„å‚æ•°è°ƒç”¨ç‰¹å®šå·¥å…·ï¼Œå¹¶æ¥æ”¶ç»“æ„åŒ–çš„å“åº”ã€‚
- **è®¿é—®èµ„æº**ï¼šä»ç‰¹å®šèµ„æºä¸­è¯»å–æ•°æ®ï¼ˆå°½ç®¡ CLI ä¸»è¦ä¸“æ³¨äºå·¥å…·æ‰§è¡Œï¼‰ã€‚

é€šè¿‡ MCP serverï¼Œä½ å¯ä»¥æ‰©å±• CLI çš„åŠŸèƒ½ï¼Œä½¿å…¶æ‰§è¡Œè¶…å‡ºå…¶å†…ç½®ç‰¹æ€§ä¹‹å¤–çš„æ“ä½œï¼Œä¾‹å¦‚ä¸æ•°æ®åº“ã€APIã€è‡ªå®šä¹‰è„šæœ¬æˆ–ä¸“ä¸šå·¥ä½œæµè¿›è¡Œäº¤äº’ã€‚

## æ ¸å¿ƒé›†æˆæ¶æ„

Qwen Code é€šè¿‡æ ¸å¿ƒåŒ…ï¼ˆ`packages/core/src/tools/`ï¼‰ä¸­å†…ç½®çš„ä¸€å¥—å¤æ‚çš„å‘ç°ä¸æ‰§è¡Œç³»ç»Ÿï¼Œä¸ MCP æœåŠ¡å™¨è¿›è¡Œé›†æˆï¼š

### å‘ç°é˜¶æ®µï¼ˆ`mcp-client.ts`ï¼‰

å‘ç°è¿‡ç¨‹ç”± `discoverMcpTools()` å‡½æ•°ç¼–æ’ï¼Œå…¶ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š

1. **éå†é…ç½®çš„æœåŠ¡å™¨**ï¼šä»ä½ çš„ `settings.json` ä¸­çš„ `mcpServers` é…ç½®è¯»å–æœåŠ¡å™¨åˆ—è¡¨  
2. **å»ºç«‹è¿æ¥**ï¼šä½¿ç”¨åˆé€‚çš„ä¼ è¾“æœºåˆ¶ï¼ˆStdioã€SSE æˆ– Streamable HTTPï¼‰ä¸å„æœåŠ¡å™¨å»ºç«‹è¿æ¥  
3. **è·å–å·¥å…·å®šä¹‰**ï¼šé€šè¿‡ MCP åè®®ä»æ¯ä¸ªæœåŠ¡å™¨è·å–å·¥å…·å®šä¹‰ä¿¡æ¯  
4. **æ¸…ç†å¹¶éªŒè¯ schema**ï¼šå¯¹å·¥å…· schema è¿›è¡Œæ¸…ç†å’ŒéªŒè¯ï¼Œç¡®ä¿å…¶ä¸ Gemini API å…¼å®¹  
5. **æ³¨å†Œå·¥å…·**ï¼šå°†å·¥å…·æ³¨å†Œåˆ°å…¨å±€å·¥å…·æ³¨å†Œè¡¨ä¸­ï¼Œå¹¶å¤„ç†å¯èƒ½çš„å‘½åå†²çªé—®é¢˜

### æ‰§è¡Œå±‚ (`mcp-tool.ts`)

æ¯ä¸ªå‘ç°çš„ MCP å·¥å…·éƒ½ä¼šè¢«å°è£…åœ¨ä¸€ä¸ª `DiscoveredMCPTool` å®ä¾‹ä¸­ï¼Œè¯¥å®ä¾‹ï¼š

- **å¤„ç†ç¡®è®¤é€»è¾‘**ï¼šæ ¹æ®æœåŠ¡å™¨ä¿¡ä»»è®¾ç½®å’Œç”¨æˆ·åå¥½è¿›è¡Œåˆ¤æ–­
- **ç®¡ç†å·¥å…·æ‰§è¡Œ**ï¼šé€šè¿‡æ­£ç¡®çš„å‚æ•°è°ƒç”¨ MCP æœåŠ¡å™¨
- **å¤„ç†å“åº”**ï¼šä¸º LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·å±•ç¤ºåˆ†åˆ«å¤„ç†è¿”å›ç»“æœ
- **ç»´æŠ¤è¿æ¥çŠ¶æ€**ï¼šå¤„ç†è¶…æ—¶ç­‰è¿æ¥é—®é¢˜

### ä¼ è¾“æœºåˆ¶

CLI æ”¯æŒä¸‰ç§ MCP ä¼ è¾“ç±»å‹ï¼š

- **Stdio Transport**ï¼šå¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹å¹¶é€šè¿‡ stdin/stdout è¿›è¡Œé€šä¿¡
- **SSE Transport**ï¼šè¿æ¥åˆ° Server-Sent Events ç«¯ç‚¹
- **Streamable HTTP Transport**ï¼šä½¿ç”¨ HTTP æµè¿›è¡Œé€šä¿¡

## å¦‚ä½•è®¾ç½®ä½ çš„ MCP æœåŠ¡å™¨

Qwen Code ä½¿ç”¨ `settings.json` æ–‡ä»¶ä¸­çš„ `mcpServers` é…ç½®æ¥å®šä½å¹¶è¿æ¥åˆ° MCP æœåŠ¡å™¨ã€‚è¯¥é…ç½®æ”¯æŒå¤šä¸ªæœåŠ¡å™¨ï¼Œå¹¶å¯ä½¿ç”¨ä¸åŒçš„ä¼ è¾“æœºåˆ¶ã€‚

### åœ¨ settings.json ä¸­é…ç½® MCP æœåŠ¡å™¨

ä½ å¯ä»¥åœ¨å…¨å±€çº§åˆ«é…ç½® MCP æœåŠ¡å™¨ï¼Œç¼–è¾‘ `~/.qwen/settings.json` æ–‡ä»¶ï¼Œæˆ–è€…åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºæˆ–æ‰“å¼€ `.qwen/settings.json` æ–‡ä»¶ã€‚åœ¨æ–‡ä»¶ä¸­æ·»åŠ  `mcp_servers` é…ç½®å—ã€‚

### é…ç½®ç»“æ„

åœ¨ä½ çš„ `settings.json` æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª `mcpServers` å¯¹è±¡ï¼š

```json
{ ...æ–‡ä»¶åŒ…å«å…¶ä»–é…ç½®å¯¹è±¡
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### é…ç½®å±æ€§

æ¯ä¸ªæœåŠ¡å™¨é…ç½®æ”¯æŒä»¥ä¸‹å±æ€§ï¼š

#### å¿…å¡«ï¼ˆä»¥ä¸‹ä»»é€‰å…¶ä¸€ï¼‰

- **`command`** (string): Stdio transport çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
- **`url`** (string): SSE endpoint URL (ä¾‹å¦‚ `"http://localhost:8080/sse"`)
- **`httpUrl`** (string): HTTP streaming endpoint URL

#### å¯é€‰å‚æ•°

- **`args`** (string[]): ç”¨äº Stdio ä¼ è¾“çš„å‘½ä»¤è¡Œå‚æ•°
- **`headers`** (object): ä½¿ç”¨ `url` æˆ– `httpUrl` æ—¶çš„è‡ªå®šä¹‰ HTTP headers
- **`env`** (object): æœåŠ¡å™¨è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚å€¼å¯ä»¥ä½¿ç”¨ `$VAR_NAME` æˆ– `${VAR_NAME}` è¯­æ³•å¼•ç”¨ç¯å¢ƒå˜é‡
- **`cwd`** (string): Stdio ä¼ è¾“çš„å·¥ä½œç›®å½•
- **`timeout`** (number): è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼ˆé»˜è®¤å€¼ï¼š600,000ms = 10åˆ†é’Ÿï¼‰
- **`trust`** (boolean): å½“è®¾ç½®ä¸º `true` æ—¶ï¼Œå°†è·³è¿‡æ­¤æœåŠ¡å™¨çš„æ‰€æœ‰ tool call ç¡®è®¤ï¼ˆé»˜è®¤å€¼ï¼š`false`ï¼‰
- **`includeTools`** (string[]): ä»è¯¥ MCP æœåŠ¡å™¨åŒ…å«çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æŒ‡å®šåï¼Œåªæœ‰æ­¤å¤„åˆ—å‡ºçš„å·¥å…·æ‰å¯ä»æ­¤æœåŠ¡å™¨ä½¿ç”¨ï¼ˆç™½åå•è¡Œä¸ºï¼‰ã€‚æœªæŒ‡å®šæ—¶ï¼Œé»˜è®¤å¯ç”¨æœåŠ¡å™¨æä¾›çš„æ‰€æœ‰å·¥å…·ã€‚
- **`excludeTools`** (string[]): ä»è¯¥ MCP æœåŠ¡å™¨æ’é™¤çš„å·¥å…·åç§°åˆ—è¡¨ã€‚å³ä½¿æœåŠ¡å™¨æä¾›äº†è¿™äº›å·¥å…·ï¼Œæ¨¡å‹ä¹Ÿæ— æ³•ä½¿ç”¨ã€‚**æ³¨æ„ï¼š** `excludeTools` çš„ä¼˜å…ˆçº§é«˜äº `includeTools` â€”â€” å¦‚æœæŸä¸ªå·¥å…·åŒæ—¶å‡ºç°åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­ï¼Œå®ƒå°†è¢«æ’é™¤ã€‚

### è¿œç¨‹ MCP æœåŠ¡å™¨çš„ OAuth æ”¯æŒ

Qwen Code æ”¯æŒé€šè¿‡ SSE æˆ– HTTP ä¼ è¾“æ–¹å¼å¯¹è¿œç¨‹ MCP æœåŠ¡å™¨è¿›è¡Œ OAuth 2.0 è®¤è¯ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥å®‰å…¨åœ°è®¿é—®éœ€è¦è®¤è¯çš„ MCP æœåŠ¡å™¨ã€‚

#### è‡ªåŠ¨ OAuth å‘ç°

å¯¹äºæ”¯æŒ OAuth å‘ç°çš„æœåŠ¡å™¨ï¼Œä½ å¯ä»¥çœç•¥ OAuth é…ç½®ï¼Œè®© CLI è‡ªåŠ¨å®Œæˆå‘ç°ï¼š

```json
{
  "mcpServers": {
    "discoveredServer": {
      "url": "https://api.example.com/sse"
    }
  }
}
```

CLI å°†è‡ªåŠ¨ï¼š

- æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦éœ€è¦ OAuth è®¤è¯ï¼ˆ401 å“åº”ï¼‰
- ä»æœåŠ¡å™¨å…ƒæ•°æ®ä¸­å‘ç° OAuth ç«¯ç‚¹
- å¦‚æœæ”¯æŒï¼Œæ‰§è¡ŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ
- å¤„ç† OAuth æµç¨‹å’Œ token ç®¡ç†

#### Authentication Flow

å½“è¿æ¥åˆ°å¯ç”¨ OAuth çš„æœåŠ¡å™¨æ—¶ï¼š

1. **åˆå§‹è¿æ¥å°è¯•** å¤±è´¥ï¼Œè¿”å› 401 Unauthorized
2. **OAuth discovery** æ‰¾åˆ° authorization å’Œ token endpoints
3. **æµè§ˆå™¨æ‰“å¼€** è¿›è¡Œç”¨æˆ·è®¤è¯ï¼ˆéœ€è¦æœ¬åœ°æµè§ˆå™¨è®¿é—®æƒé™ï¼‰
4. **Authorization code** æ¢å– access tokens
5. **Tokens è¢«å®‰å…¨å­˜å‚¨** ä¾›åç»­ä½¿ç”¨
6. **è¿æ¥é‡è¯•** ä½¿ç”¨æœ‰æ•ˆ tokens æˆåŠŸè¿æ¥

#### Browser Redirect Requirements

**é‡è¦æç¤ºï¼š** OAuth è®¤è¯è¦æ±‚ä½ çš„æœ¬åœ°æœºå™¨èƒ½å¤Ÿï¼š

- æ‰“å¼€ç½‘é¡µæµè§ˆå™¨è¿›è¡Œè®¤è¯
- æ¥æ”¶æ¥è‡ª `http://localhost:7777/oauth/callback` çš„é‡å®šå‘

ä»¥ä¸‹ç¯å¢ƒå°†æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½ï¼š

- æ— æµè§ˆå™¨è®¿é—®æƒé™çš„ headless ç¯å¢ƒ
- æœªå¯ç”¨ X11 forwarding çš„è¿œç¨‹ SSH ä¼šè¯
- ä¸æ”¯æŒæµè§ˆå™¨çš„å®¹å™¨åŒ–ç¯å¢ƒ

#### Managing OAuth Authentication

ä½¿ç”¨ `/mcp auth` å‘½ä»¤ç®¡ç† OAuth è®¤è¯ï¼š

```bash

# åˆ—å‡ºéœ€è¦è®¤è¯çš„æœåŠ¡å™¨
/mcp auth
```

```markdown
# ä¸ç‰¹å®šæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName

# å¦‚æœ token è¿‡æœŸåˆ™é‡æ–°è®¤è¯
/mcp auth serverName
```

#### OAuth é…ç½®å±æ€§

- **`enabled`** (boolean): ä¸ºæ­¤æœåŠ¡å™¨å¯ç”¨ OAuth
- **`clientId`** (string): OAuth client IDï¼ˆä½¿ç”¨åŠ¨æ€æ³¨å†Œæ—¶å¯é€‰ï¼‰
- **`clientSecret`** (string): OAuth client secretï¼ˆå¯¹äºå…¬å…±å®¢æˆ·ç«¯å¯é€‰ï¼‰
- **`authorizationUrl`** (string): OAuth æˆæƒç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`tokenUrl`** (string): OAuth token ç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`scopes`** (string[]): å¿…éœ€çš„ OAuth scopes
- **`redirectUri`** (string): è‡ªå®šä¹‰ redirect URIï¼ˆé»˜è®¤ä¸º `http://localhost:7777/oauth/callback`ï¼‰
- **`tokenParamName`** (string): SSE URLs ä¸­ token çš„æŸ¥è¯¢å‚æ•°åç§°
- **`audiences`** (string[]): token æœ‰æ•ˆçš„ audiences
```

#### Token ç®¡ç†

OAuth tokens ä¼šè‡ªåŠ¨ï¼š

- **å®‰å…¨å­˜å‚¨** åœ¨ `~/.qwen/mcp-oauth-tokens.json` ä¸­
- **è‡ªåŠ¨åˆ·æ–°**ï¼ˆå¦‚æœæä¾›äº† refresh tokenï¼Œåˆ™åœ¨è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°ï¼‰
- **è¿æ¥å‰éªŒè¯** æ¯æ¬¡è¿æ¥å°è¯•å‰éƒ½ä¼šè¿›è¡Œæœ‰æ•ˆæ€§éªŒè¯
- **æ¸…ç†æ— æ•ˆæˆ–è¿‡æœŸçš„ token** å½“ token æ— æ•ˆæˆ–è¿‡æœŸæ—¶ä¼šè¢«è‡ªåŠ¨æ¸…é™¤

#### è®¤è¯æä¾›è€…ç±»å‹

ä½ å¯ä»¥ä½¿ç”¨ `authProviderType` å±æ€§æ¥æŒ‡å®šè®¤è¯æä¾›è€…ç±»å‹ï¼š

- **`authProviderType`** (string)ï¼šæŒ‡å®šè®¤è¯æä¾›è€…ã€‚å¯ä»¥æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€ï¼š
  - **`dynamic_discovery`**ï¼ˆé»˜è®¤ï¼‰ï¼šCLI å°†è‡ªåŠ¨ä»æœåŠ¡å™¨å‘ç° OAuth é…ç½®ã€‚
  - **`google_credentials`**ï¼šCLI å°†ä½¿ç”¨ Google Application Default Credentials (ADC) æ¥ä¸æœåŠ¡å™¨è¿›è¡Œè®¤è¯ã€‚ä½¿ç”¨æ­¤æä¾›è€…æ—¶ï¼Œä½ å¿…é¡»æŒ‡å®šæ‰€éœ€çš„ scopesã€‚

```json
{
  "mcpServers": {
    "googleCloudServer": {
      "httpUrl": "https://my-gcp-service.run.app/mcp",
      "authProviderType": "google_credentials",
      "oauth": {
        "scopes": ["https://www.googleapis.com/auth/userinfo.email"]
      }
    }
  }
}
```

### ç¤ºä¾‹é…ç½®

#### Python MCP Server (Stdio)

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

#### Node.js MCP Server (Stdio)

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

#### åŸºäº Docker çš„ MCP Server

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

#### åŸºäº HTTP çš„ MCP Server

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

#### å¸¦è‡ªå®šä¹‰ Headers çš„åŸºäº HTTP çš„ MCP Server

```json
{
  "mcpServers": {
    "httpServerWithAuth": {
      "httpUrl": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer your-api-token",
        "X-Custom-Header": "custom-value",
        "Content-Type": "application/json"
      },
      "timeout": 5000
    }
  }
}
```

#### å¸¦ Tool è¿‡æ»¤çš„ MCP Server

```json
{
  "mcpServers": {
    "filteredServer": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "includeTools": ["safe_tool", "file_reader", "data_processor"],
      // "excludeTools": ["dangerous_tool", "file_deleter"],
      "timeout": 30000
    }
  }
}
```

## Discovery Process Deep Dive

å½“ Qwen Code å¯åŠ¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡ä»¥ä¸‹è¯¦ç»†æµç¨‹æ‰§è¡Œ MCP server çš„ discoveryï¼š

### 1. æœåŠ¡å™¨è¿­ä»£ä¸è¿æ¥

å¯¹äº `mcpServers` ä¸­é…ç½®çš„æ¯ä¸ª serverï¼š

1. **çŠ¶æ€è·Ÿè¸ªå¼€å§‹ï¼š** Server çŠ¶æ€è¢«è®¾ç½®ä¸º `CONNECTING`
2. **Transport é€‰æ‹©ï¼š** æ ¹æ®é…ç½®å±æ€§ï¼š
   - `httpUrl` â†’ `StreamableHTTPClientTransport`
   - `url` â†’ `SSEClientTransport`
   - `command` â†’ `StdioClientTransport`
3. **å»ºç«‹è¿æ¥ï¼š** MCP client å°è¯•åœ¨é…ç½®çš„ timeout å†…å»ºç«‹è¿æ¥
4. **é”™è¯¯å¤„ç†ï¼š** è¿æ¥å¤±è´¥ä¼šè¢«è®°å½•æ—¥å¿—ï¼Œserver çŠ¶æ€è¢«è®¾ç½®ä¸º `DISCONNECTED`

### 2. å·¥å…·å‘ç°

è¿æ¥æˆåŠŸåï¼š

1. **å·¥å…·åˆ—è¡¨è·å–ï¼š** å®¢æˆ·ç«¯è°ƒç”¨ MCP æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨ endpoint
2. **Schema éªŒè¯ï¼š** éªŒè¯æ¯ä¸ªå·¥å…·çš„ function å£°æ˜
3. **å·¥å…·è¿‡æ»¤ï¼š** æ ¹æ® `includeTools` å’Œ `excludeTools` é…ç½®è¿‡æ»¤å·¥å…·
4. **åç§°æ¸…ç†ï¼š** æ¸…ç†å·¥å…·åç§°ä»¥æ»¡è¶³ Gemini API è¦æ±‚ï¼š
   - å°†æ— æ•ˆå­—ç¬¦ï¼ˆéå­—æ¯æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹ã€è¿å­—ç¬¦ï¼‰æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
   - è¶…è¿‡ 63 ä¸ªå­—ç¬¦çš„åç§°ä¼šè¢«æˆªæ–­å¹¶ç”¨ä¸­é—´æ›¿æ¢æ³•å¤„ç†ï¼ˆ`___`ï¼‰

### 3. å†²çªè§£å†³

å½“å¤šä¸ªæœåŠ¡å™¨æš´éœ²åŒåå·¥å…·æ—¶ï¼š

1. **é¦–æ¬¡æ³¨å†Œä¼˜å…ˆï¼š** ç¬¬ä¸€ä¸ªæ³¨å†Œå·¥å…·åç§°çš„æœåŠ¡å™¨è·å¾—æ— å‰ç¼€çš„åç§°
2. **è‡ªåŠ¨æ·»åŠ å‰ç¼€ï¼š** åç»­æœåŠ¡å™¨çš„å·¥å…·åç§°ä¼šè¢«è‡ªåŠ¨æ·»åŠ å‰ç¼€ï¼š`serverName__toolName`
3. **æ³¨å†Œè¡¨è·Ÿè¸ªï¼š** å·¥å…·æ³¨å†Œè¡¨ç»´æŠ¤æœåŠ¡å™¨åç§°ä¸å…¶å·¥å…·ä¹‹é—´çš„æ˜ å°„å…³ç³»

### 4. Schema å¤„ç†

å·¥å…·å‚æ•° schema ä¼šç»è¿‡æ¸…ç†ä»¥ç¡®ä¿ API å…¼å®¹æ€§ï¼š

- **`$schema` å±æ€§** ä¼šè¢«ç§»é™¤
- **`additionalProperties`** ä¼šè¢«å‰¥ç¦»
- **åŒ…å« `default` çš„ `anyOf`** ä¼šç§»é™¤é»˜è®¤å€¼ï¼ˆä¸ºäº†å…¼å®¹ Vertex AIï¼‰
- **é€’å½’å¤„ç†** ä¼šåº”ç”¨åˆ°åµŒå¥—çš„ schema

### 5. è¿æ¥ç®¡ç†

åœ¨å‘ç°é˜¶æ®µä¹‹åï¼š

- **æŒä¹…è¿æ¥ï¼š** æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨ä¼šä¿æŒè¿æ¥
- **æ¸…ç†ï¼š** æ²¡æœ‰æä¾›å¯ç”¨å·¥å…·çš„æœåŠ¡å™¨è¿æ¥ä¼šè¢«å…³é—­
- **çŠ¶æ€æ›´æ–°ï¼š** æœ€ç»ˆæœåŠ¡å™¨çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸º `CONNECTED` æˆ– `DISCONNECTED`

## å·¥å…·æ‰§è¡Œæµç¨‹

å½“æ¨¡å‹å†³å®šä½¿ç”¨æŸä¸ª MCP å·¥å…·æ—¶ï¼Œä¼šæŒ‰ç…§ä»¥ä¸‹æµç¨‹æ‰§è¡Œï¼š

### 1. å·¥å…·è°ƒç”¨

æ¨¡å‹ä¼šç”Ÿæˆä¸€ä¸ª `FunctionCall`ï¼ŒåŒ…å«ï¼š

- **å·¥å…·åç§°ï¼š** å·²æ³¨å†Œçš„åç§°ï¼ˆå¯èƒ½å¸¦æœ‰å‰ç¼€ï¼‰
- **å‚æ•°ï¼š** ç¬¦åˆå·¥å…·å‚æ•° schema çš„ JSON å¯¹è±¡

### 2. ç¡®è®¤æµç¨‹

æ¯ä¸ª `DiscoveredMCPTool` éƒ½å®ç°äº†å¤æ‚çš„ç¡®è®¤é€»è¾‘ï¼š

#### åŸºäºä¿¡ä»»çš„è·³è¿‡æœºåˆ¶

```typescript
if (this.trust) {
  return false; // æ— éœ€ç¡®è®¤
}
```

#### åŠ¨æ€ç™½åå•ç®¡ç†

ç³»ç»Ÿç»´æŠ¤ä»¥ä¸‹å†…éƒ¨ç™½åå•ï¼š

- **æœåŠ¡å™¨çº§åˆ«ï¼š** `serverName` â†’ æ¥è‡ªæ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·éƒ½è¢«ä¿¡ä»»
- **å·¥å…·çº§åˆ«ï¼š** `serverName.toolName` â†’ æ­¤ç‰¹å®šå·¥å…·è¢«ä¿¡ä»»

#### ç”¨æˆ·é€‰æ‹©å¤„ç†

å½“éœ€è¦ç¡®è®¤æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š

- **ä»…æœ¬æ¬¡æ‰§è¡Œï¼š** åªæ‰§è¡Œè¿™ä¸€æ¬¡
- **å§‹ç»ˆå…è®¸æ­¤å·¥å…·ï¼š** æ·»åŠ åˆ°å·¥å…·çº§åˆ«ç™½åå•
- **å§‹ç»ˆå…è®¸æ­¤æœåŠ¡å™¨ï¼š** æ·»åŠ åˆ°æœåŠ¡å™¨çº§åˆ«ç™½åå•
- **å–æ¶ˆï¼š** ä¸­æ­¢æ‰§è¡Œ

### 3. æ‰§è¡Œ

ç¡®è®¤åï¼ˆæˆ–ç»•è¿‡ä¿¡ä»»æœºåˆ¶ï¼‰ï¼š

1. **å‚æ•°å‡†å¤‡ï¼š** å‚æ•°ä¼šæ ¹æ®å·¥å…·çš„ schema è¿›è¡ŒéªŒè¯
2. **MCP è°ƒç”¨ï¼š** åº•å±‚çš„ `CallableTool` ä¼šå‘æœåŠ¡å™¨å‘èµ·è°ƒç”¨ï¼š

   ```typescript
   const functionCalls = [
     {
       name: this.serverToolName, // åŸå§‹æœåŠ¡å™¨å·¥å…·åç§°
       args: params,
     },
   ];
   ```

3. **å“åº”å¤„ç†ï¼š** ç»“æœä¼šè¢«æ ¼å¼åŒ–ï¼Œåˆ†åˆ«ç”¨äº LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·å±•ç¤º

### 4. å“åº”å¤„ç†

æ‰§è¡Œç»“æœåŒ…å«ï¼š

- **`llmContent`ï¼š** ä¾›è¯­è¨€æ¨¡å‹ä½¿ç”¨çš„åŸå§‹å“åº”å†…å®¹
- **`returnDisplay`ï¼š** ä¾›ç”¨æˆ·å±•ç¤ºçš„æ ¼å¼åŒ–è¾“å‡ºï¼ˆé€šå¸¸æ˜¯ markdown ä»£ç å—ä¸­çš„ JSONï¼‰

## å¦‚ä½•ä¸ä½ çš„ MCP æœåŠ¡å™¨äº¤äº’

### ä½¿ç”¨ `/mcp` å‘½ä»¤

`/mcp` å‘½ä»¤æä¾›å…³äºä½ çš„ MCP æœåŠ¡å™¨è®¾ç½®çš„å®Œæ•´ä¿¡æ¯ï¼š

```bash
/mcp
```

è¯¥å‘½ä»¤ä¼šæ˜¾ç¤ºä»¥ä¸‹å†…å®¹ï¼š

- **æœåŠ¡å™¨åˆ—è¡¨ï¼š** æ‰€æœ‰å·²é…ç½®çš„ MCP æœåŠ¡å™¨
- **è¿æ¥çŠ¶æ€ï¼š** `CONNECTED`ã€`CONNECTING` æˆ– `DISCONNECTED`
- **æœåŠ¡å™¨è¯¦æƒ…ï¼š** é…ç½®æ‘˜è¦ï¼ˆä¸åŒ…å«æ•æ„Ÿæ•°æ®ï¼‰
- **å¯ç”¨å·¥å…·ï¼š** æ¯ä¸ªæœåŠ¡å™¨æä¾›çš„å·¥å…·åˆ—è¡¨åŠå…¶æè¿°
- **å‘ç°çŠ¶æ€ï¼š** æ•´ä½“ discovery è¿‡ç¨‹çš„çŠ¶æ€

### ç¤ºä¾‹ `/mcp` è¾“å‡º

```
MCP Servers Status:

ğŸ“¡ pythonTools (CONNECTED)
  Command: python -m my_mcp_server --port 8080
  Working Directory: ./mcp-servers/python
  Timeout: 15000ms
  Tools: calculate_sum, file_analyzer, data_processor

ğŸ”Œ nodeServer (DISCONNECTED)
  Command: node dist/server.js --verbose
  Error: Connection refused

ğŸ³ dockerizedServer (CONNECTED)
  Command: docker run -i --rm -e API_KEY my-mcp-server:latest
  Tools: docker__deploy, docker__status

Discovery State: COMPLETED
```

### å·¥å…·ä½¿ç”¨

ä¸€æ—¦è¢«å‘ç°ï¼ŒMCP å·¥å…·å°±ä¼šåƒå†…ç½®å·¥å…·ä¸€æ ·æä¾›ç»™ Gemini æ¨¡å‹ä½¿ç”¨ã€‚æ¨¡å‹å°†è‡ªåŠ¨ï¼š

1. **æ ¹æ®ä½ çš„è¯·æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·**
2. **æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†**ï¼ˆé™¤éæœåŠ¡å™¨æ˜¯å—ä¿¡ä»»çš„ï¼‰
3. **ä½¿ç”¨æ­£ç¡®çš„å‚æ•°æ‰§è¡Œå·¥å…·**
4. **ä»¥ç”¨æˆ·å‹å¥½çš„æ ¼å¼æ˜¾ç¤ºç»“æœ**

## çŠ¶æ€ç›‘æ§å’Œæ•…éšœæ’é™¤

### è¿æ¥çŠ¶æ€

MCP é›†æˆä¼šè·Ÿè¸ªå‡ ç§çŠ¶æ€ï¼š

#### æœåŠ¡å™¨çŠ¶æ€ (`MCPServerStatus`)

- **`DISCONNECTED`:** æœåŠ¡å™¨æœªè¿æ¥æˆ–å‡ºç°é”™è¯¯
- **`CONNECTING`:** æ­£åœ¨å°è¯•è¿æ¥
- **`CONNECTED`:** æœåŠ¡å™¨å·²è¿æ¥å¹¶å‡†å¤‡å°±ç»ª

#### å‘ç°é˜¶æ®µ (`MCPDiscoveryState`)

- **`NOT_STARTED`:** å‘ç°å°šæœªå¼€å§‹
- **`IN_PROGRESS`:** æ­£åœ¨å‘ç°æœåŠ¡å™¨
- **`COMPLETED`:** å‘ç°å·²å®Œæˆï¼ˆæ— è®ºæ˜¯å¦æœ‰é”™è¯¯ï¼‰

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### æœåŠ¡å™¨æ— æ³•è¿æ¥

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨æ˜¾ç¤º `DISCONNECTED` çŠ¶æ€

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥é…ç½®ï¼š** ç¡®è®¤ `command`ã€`args` å’Œ `cwd` é…ç½®æ­£ç¡®
2. **æ‰‹åŠ¨æµ‹è¯•ï¼š** ç›´æ¥è¿è¡ŒæœåŠ¡å™¨å‘½ä»¤ï¼Œç¡®ä¿å¯ä»¥æ­£å¸¸å·¥ä½œ
3. **æ£€æŸ¥ä¾èµ–ï¼š** ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„ packages éƒ½å·²å®‰è£…
4. **æŸ¥çœ‹æ—¥å¿—ï¼š** æ£€æŸ¥ CLI è¾“å‡ºä¸­çš„é”™è¯¯ä¿¡æ¯
5. **éªŒè¯æƒé™ï¼š** ç¡®ä¿ CLI å¯ä»¥æ‰§è¡ŒæœåŠ¡å™¨å‘½ä»¤

#### æœªå‘ç°å·¥å…·

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨è¿æ¥æˆåŠŸä½†æ²¡æœ‰å¯ç”¨å·¥å…·

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **éªŒè¯å·¥å…·æ³¨å†Œï¼š** ç¡®ä¿ä½ çš„æœåŠ¡å™¨å®é™…æ³¨å†Œäº†å·¥å…·
2. **æ£€æŸ¥ MCP åè®®ï¼š** ç¡®è®¤ä½ çš„æœåŠ¡å™¨æ­£ç¡®å®ç°äº† MCP å·¥å…·åˆ—è¡¨åŠŸèƒ½
3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š** æ£€æŸ¥ stderr è¾“å‡ºä¸­çš„æœåŠ¡å™¨ç«¯é”™è¯¯
4. **æµ‹è¯•å·¥å…·åˆ—è¡¨ï¼š** æ‰‹åŠ¨æµ‹è¯•æœåŠ¡å™¨çš„å·¥å…·å‘ç° endpoint

#### å·¥å…·æ— æ³•æ‰§è¡Œ

**ç—‡çŠ¶ï¼š** å·¥å…·è¢«å‘ç°ä½†æ‰§è¡Œæ—¶å¤±è´¥

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **å‚æ•°éªŒè¯ï¼š** ç¡®ä¿ä½ çš„ tool èƒ½æ¥å—é¢„æœŸçš„å‚æ•°
2. **Schema å…¼å®¹æ€§ï¼š** éªŒè¯ä½ çš„ input schemas æ˜¯æœ‰æ•ˆçš„ JSON Schema
3. **é”™è¯¯å¤„ç†ï¼š** æ£€æŸ¥ä½ çš„ tool æ˜¯å¦æŠ›å‡ºäº†æœªå¤„ç†çš„å¼‚å¸¸
4. **è¶…æ—¶é—®é¢˜ï¼š** è€ƒè™‘å¢åŠ  `timeout` è®¾ç½®

#### æ²™ç›’å…¼å®¹æ€§

**ç—‡çŠ¶ï¼š** å¯ç”¨æ²™ç›’æ—¶ MCP servers å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**

1. **åŸºäº Docker çš„ serversï¼š** ä½¿ç”¨åŒ…å«æ‰€æœ‰ä¾èµ–çš„ Docker å®¹å™¨
2. **è·¯å¾„å¯è®¿é—®æ€§ï¼š** ç¡®ä¿ server å¯æ‰§è¡Œæ–‡ä»¶åœ¨æ²™ç›’ä¸­å¯ç”¨
3. **ç½‘ç»œè®¿é—®ï¼š** é…ç½®æ²™ç›’ä»¥å…è®¸å¿…è¦çš„ç½‘ç»œè¿æ¥
4. **ç¯å¢ƒå˜é‡ï¼š** éªŒè¯æ‰€éœ€çš„ç¯å¢ƒå˜é‡å·²æ­£ç¡®ä¼ é€’

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š** ä½¿ç”¨ `--debug` å‚æ•°è¿è¡Œ CLI ä»¥è·å–è¯¦ç»†è¾“å‡º
2. **æ£€æŸ¥ stderrï¼š** MCP æœåŠ¡å™¨çš„ stderr è¾“å‡ºä¼šè¢«æ•è·å¹¶è®°å½•ï¼ˆINFO çº§åˆ«æ¶ˆæ¯ä¼šè¢«è¿‡æ»¤ï¼‰
3. **ç‹¬ç«‹æµ‹è¯•ï¼š** åœ¨é›†æˆä¹‹å‰ï¼Œå…ˆç‹¬ç«‹æµ‹è¯•ä½ çš„ MCP æœåŠ¡å™¨
4. **å¢é‡é…ç½®ï¼š** ä»ç®€å•å·¥å…·å¼€å§‹ï¼Œå†é€æ­¥æ·»åŠ å¤æ‚åŠŸèƒ½
5. **é¢‘ç¹ä½¿ç”¨ `/mcp`ï¼š** åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç›‘æ§æœåŠ¡å™¨çŠ¶æ€

## é‡è¦è¯´æ˜

### å®‰å…¨æ³¨æ„äº‹é¡¹

- **ä¿¡ä»»è®¾ç½®ï¼š** `trust` é€‰é¡¹ä¼šè·³è¿‡æ‰€æœ‰ç¡®è®¤å¯¹è¯æ¡†ã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œä»…ç”¨äºä½ å®Œå…¨æ§åˆ¶çš„æœåŠ¡å™¨
- **è®¿é—®ä»¤ç‰Œï¼š** é…ç½®åŒ…å« API key æˆ– token çš„ç¯å¢ƒå˜é‡æ—¶è¦æ³¨æ„å®‰å…¨æ€§
- **æ²™ç›’å…¼å®¹æ€§ï¼š** ä½¿ç”¨æ²™ç›’æ—¶ï¼Œç¡®ä¿ MCP æœåŠ¡å™¨åœ¨æ²™ç›’ç¯å¢ƒä¸­å¯ç”¨
- **ç§æœ‰æ•°æ®ï¼š** ä½¿ç”¨èŒƒå›´è¿‡å¹¿çš„ personal access token å¯èƒ½å¯¼è‡´ä¸åŒä»“åº“é—´çš„ä¿¡æ¯æ³„éœ²

### æ€§èƒ½ä¸èµ„æºç®¡ç†

- **è¿æ¥æŒä¹…åŒ–ï¼š** CLI ä¼šå¯¹æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨ä¿æŒæŒä¹…è¿æ¥
- **è‡ªåŠ¨æ¸…ç†ï¼š** å¯¹äºä¸æä¾›ä»»ä½•å·¥å…·çš„æœåŠ¡å™¨ï¼Œå…¶è¿æ¥ä¼šè¢«è‡ªåŠ¨å…³é—­
- **è¶…æ—¶ç®¡ç†ï¼š** æ ¹æ®æœåŠ¡å™¨å“åº”ç‰¹æ€§é…ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
- **èµ„æºç›‘æ§ï¼š** MCP æœåŠ¡å™¨ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼Œä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æº

### Schema å…¼å®¹æ€§

- **å±æ€§å‰¥ç¦»ï¼š** ä¸ºå…¼å®¹ Gemini APIï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç§»é™¤æŸäº› schema å±æ€§ï¼ˆå¦‚ `$schema`ã€`additionalProperties`ï¼‰
- **åç§°æ¸…ç†ï¼š** å·¥å…·åç§°ä¼šè‡ªåŠ¨æ¸…ç†ä»¥æ»¡è¶³ API è¦æ±‚
- **å†²çªè§£å†³ï¼š** é€šè¿‡è‡ªåŠ¨æ·»åŠ å‰ç¼€æ¥è§£å†³ä¸åŒæœåŠ¡å™¨ä¹‹é—´çš„å·¥å…·åç§°å†²çª

è¿™ç§å…¨é¢çš„é›†æˆä½¿ MCP æœåŠ¡å™¨æˆä¸ºæ‰©å±• CLI åŠŸèƒ½çš„å¼ºå¤§æ–¹å¼ï¼ŒåŒæ—¶ä¿è¯äº†å®‰å…¨æ€§ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## ä» Tools è¿”å›å¯Œå†…å®¹

MCP tools ä¸ä»…é™äºè¿”å›ç®€å•çš„æ–‡æœ¬ã€‚ä½ å¯ä»¥è¿”å›ä¸°å¯Œçš„å¤šéƒ¨åˆ†çš„å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘å’Œå…¶ä»–äºŒè¿›åˆ¶æ•°æ®ï¼Œæ‰€æœ‰è¿™äº›éƒ½å¯ä»¥åœ¨å•ä¸ª tool response ä¸­å®Œæˆã€‚è¿™ä½¿ä½ èƒ½å¤Ÿæ„å»ºå¼ºå¤§çš„ toolsï¼Œå¯ä»¥åœ¨ä¸€æ¬¡äº¤äº’ä¸­å‘æ¨¡å‹æä¾›å¤šæ ·åŒ–çš„ä¿¡æ¯ã€‚

æ‰€æœ‰ä» tool è¿”å›çš„æ•°æ®éƒ½ä¼šè¢«å¤„ç†å¹¶ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ç»™æ¨¡å‹ï¼Œç”¨äºä¸‹ä¸€æ¬¡ç”Ÿæˆï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿå¯¹æä¾›çš„ä¿¡æ¯è¿›è¡Œæ¨ç†æˆ–æ€»ç»“ã€‚

### å·¥ä½œåŸç†

è¦è¿”å›å¯Œå†…å®¹ï¼Œä½ çš„ tool çš„å“åº”å¿…é¡»éµå¾ª MCP è§„èŒƒä¸­çš„ [`CallToolResult`](https://modelcontextprotocol.io/specification/2025-06-18/server/tools#tool-result) ç»“æ„ã€‚ç»“æœçš„ `content` å­—æ®µåº”è¯¥æ˜¯ä¸€ä¸ª `ContentBlock` å¯¹è±¡æ•°ç»„ã€‚CLI ä¼šæ­£ç¡®å¤„ç†è¿™ä¸ªæ•°ç»„ï¼Œå°†æ–‡æœ¬ä¸äºŒè¿›åˆ¶æ•°æ®åˆ†ç¦»ï¼Œå¹¶æ‰“åŒ…ä¼ é€’ç»™æ¨¡å‹ã€‚

ä½ å¯ä»¥åœ¨ `content` æ•°ç»„ä¸­æ··åˆä½¿ç”¨ä¸åŒç±»å‹çš„ content blockã€‚æ”¯æŒçš„ block ç±»å‹åŒ…æ‹¬ï¼š

- `text`
- `image`
- `audio`
- `resource`ï¼ˆåµŒå…¥å†…å®¹ï¼‰
- `resource_link`

### ç¤ºä¾‹ï¼šè¿”å›æ–‡æœ¬å’Œå›¾åƒ

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ MCP å·¥å…· JSON å“åº”ç¤ºä¾‹ï¼Œè¯¥å“åº”åŒæ—¶è¿”å›æ–‡æœ¬æè¿°å’Œå›¾åƒï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "Here is the logo you requested."
    },
    {
      "type": "image",
      "data": "BASE64_ENCODED_IMAGE_DATA_HERE",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "The logo was created in 2025."
    }
  ]
}
```

å½“ Qwen Code æ¥æ”¶åˆ°æ­¤å“åº”æ—¶ï¼Œå®ƒå°†ï¼š

1.  æå–æ‰€æœ‰æ–‡æœ¬å¹¶å°†å…¶åˆå¹¶ä¸ºå•ä¸ª `functionResponse` éƒ¨åˆ†ï¼Œä¾›æ¨¡å‹ä½¿ç”¨ã€‚
2.  å°†å›¾åƒæ•°æ®ä½œä¸ºå•ç‹¬çš„ `inlineData` éƒ¨åˆ†å‘ˆç°ã€‚
3.  åœ¨ CLI ä¸­æä¾›ç®€æ´ã€ç”¨æˆ·å‹å¥½çš„æ‘˜è¦ï¼Œè¡¨æ˜å·²æ¥æ”¶åˆ°æ–‡æœ¬å’Œå›¾åƒã€‚

è¿™ä½¿ä½ èƒ½å¤Ÿæ„å»ºå¤æ‚çš„å·¥å…·ï¼Œä¸º Gemini æ¨¡å‹æä¾›ä¸°å¯Œçš„å¤šæ¨¡æ€ä¸Šä¸‹æ–‡ã€‚

## MCP Prompts ä½œä¸º Slash Commands

é™¤äº† tools ä¹‹å¤–ï¼ŒMCP servers è¿˜å¯ä»¥æš´éœ²é¢„å®šä¹‰çš„ promptsï¼Œè¿™äº› prompts å¯ä»¥ä½œä¸º slash commands åœ¨ Qwen Code ä¸­æ‰§è¡Œã€‚è¿™å…è®¸ä½ ä¸ºå¸¸è§æˆ–å¤æ‚çš„æŸ¥è¯¢åˆ›å»ºå¿«æ·æ–¹å¼ï¼Œé€šè¿‡åç§°å³å¯è½»æ¾è°ƒç”¨ã€‚

### åœ¨æœåŠ¡å™¨ç«¯å®šä¹‰ Prompts

ä¸‹é¢æ˜¯ä¸€ä¸ªå®šä¹‰äº† prompts çš„ stdio MCP æœåŠ¡å™¨çš„å°ä¾‹å­ï¼š

```ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

const server = new McpServer({
  name: 'prompt-server',
  version: '1.0.0',
});

server.registerPrompt(
  'poem-writer',
  {
    title: 'Poem Writer',
    description: 'Write a nice haiku',
    argsSchema: { title: z.string(), mood: z.string().optional() },
  },
  ({ title, mood }) => ({
    messages: [
      {
        role: 'user',
        content: {
          type: 'text',
          text: `Write a haiku${mood ? ` with the mood ${mood}` : ''} called ${title}. Note that a haiku is 5 syllables followed by 7 syllables followed by 5 syllables `,
        },
      },
    ],
  }),
);

const transport = new StdioServerTransport();
await server.connect(transport);
```

è¿™æ®µä»£ç å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ·»åŠ åˆ° `settings.json` çš„ `mcpServers` é…ç½®é¡¹ä¸­ï¼š

```json
"nodeServer": {
  "command": "node",
  "args": ["filename.ts"],
}
```

### è°ƒç”¨ Prompts

ä¸€æ—¦å‘ç°æŸä¸ª promptï¼Œä½ å¯ä»¥é€šè¿‡å…¶åç§°ä½œä¸ºæ–œæ å‘½ä»¤æ¥è°ƒç”¨å®ƒã€‚CLI ä¼šè‡ªåŠ¨å¤„ç†å‚æ•°è§£æã€‚

```bash
/poem-writer --title="Qwen Code" --mood="reverent"
```

æˆ–è€…ï¼Œä½¿ç”¨ä½ç½®å‚æ•°ï¼š

```bash
/poem-writer "Qwen Code" reverent
```

å½“ä½ è¿è¡Œè¿™ä¸ªå‘½ä»¤æ—¶ï¼ŒCLI ä¼šåœ¨ MCP æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `prompts/get` æ–¹æ³•ï¼Œå¹¶ä¼ å…¥æä¾›çš„å‚æ•°ã€‚æœåŠ¡å™¨è´Ÿè´£å°†å‚æ•°æ›¿æ¢åˆ° prompt æ¨¡æ¿ä¸­å¹¶è¿”å›æœ€ç»ˆçš„ prompt æ–‡æœ¬ã€‚ç„¶å CLI ä¼šå°†è¿™ä¸ª prompt å‘é€ç»™æ¨¡å‹æ‰§è¡Œã€‚è¿™ä¸ºè‡ªåŠ¨åŒ–å’Œå…±äº«å¸¸è§å·¥ä½œæµæä¾›äº†ä¸€ç§ä¾¿æ·çš„æ–¹å¼ã€‚

## ä½¿ç”¨ `qwen mcp` ç®¡ç† MCP æœåŠ¡å™¨

è™½ç„¶ä½ å¯ä»¥é€šè¿‡æ‰‹åŠ¨ç¼–è¾‘ `settings.json` æ–‡ä»¶æ¥é…ç½® MCP æœåŠ¡å™¨ï¼Œä½† CLI æä¾›äº†ä¸€å¥—ä¾¿æ·çš„å‘½ä»¤ï¼Œå¯ä»¥è®©ä½ ä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†æœåŠ¡å™¨é…ç½®ã€‚è¿™äº›å‘½ä»¤ç®€åŒ–äº†æ·»åŠ ã€åˆ—å‡ºå’Œåˆ é™¤ MCP æœåŠ¡å™¨çš„è¿‡ç¨‹ï¼Œæ— éœ€ç›´æ¥ç¼–è¾‘ JSON æ–‡ä»¶ã€‚

### æ·»åŠ æœåŠ¡å™¨ (`qwen mcp add`)

`add` å‘½ä»¤ç”¨äºåœ¨ä½ çš„ `settings.json` ä¸­é…ç½®ä¸€ä¸ªæ–°çš„ MCP æœåŠ¡å™¨ã€‚æ ¹æ®ä½œç”¨åŸŸ (`-s, --scope`)ï¼Œè¯¥é…ç½®å°†è¢«æ·»åŠ åˆ°ç”¨æˆ·é…ç½®æ–‡ä»¶ `~/.qwen/settings.json` æˆ–é¡¹ç›®é…ç½®æ–‡ä»¶ `.qwen/settings.json` ä¸­ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp add [options] <name> <commandOrUrl> [args...]
```

- `<name>`: æœåŠ¡å™¨çš„å”¯ä¸€åç§°ã€‚
- `<commandOrUrl>`: è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆç”¨äº `stdio`ï¼‰æˆ– URLï¼ˆç”¨äº `http`/`sse`ï¼‰ã€‚
- `[args...]`: å¯é€‰å‚æ•°ï¼Œç”¨äº `stdio` å‘½ä»¤ã€‚

**é€‰é¡¹ï¼ˆFlagsï¼‰ï¼š**

- `-s, --scope`: é…ç½®ä½œç”¨åŸŸï¼ˆuser æˆ– projectï¼‰ã€‚[é»˜è®¤: "project"]
- `-t, --transport`: ä¼ è¾“ç±»å‹ï¼ˆstdio, sse, httpï¼‰ã€‚[é»˜è®¤: "stdio"]
- `-e, --env`: è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ -e KEY=valueï¼‰ã€‚
- `-H, --header`: ä¸º SSE å’Œ HTTP ä¼ è¾“è®¾ç½® HTTP headersï¼ˆä¾‹å¦‚ -H "X-Api-Key: abc123" -H "Authorization: Bearer abc123"ï¼‰ã€‚
- `--timeout`: è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚
- `--trust`: ä¿¡ä»»è¯¥æœåŠ¡å™¨ï¼ˆè·³è¿‡æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤æç¤ºï¼‰ã€‚
- `--description`: è®¾ç½®æœåŠ¡å™¨çš„æè¿°ä¿¡æ¯ã€‚
- `--include-tools`: åŒ…å«çš„å·¥å…·åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚
- `--exclude-tools`: æ’é™¤çš„å·¥å…·åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”ã€‚

#### æ·»åŠ  stdio server

è¿™æ˜¯è¿è¡Œæœ¬åœ° server çš„é»˜è®¤ä¼ è¾“æ–¹å¼ã€‚

```bash

# åŸºæœ¬è¯­æ³•
qwen mcp add <name> <command> [args...]

# ç¤ºä¾‹ï¼šæ·»åŠ æœ¬åœ° server
qwen mcp add my-stdio-server -e API_KEY=123 /path/to/server arg1 arg2 arg3

# ç¤ºä¾‹ï¼šæ·»åŠ æœ¬åœ° python server
qwen mcp add python-server python server.py --port 8080
```

#### æ·»åŠ  HTTP server

æ­¤ä¼ è¾“æ–¹å¼é€‚ç”¨äºä½¿ç”¨å¯æµå¼ HTTP ä¼ è¾“çš„ serverã€‚

```bash

# åŸºæœ¬è¯­æ³•
qwen mcp add --transport http <name> <url>

# ç¤ºä¾‹ï¼šæ·»åŠ  HTTP server
qwen mcp add --transport http http-server https://api.example.com/mcp/

# ç¤ºä¾‹ï¼šæ·»åŠ å¸¦è®¤è¯ header çš„ HTTP server
qwen mcp add --transport http secure-http https://api.example.com/mcp/ --header "Authorization: Bearer abc123"
```

#### æ·»åŠ  SSE server

æ­¤ä¼ è¾“æ–¹å¼é€‚ç”¨äºä½¿ç”¨ Server-Sent Events (SSE) çš„ serverã€‚

```bash

# åŸºæœ¬è¯­æ³•
qwen mcp add --transport sse <name> <url>
```

# ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ª SSE æœåŠ¡å™¨
```bash
qwen mcp add --transport sse sse-server https://api.example.com/sse/
```

# ç¤ºä¾‹ï¼šæ·»åŠ ä¸€ä¸ªå¸¦è®¤è¯ header çš„ SSE æœåŠ¡å™¨
```bash
qwen mcp add --transport sse secure-sse https://api.example.com/sse/ --header "Authorization: Bearer abc123"
```

### åˆ—å‡ºæœåŠ¡å™¨ (`qwen mcp list`)

è¦æŸ¥çœ‹å½“å‰é…ç½®çš„æ‰€æœ‰ MCP æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ `list` å‘½ä»¤ã€‚è¯¥å‘½ä»¤ä¼šæ˜¾ç¤ºæ¯ä¸ªæœåŠ¡å™¨çš„åç§°ã€é…ç½®è¯¦æƒ…ä»¥åŠè¿æ¥çŠ¶æ€ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp list
```

**ç¤ºä¾‹è¾“å‡ºï¼š**

```sh
âœ“ stdio-server: command: python3 server.py (stdio) - Connected
âœ“ http-server: https://api.example.com/mcp (http) - Connected
âœ— sse-server: https://api.example.com/sse (sse) - Disconnected
```

### åˆ é™¤æœåŠ¡å™¨ (`qwen mcp remove`)

è¦ä»é…ç½®ä¸­åˆ é™¤ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `remove` å‘½ä»¤å¹¶æŒ‡å®šæœåŠ¡å™¨åç§°ã€‚

**å‘½ä»¤ï¼š**

```bash
qwen mcp remove <name>
```

**ç¤ºä¾‹ï¼š**

```bash
qwen mcp remove my-server
```

è¯¥å‘½ä»¤ä¼šæ ¹æ®ä½œç”¨åŸŸ (`-s, --scope`) åœ¨ç›¸åº”çš„ `settings.json` æ–‡ä»¶ä¸­æ‰¾åˆ°å¹¶åˆ é™¤ `mcpServers` å¯¹è±¡é‡Œçš„ "my-server" æ¡ç›®ã€‚